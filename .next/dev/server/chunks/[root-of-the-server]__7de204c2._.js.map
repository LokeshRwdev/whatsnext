{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/api-respond.ts"],"sourcesContent":["export type ApiErrorPayload = {\n  error: {\n    code: string;\n    message: string;\n    details?: unknown;\n  };\n};\n\nexport class HttpError extends Error {\n  code: string;\n  status: number;\n  details?: unknown;\n\n  constructor(status: number, code: string, message: string, details?: unknown) {\n    super(message);\n    this.status = status;\n    this.code = code;\n    this.details = details;\n  }\n}\n\nexport function ok<T>(data: T, status: number = 200) {\n  return Response.json(data, { status });\n}\n\nexport function bad(\n  message: string,\n  details?: unknown,\n  status: number = 400,\n  code?: string\n) {\n  const resolvedCode =\n    code ?? (status >= 500 ? \"INTERNAL_ERROR\" : \"BAD_REQUEST\");\n\n  return Response.json<ApiErrorPayload>(\n    {\n      error: {\n        code: resolvedCode,\n        message,\n        details,\n      },\n    },\n    { status }\n  );\n}\n\nexport function handleRouteError(err: unknown) {\n  if (err instanceof HttpError) {\n    return bad(err.message, err.details, err.status, err.code);\n  }\n\n  if (err instanceof Error) {\n    return bad(err.message, null, 500, \"INTERNAL_ERROR\");\n  }\n\n  return bad(\"Internal error\", null, 500, \"INTERNAL_ERROR\");\n}\n"],"names":[],"mappings":";;;;;;;;;;AAQO,MAAM,kBAAkB;IAC7B,KAAa;IACb,OAAe;IACf,QAAkB;IAElB,YAAY,MAAc,EAAE,IAAY,EAAE,OAAe,EAAE,OAAiB,CAAE;QAC5E,KAAK,CAAC;QACN,IAAI,CAAC,MAAM,GAAG;QACd,IAAI,CAAC,IAAI,GAAG;QACZ,IAAI,CAAC,OAAO,GAAG;IACjB;AACF;AAEO,SAAS,GAAM,IAAO,EAAE,SAAiB,GAAG;IACjD,OAAO,SAAS,IAAI,CAAC,MAAM;QAAE;IAAO;AACtC;AAEO,SAAS,IACd,OAAe,EACf,OAAiB,EACjB,SAAiB,GAAG,EACpB,IAAa;IAEb,MAAM,eACJ,QAAQ,CAAC,UAAU,MAAM,mBAAmB,aAAa;IAE3D,OAAO,SAAS,IAAI,CAClB;QACE,OAAO;YACL,MAAM;YACN;YACA;QACF;IACF,GACA;QAAE;IAAO;AAEb;AAEO,SAAS,iBAAiB,GAAY;IAC3C,IAAI,eAAe,WAAW;QAC5B,OAAO,IAAI,IAAI,OAAO,EAAE,IAAI,OAAO,EAAE,IAAI,MAAM,EAAE,IAAI,IAAI;IAC3D;IAEA,IAAI,eAAe,OAAO;QACxB,OAAO,IAAI,IAAI,OAAO,EAAE,MAAM,KAAK;IACrC;IAEA,OAAO,IAAI,kBAAkB,MAAM,KAAK;AAC1C","debugId":null}},
    {"offset": {"line": 91, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/auth-guard.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\nimport type { SupabaseClient, User } from \"@supabase/supabase-js\";\nimport { HttpError } from \"./api-respond\";\n\nfunction getCookieValue(cookieHeader: string | null, name: string) {\n  if (!cookieHeader) return null;\n  const parts = cookieHeader.split(\";\");\n  const prefix = `${name}=`;\n\n  for (const part of parts) {\n    const trimmed = part.trim();\n    if (trimmed.startsWith(prefix)) {\n      return decodeURIComponent(trimmed.substring(prefix.length));\n    }\n  }\n  return null;\n}\n\nfunction extractAccessToken(req: Request): string | null {\n  const authHeader = req.headers.get(\"authorization\");\n  if (authHeader?.startsWith(\"Bearer \")) {\n    return authHeader.substring(7).trim();\n  }\n\n  const cookieHeader = req.headers.get(\"cookie\");\n  const cookieToken =\n    getCookieValue(cookieHeader, \"sb-access-token\") ??\n    getCookieValue(cookieHeader, \"sb:token\");\n\n  return cookieToken ?? null;\n}\n\nexport async function getSupabaseFromRequest(req: Request): Promise<{\n  supabase: SupabaseClient;\n  user: User;\n}> {\n  const url = process.env.NEXT_PUBLIC_SUPABASE_URL!;\n  const key = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\n  const accessToken = extractAccessToken(req);\n\n  const headers: Record<string, string> = {};\n  if (accessToken) {\n    headers[\"Authorization\"] = `Bearer ${accessToken}`;\n  }\n\n  const supabase = createClient(url, key, {\n    auth: { persistSession: false, detectSessionInUrl: false },\n    global: {\n      headers,\n    },\n  });\n\n  const {\n    data: { user },\n    error,\n  } = await supabase.auth.getUser(accessToken ?? undefined);\n\n  if (error) {\n    throw new HttpError(401, \"UNAUTHORIZED\", \"Not authenticated\", error);\n  }\n\n  if (!user) {\n    throw new HttpError(401, \"UNAUTHORIZED\", \"Not authenticated\");\n  }\n\n  return { supabase, user };\n}\n\nexport async function requireUser(req: Request): Promise<{\n  supabase: SupabaseClient;\n  user: User;\n}> {\n  const { supabase, user } = await getSupabaseFromRequest(req);\n  if (!user) {\n    throw new HttpError(401, \"UNAUTHORIZED\", \"Not authenticated\");\n  }\n  return { supabase, user };\n}\n\nexport async function requireAdmin(req: Request): Promise<{\n  supabase: SupabaseClient;\n  user: User;\n}> {\n  const { supabase, user } = await requireUser(req);\n\n  const { data: profile, error } = await supabase\n    .from(\"profiles\")\n    .select(\"is_admin\")\n    .eq(\"id\", user.id)\n    .single();\n\n  if (error || !profile?.is_admin) {\n    throw new HttpError(403, \"FORBIDDEN\", \"Admin access required\", error);\n  }\n\n  return { supabase, user };\n}\n"],"names":[],"mappings":";;;;;;;;AAAA;AAEA;;;AAEA,SAAS,eAAe,YAA2B,EAAE,IAAY;IAC/D,IAAI,CAAC,cAAc,OAAO;IAC1B,MAAM,QAAQ,aAAa,KAAK,CAAC;IACjC,MAAM,SAAS,GAAG,KAAK,CAAC,CAAC;IAEzB,KAAK,MAAM,QAAQ,MAAO;QACxB,MAAM,UAAU,KAAK,IAAI;QACzB,IAAI,QAAQ,UAAU,CAAC,SAAS;YAC9B,OAAO,mBAAmB,QAAQ,SAAS,CAAC,OAAO,MAAM;QAC3D;IACF;IACA,OAAO;AACT;AAEA,SAAS,mBAAmB,GAAY;IACtC,MAAM,aAAa,IAAI,OAAO,CAAC,GAAG,CAAC;IACnC,IAAI,YAAY,WAAW,YAAY;QACrC,OAAO,WAAW,SAAS,CAAC,GAAG,IAAI;IACrC;IAEA,MAAM,eAAe,IAAI,OAAO,CAAC,GAAG,CAAC;IACrC,MAAM,cACJ,eAAe,cAAc,sBAC7B,eAAe,cAAc;IAE/B,OAAO,eAAe;AACxB;AAEO,eAAe,uBAAuB,GAAY;IAIvD,MAAM;IACN,MAAM;IACN,MAAM,cAAc,mBAAmB;IAEvC,MAAM,UAAkC,CAAC;IACzC,IAAI,aAAa;QACf,OAAO,CAAC,gBAAgB,GAAG,CAAC,OAAO,EAAE,aAAa;IACpD;IAEA,MAAM,WAAW,IAAA,yMAAY,EAAC,KAAK,KAAK;QACtC,MAAM;YAAE,gBAAgB;YAAO,oBAAoB;QAAM;QACzD,QAAQ;YACN;QACF;IACF;IAEA,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACN,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO,CAAC,eAAe;IAE/C,IAAI,OAAO;QACT,MAAM,IAAI,oIAAS,CAAC,KAAK,gBAAgB,qBAAqB;IAChE;IAEA,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,oIAAS,CAAC,KAAK,gBAAgB;IAC3C;IAEA,OAAO;QAAE;QAAU;IAAK;AAC1B;AAEO,eAAe,YAAY,GAAY;IAI5C,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,uBAAuB;IACxD,IAAI,CAAC,MAAM;QACT,MAAM,IAAI,oIAAS,CAAC,KAAK,gBAAgB;IAC3C;IACA,OAAO;QAAE;QAAU;IAAK;AAC1B;AAEO,eAAe,aAAa,GAAY;IAI7C,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,YAAY;IAE7C,MAAM,EAAE,MAAM,OAAO,EAAE,KAAK,EAAE,GAAG,MAAM,SACpC,IAAI,CAAC,YACL,MAAM,CAAC,YACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,MAAM;IAET,IAAI,SAAS,CAAC,SAAS,UAAU;QAC/B,MAAM,IAAI,oIAAS,CAAC,KAAK,aAAa,yBAAyB;IACjE;IAEA,OAAO;QAAE;QAAU;IAAK;AAC1B","debugId":null}},
    {"offset": {"line": 178, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/app/api/driver-state/route.ts"],"sourcesContent":["import { requireUser } from \"@/lib/auth-guard\";\nimport { ok, bad } from \"@/lib/api-respond\";\n\nexport async function GET(req: Request) {\n  try {\n    const { supabase, user } = await requireUser(req);\n\n    const { data, error } = await supabase\n      .from(\"driver_state\")\n      .select(\n        \"driver_id,last_ping_at,lat,lon,snapped_zone_id,speed_kmh,battery_pct,recommendation,updated_at\"\n      )\n      .eq(\"driver_id\", user.id)\n      .maybeSingle();\n\n    if (error && error.code !== \"PGRST116\") {\n      console.error(\"[driver-state] fetch failed\", {\n        driverId: user.id,\n        error,\n      });\n      return bad(\"Failed to fetch driver state\", null, 500, \"DB_ERROR\");\n    }\n\n    if (!data) {\n      return new Response(null, { status: 204 });\n    }\n\n    return ok({\n      driver_id: data.driver_id,\n      last_ping_at: data.last_ping_at,\n      snapped_zone: data.snapped_zone_id,\n      snapped_zone_id: data.snapped_zone_id,\n      lat: data.lat,\n      lon: data.lon,\n      speed_kmh: data.speed_kmh,\n      battery_pct: data.battery_pct,\n      recommendation: data.recommendation,\n      updated_at: data.updated_at,\n    });\n  } catch (error: any) {\n    if (error.message === \"Unauthorized\") {\n      return bad(\"Unauthorized\", null, 401, \"UNAUTHORIZED\");\n    }\n    console.error(\"[driver-state] unexpected error\", error);\n    return bad(\"Unexpected error\", null, 500, \"INTERNAL_ERROR\");\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAEO,eAAe,IAAI,GAAY;IACpC,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,qIAAW,EAAC;QAE7C,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,gBACL,MAAM,CACL,kGAED,EAAE,CAAC,aAAa,KAAK,EAAE,EACvB,WAAW;QAEd,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;YACtC,QAAQ,KAAK,CAAC,+BAA+B;gBAC3C,UAAU,KAAK,EAAE;gBACjB;YACF;YACA,OAAO,IAAA,8HAAG,EAAC,gCAAgC,MAAM,KAAK;QACxD;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,IAAI,SAAS,MAAM;gBAAE,QAAQ;YAAI;QAC1C;QAEA,OAAO,IAAA,6HAAE,EAAC;YACR,WAAW,KAAK,SAAS;YACzB,cAAc,KAAK,YAAY;YAC/B,cAAc,KAAK,eAAe;YAClC,iBAAiB,KAAK,eAAe;YACrC,KAAK,KAAK,GAAG;YACb,KAAK,KAAK,GAAG;YACb,WAAW,KAAK,SAAS;YACzB,aAAa,KAAK,WAAW;YAC7B,gBAAgB,KAAK,cAAc;YACnC,YAAY,KAAK,UAAU;QAC7B;IACF,EAAE,OAAO,OAAY;QACnB,IAAI,MAAM,OAAO,KAAK,gBAAgB;YACpC,OAAO,IAAA,8HAAG,EAAC,gBAAgB,MAAM,KAAK;QACxC;QACA,QAAQ,KAAK,CAAC,mCAAmC;QACjD,OAAO,IAAA,8HAAG,EAAC,oBAAoB,MAAM,KAAK;IAC5C;AACF","debugId":null}}]
}