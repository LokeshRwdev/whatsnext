{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/components/layout/DriverShell.tsx"],"sourcesContent":["import { ReactNode } from \"react\";\nimport { cn } from \"@/lib/utils\";\n\ninterface DriverShellProps {\n  title?: string;\n  subtitle?: string;\n  actions?: ReactNode;\n  children: ReactNode;\n  className?: string;\n}\n\nexport function DriverShell({ title, subtitle, actions, children, className }: DriverShellProps) {\n  return (\n    <section className={cn(\"flex h-full flex-col\", className)}>\n      {(title || subtitle || actions) && (\n        <header className=\"flex flex-col gap-2 border-b px-4 py-4 text-left\">\n          <div className=\"flex items-start justify-between gap-3\">\n            <div>\n              {title && <h1 className=\"text-2xl font-semibold leading-tight\">{title}</h1>}\n              {subtitle && <p className=\"text-sm text-muted-foreground\">{subtitle}</p>}\n            </div>\n            {actions && <div className=\"shrink-0\">{actions}</div>}\n          </div>\n        </header>\n      )}\n      <div className=\"flex-1 overflow-y-auto px-4 pb-24 pt-4 md:pb-8\">{children}</div>\n    </section>\n  );\n}\r\n"],"names":[],"mappings":";;;;;AACA;;;AAUO,SAAS,YAAY,EAAE,KAAK,EAAE,QAAQ,EAAE,OAAO,EAAE,QAAQ,EAAE,SAAS,EAAoB;IAC7F,qBACE,8OAAC;QAAQ,WAAW,IAAA,kHAAE,EAAC,wBAAwB;;YAC5C,CAAC,SAAS,YAAY,OAAO,mBAC5B,8OAAC;gBAAO,WAAU;0BAChB,cAAA,8OAAC;oBAAI,WAAU;;sCACb,8OAAC;;gCACE,uBAAS,8OAAC;oCAAG,WAAU;8CAAwC;;;;;;gCAC/D,0BAAY,8OAAC;oCAAE,WAAU;8CAAiC;;;;;;;;;;;;wBAE5D,yBAAW,8OAAC;4BAAI,WAAU;sCAAY;;;;;;;;;;;;;;;;;0BAI7C,8OAAC;gBAAI,WAAU;0BAAkD;;;;;;;;;;;;AAGvE","debugId":null}},
    {"offset": {"line": 83, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/api-client.ts"],"sourcesContent":["export type ApiError = {\n  code: string;\n  message: string;\n  details?: unknown;\n};\n\nasync function parseJson<T>(res: Response): Promise<T | null> {\n  if (res.status === 204) return null;\n  const contentType = res.headers.get(\"content-type\");\n  if (contentType && contentType.includes(\"application/json\")) {\n    return (await res.json()) as T;\n  }\n  return null;\n}\n\nasync function handleResponse<T>(\n  res: Response\n): Promise<{ data: T | null; error: ApiError | null }> {\n  if (res.ok) {\n    const data = await parseJson<T>(res);\n    return { data, error: null };\n  }\n\n  const payload =\n    (await parseJson<{ error?: { code: string; message: string; details?: unknown } }>(\n      res\n    )) || undefined;\n\n  const error: ApiError = {\n    code: payload?.error?.code || `HTTP_${res.status}`,\n    message: payload?.error?.message || res.statusText,\n    details: payload?.error?.details,\n  };\n  return { data: null, error };\n}\n\nexport async function apiGet<T>(url: string) {\n  const res = await fetch(url, {\n    cache: \"no-store\",\n    credentials: \"include\",\n  });\n  return handleResponse<T>(res);\n}\n\nexport async function apiPost<T, B = unknown>(url: string, body: B) {\n  const res = await fetch(url, {\n    method: \"POST\",\n    headers: { \"content-type\": \"application/json\" },\n    body: JSON.stringify(body),\n    credentials: \"include\",\n  });\n  return handleResponse<T>(res);\n}\n\nexport type RecommendationZone = {\n  zone_id: string | number;\n  zone_name: string;\n  lat: number;\n  lon: number;\n  distance_km: number;\n  eta_min: number;\n  score: number;\n  reason: string;\n  success_prob?: number;\n  expected_fare_inr?: number;\n  normalized_fare?: number;\n  traffic_penalty?: number;\n  traffic_speed_idx?: number | null;\n};\n\nexport type RecommendationResponse = {\n  computed_at: string;\n  source?: string;\n  traffic_source?: \"google\" | \"cache\" | \"fallback\" | null;\n  context?: Record<string, unknown> | null;\n  top: RecommendationZone[];\n};\n\nexport type GeoPoint = {\n  type: \"Point\";\n  coordinates: [number, number];\n  crs?: { type: string; properties: Record<string, any> };\n};\n\nexport type DriverState = {\n  driver_id: string;\n  last_ping_at: string | null;\n  loc: GeoPoint | null;\n  lat: number | null;\n  lon: number | null;\n  snapped_zone: number | null;\n  speed_kmh: number | null;\n  battery_pct: number | null;\n  last_ping_accuracy_m: number | null;\n  recommendation: RecommendationResponse | null;\n  updated_at: string | null;\n  coords?: { lat: number; lon: number } | null;\n};\n\nexport type DriverStateResponse = {\n  data: DriverState | null;\n  status?: string;\n  message?: string;\n} | null;\n\nexport type PingPayload = {\n  lat: number;\n  lon: number;\n  ts?: string;\n  accuracy_m?: number | null;\n  speed_kmh?: number | null;\n  battery_pct?: number | null;\n  traffic_context?: Record<string, unknown>;\n};\n\nexport async function postPing(payload: PingPayload) {\n  return apiPost<{ zone_id: number | null; recommendation: RecommendationResponse | null }>(\n    \"/api/pings\",\n    payload\n  );\n}\n\nexport async function fetchDriverState() {\n  return apiGet<DriverStateResponse>(\"/api/driver-state\");\n}\n\nexport async function fetchRecommendations(params?: {\n  lat?: number;\n  lon?: number;\n  k?: number;\n}) {\n  const qs = new URLSearchParams();\n  if (params?.lat !== undefined) qs.set(\"lat\", String(params.lat));\n  if (params?.lon !== undefined) qs.set(\"lon\", String(params.lon));\n  if (params?.k !== undefined) qs.set(\"k\", String(params.k));\n  const suffix = qs.toString();\n  return apiGet<RecommendationResponse>(\n    `/api/recommendations/next-spot${suffix ? `?${suffix}` : \"\"}`\n  );\n}\n\nexport type RideEventPayload = {\n  event_type: \"booking_received\" | \"ride_started\" | \"ride_completed\" | \"booking_cancelled\";\n  platform: \"ola\" | \"uber\";\n  pickup_lat?: number;\n  pickup_lon?: number;\n  drop_lat?: number;\n  drop_lon?: number;\n  surge_multiplier?: number;\n  promo_code?: string;\n};\n\nexport async function postRideEvent(payload: RideEventPayload) {\n  return apiPost<{ ok: boolean; event_id: number | null }>(\"/api/ride-events/ingest\", {\n    occurred_at: new Date().toISOString(),\n    ...payload,\n  });\n}\n\nexport type OpsDailyInput = {\n  day?: string;\n  platforms?: (\"ola\" | \"uber\")[];\n  idle_minutes?: number;\n  energy_kwh?: number;\n  energy_cost_inr?: number;\n  fuel_litres?: number;\n  fuel_cost_inr?: number;\n  tolls_parking_inr?: number;\n  notes?: string;\n};\n\nexport async function upsertOpsDaily(payload: OpsDailyInput) {\n  return apiPost<{\n    driver_id: string;\n    day: string;\n    idle_minutes: number | null;\n    energy_kwh: number | null;\n    energy_cost_inr: number | null;\n    tolls_parking_inr: number | null;\n    notes: string | null;\n  }>(\"/api/ops-daily/upsert\", payload);\n}\n\nexport type TripSyncPayload = {\n  booking_at?: string;\n  pickup_at: string;\n  drop_at: string;\n  pickup_lat: number;\n  pickup_lon: number;\n  drop_lat: number;\n  drop_lon: number;\n  distance_km: number;\n  fare_inr: number;\n  platform: \"ola\" | \"uber\";\n  surge_multiplier?: number;\n  promo_code?: string;\n  tip_inr?: number;\n};\n\nexport async function postTripSync(payload: TripSyncPayload) {\n  return apiPost<{ trip_id: number | null }>(\"/api/trips/sync\", payload);\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;AAMA,eAAe,UAAa,GAAa;IACvC,IAAI,IAAI,MAAM,KAAK,KAAK,OAAO;IAC/B,MAAM,cAAc,IAAI,OAAO,CAAC,GAAG,CAAC;IACpC,IAAI,eAAe,YAAY,QAAQ,CAAC,qBAAqB;QAC3D,OAAQ,MAAM,IAAI,IAAI;IACxB;IACA,OAAO;AACT;AAEA,eAAe,eACb,GAAa;IAEb,IAAI,IAAI,EAAE,EAAE;QACV,MAAM,OAAO,MAAM,UAAa;QAChC,OAAO;YAAE;YAAM,OAAO;QAAK;IAC7B;IAEA,MAAM,UACJ,AAAC,MAAM,UACL,QACI;IAER,MAAM,QAAkB;QACtB,MAAM,SAAS,OAAO,QAAQ,CAAC,KAAK,EAAE,IAAI,MAAM,EAAE;QAClD,SAAS,SAAS,OAAO,WAAW,IAAI,UAAU;QAClD,SAAS,SAAS,OAAO;IAC3B;IACA,OAAO;QAAE,MAAM;QAAM;IAAM;AAC7B;AAEO,eAAe,OAAU,GAAW;IACzC,MAAM,MAAM,MAAM,MAAM,KAAK;QAC3B,OAAO;QACP,aAAa;IACf;IACA,OAAO,eAAkB;AAC3B;AAEO,eAAe,QAAwB,GAAW,EAAE,IAAO;IAChE,MAAM,MAAM,MAAM,MAAM,KAAK;QAC3B,QAAQ;QACR,SAAS;YAAE,gBAAgB;QAAmB;QAC9C,MAAM,KAAK,SAAS,CAAC;QACrB,aAAa;IACf;IACA,OAAO,eAAkB;AAC3B;AA+DO,eAAe,SAAS,OAAoB;IACjD,OAAO,QACL,cACA;AAEJ;AAEO,eAAe;IACpB,OAAO,OAA4B;AACrC;AAEO,eAAe,qBAAqB,MAI1C;IACC,MAAM,KAAK,IAAI;IACf,IAAI,QAAQ,QAAQ,WAAW,GAAG,GAAG,CAAC,OAAO,OAAO,OAAO,GAAG;IAC9D,IAAI,QAAQ,QAAQ,WAAW,GAAG,GAAG,CAAC,OAAO,OAAO,OAAO,GAAG;IAC9D,IAAI,QAAQ,MAAM,WAAW,GAAG,GAAG,CAAC,KAAK,OAAO,OAAO,CAAC;IACxD,MAAM,SAAS,GAAG,QAAQ;IAC1B,OAAO,OACL,CAAC,8BAA8B,EAAE,SAAS,CAAC,CAAC,EAAE,QAAQ,GAAG,IAAI;AAEjE;AAaO,eAAe,cAAc,OAAyB;IAC3D,OAAO,QAAkD,2BAA2B;QAClF,aAAa,IAAI,OAAO,WAAW;QACnC,GAAG,OAAO;IACZ;AACF;AAcO,eAAe,eAAe,OAAsB;IACzD,OAAO,QAQJ,yBAAyB;AAC9B;AAkBO,eAAe,aAAa,OAAwB;IACzD,OAAO,QAAoC,mBAAmB;AAChE","debugId":null}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/hooks/useDriverState.ts"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useState } from \"react\";\nimport { DriverState, type DriverStateResponse, fetchDriverState } from \"@/lib/api-client\";\n\nfunction unwrapDriverState(payload: DriverStateResponse | DriverState | null): DriverState | null {\n  if (!payload) return null;\n  if (typeof (payload as DriverStateResponse)?.data !== \"undefined\") {\n    return (payload as DriverStateResponse)?.data ?? null;\n  }\n  return payload as DriverState;\n}\n\nexport function useDriverState(pollMs: number = 0) {\n  const [data, setData] = useState<DriverState | null>(null);\n  const [loading, setLoading] = useState(true);\n  const [error, setError] = useState<string | null>(null);\n\n  const load = useCallback(async () => {\n    const { data, error } = await fetchDriverState();\n    if (error) {\n      setError(error.message);\n    } else {\n      setError(null);\n      setData(unwrapDriverState(data ?? null));\n    }\n    setLoading(false);\n  }, []);\n\n  useEffect(() => {\n    load();\n    if (pollMs > 0) {\n      const id = setInterval(load, pollMs);\n      return () => clearInterval(id);\n    }\n  }, [load, pollMs]);\n\n  return { data, loading, error, refresh: load };\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;AAHA;;;AAKA,SAAS,kBAAkB,OAAiD;IAC1E,IAAI,CAAC,SAAS,OAAO;IACrB,IAAI,OAAQ,SAAiC,SAAS,aAAa;QACjE,OAAO,AAAC,SAAiC,QAAQ;IACnD;IACA,OAAO;AACT;AAEO,SAAS,eAAe,SAAiB,CAAC;IAC/C,MAAM,CAAC,MAAM,QAAQ,GAAG,IAAA,iNAAQ,EAAqB;IACrD,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAC;IACvC,MAAM,CAAC,OAAO,SAAS,GAAG,IAAA,iNAAQ,EAAgB;IAElD,MAAM,OAAO,IAAA,oNAAW,EAAC;QACvB,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,IAAA,wIAAgB;QAC9C,IAAI,OAAO;YACT,SAAS,MAAM,OAAO;QACxB,OAAO;YACL,SAAS;YACT,QAAQ,kBAAkB,QAAQ;QACpC;QACA,WAAW;IACb,GAAG,EAAE;IAEL,IAAA,kNAAS,EAAC;QACR;QACA,IAAI,SAAS,GAAG;YACd,MAAM,KAAK,YAAY,MAAM;YAC7B,OAAO,IAAM,cAAc;QAC7B;IACF,GAAG;QAAC;QAAM;KAAO;IAEjB,OAAO;QAAE;QAAM;QAAS;QAAO,SAAS;IAAK;AAC/C","debugId":null}},
    {"offset": {"line": 227, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/tracking/store.ts"],"sourcesContent":["\"use client\";\n\nimport { create } from \"zustand\";\nimport type { RecommendationResponse } from \"@/lib/api-client\";\n\nexport type PermissionStateMaybe = PermissionState | \"prompt\" | \"unsupported\";\n\nexport type TrackingFix = {\n  lat: number;\n  lon: number;\n  accuracy?: number | null;\n  speed?: number | null;\n  timestamp: number;\n};\n\ninterface TrackingState {\n  trackingOn: boolean;\n  permissionStatus: PermissionStateMaybe;\n  lastFix: TrackingFix | null;\n  lastPingAt: string | null;\n  lastRecommendation: RecommendationResponse | null;\n  error: string | null;\n  isDriving: boolean;\n  autoStartPending: boolean;\n  allowLowAccuracy: boolean;\n  setTrackingOn: (next: boolean) => void;\n  setPermissionStatus: (status: PermissionStateMaybe) => void;\n  setLastFix: (fix: TrackingFix | null) => void;\n  setLastPingAt: (iso: string | null) => void;\n  setRecommendation: (rec: RecommendationResponse | null) => void;\n  setError: (message: string | null) => void;\n  setIsDriving: (next: boolean) => void;\n  setAutoStartPending: (pending: boolean) => void;\n  setAllowLowAccuracy: (next: boolean) => void;\n}\n\nexport const useTrackingStore = create<TrackingState>((set) => ({\n  trackingOn: false,\n  permissionStatus: \"prompt\",\n  lastFix: null,\n  lastPingAt: null,\n  lastRecommendation: null,\n  error: null,\n  isDriving: false,\n  autoStartPending: true,\n  allowLowAccuracy: false,\n  setTrackingOn: (trackingOn) => set({ trackingOn }),\n  setPermissionStatus: (permissionStatus) => set({ permissionStatus }),\n  setLastFix: (lastFix) => set({ lastFix }),\n  setLastPingAt: (lastPingAt) => set({ lastPingAt }),\n  setRecommendation: (lastRecommendation) => set({ lastRecommendation }),\n  setError: (error) => set({ error }),\n  setIsDriving: (isDriving) =>\n    set(() => ({\n      isDriving,\n      autoStartPending: isDriving ? false : true,\n    })),\n  setAutoStartPending: (autoStartPending) => set({ autoStartPending }),\n  setAllowLowAccuracy: (allowLowAccuracy) => set({ allowLowAccuracy }),\n}));\n"],"names":[],"mappings":";;;;AAEA;AAFA;;AAoCO,MAAM,mBAAmB,IAAA,kKAAM,EAAgB,CAAC,MAAQ,CAAC;QAC9D,YAAY;QACZ,kBAAkB;QAClB,SAAS;QACT,YAAY;QACZ,oBAAoB;QACpB,OAAO;QACP,WAAW;QACX,kBAAkB;QAClB,kBAAkB;QAClB,eAAe,CAAC,aAAe,IAAI;gBAAE;YAAW;QAChD,qBAAqB,CAAC,mBAAqB,IAAI;gBAAE;YAAiB;QAClE,YAAY,CAAC,UAAY,IAAI;gBAAE;YAAQ;QACvC,eAAe,CAAC,aAAe,IAAI;gBAAE;YAAW;QAChD,mBAAmB,CAAC,qBAAuB,IAAI;gBAAE;YAAmB;QACpE,UAAU,CAAC,QAAU,IAAI;gBAAE;YAAM;QACjC,cAAc,CAAC,YACb,IAAI,IAAM,CAAC;oBACT;oBACA,kBAAkB,YAAY,QAAQ;gBACxC,CAAC;QACH,qBAAqB,CAAC,mBAAqB,IAAI;gBAAE;YAAiB;QAClE,qBAAqB,CAAC,mBAAqB,IAAI;gBAAE;YAAiB;IACpE,CAAC","debugId":null}},
    {"offset": {"line": 277, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\nconst Card = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\r\n      \"rounded-2xl border bg-card text-card-foreground shadow-sm\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\nCard.displayName = \"Card\";\r\n\r\nconst CardHeader = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\"flex flex-col space-y-1.5 p-6\", className)}\r\n    {...props}\r\n  />\r\n));\r\nCardHeader.displayName = \"CardHeader\";\r\n\r\nconst CardTitle = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLHeadingElement>\r\n>(({ className, ...props }, ref) => (\r\n  <h3\r\n    ref={ref}\r\n    className={cn(\r\n      \"text-2xl font-semibold leading-none tracking-tight\",\r\n      className\r\n    )}\r\n    {...props}\r\n  />\r\n));\r\nCardTitle.displayName = \"CardTitle\";\r\n\r\nconst CardDescription = React.forwardRef<\r\n  HTMLParagraphElement,\r\n  React.HTMLAttributes<HTMLParagraphElement>\r\n>(({ className, ...props }, ref) => (\r\n  <p\r\n    ref={ref}\r\n    className={cn(\"text-sm text-muted-foreground\", className)}\r\n    {...props}\r\n  />\r\n));\r\nCardDescription.displayName = \"CardDescription\";\r\n\r\nconst CardContent = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div ref={ref} className={cn(\"p-6 pt-0\", className)} {...props} />\r\n));\r\nCardContent.displayName = \"CardContent\";\r\n\r\nconst CardFooter = React.forwardRef<\r\n  HTMLDivElement,\r\n  React.HTMLAttributes<HTMLDivElement>\r\n>(({ className, ...props }, ref) => (\r\n  <div\r\n    ref={ref}\r\n    className={cn(\"flex items-center p-6 pt-0\", className)}\r\n    {...props}\r\n  />\r\n));\r\nCardFooter.displayName = \"CardFooter\";\r\n\r\nexport { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };\r\n"],"names":[],"mappings":";;;;;;;;;;;;;;;AAAA;AACA;;;;AAEA,MAAM,qBAAO,mNAAgB,CAG3B,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,IAAA,kHAAE,EACX,6DACA;QAED,GAAG,KAAK;;;;;;AAGb,KAAK,WAAW,GAAG;AAEnB,MAAM,2BAAa,mNAAgB,CAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,IAAA,kHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG;AAEzB,MAAM,0BAAY,mNAAgB,CAGhC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,IAAA,kHAAE,EACX,sDACA;QAED,GAAG,KAAK;;;;;;AAGb,UAAU,WAAW,GAAG;AAExB,MAAM,gCAAkB,mNAAgB,CAGtC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,IAAA,kHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGb,gBAAgB,WAAW,GAAG;AAE9B,MAAM,4BAAc,mNAAgB,CAGlC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QAAI,KAAK;QAAK,WAAW,IAAA,kHAAE,EAAC,YAAY;QAAa,GAAG,KAAK;;;;;;AAEhE,YAAY,WAAW,GAAG;AAE1B,MAAM,2BAAa,mNAAgB,CAGjC,CAAC,EAAE,SAAS,EAAE,GAAG,OAAO,EAAE,oBAC1B,8OAAC;QACC,KAAK;QACL,WAAW,IAAA,kHAAE,EAAC,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGb,WAAW,WAAW,GAAG","debugId":null}},
    {"offset": {"line": 362, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/nearest-zones.ts"],"sourcesContent":["import type { ZoneRow } from \"@/hooks/useZones\";\r\n\r\nexport type Coordinate = {\r\n  lat: number;\r\n  lon: number;\r\n};\r\n\r\nexport type LocalZoneSuggestion = {\r\n  zone_id: ZoneRow[\"id\"];\r\n  zone_name: string;\r\n  lat: number;\r\n  lon: number;\r\n  distance_m: number;\r\n  distance_km: number;\r\n  eta_min: number;\r\n  score: number;\r\n  radius_km: number | null;\r\n  weight_demand: number | null;\r\n  inside_radius: boolean;\r\n  reason: string;\r\n};\r\n\r\nexport type ComputeNearestZonesOptions = {\r\n  limit?: number;\r\n  vehicleSpeedKmh?: number;\r\n  origin?: string;\r\n};\r\n\r\nexport type ComputeNearestZonesResult = {\r\n  results: LocalZoneSuggestion[];\r\n  best: LocalZoneSuggestion | null;\r\n};\r\n\r\nconst EARTH_RADIUS_M = 6371e3;\r\nconst DEFAULT_SPEED_KMH = 20;\r\n\r\nfunction toRadians(value: number) {\r\n  return (value * Math.PI) / 180;\r\n}\r\n\r\nfunction distanceMeters(a: Coordinate, b: Coordinate) {\r\n  const deltaLat = toRadians(b.lat - a.lat);\r\n  const deltaLon = toRadians(b.lon - a.lon);\r\n  const lat1 = toRadians(a.lat);\r\n  const lat2 = toRadians(b.lat);\r\n\r\n  const haversine =\r\n    Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +\r\n    Math.cos(lat1) * Math.cos(lat2) *\r\n      Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);\r\n  const c = 2 * Math.atan2(Math.sqrt(haversine), Math.sqrt(1 - haversine));\r\n  return EARTH_RADIUS_M * c;\r\n}\r\n\r\nfunction resolveZoneCoordinate(zone: ZoneRow): Coordinate | null {\r\n  const center = zone.center as { coordinates?: [number, number] } | null;\r\n  if (center && Array.isArray(center.coordinates) && center.coordinates.length === 2) {\r\n    const [lon, lat] = center.coordinates;\r\n    if (typeof lat === \"number\" && typeof lon === \"number\") {\r\n      return { lat, lon };\r\n    }\r\n  }\r\n\r\n  if (typeof zone.lat === \"number\" && typeof zone.lon === \"number\") {\r\n    return { lat: zone.lat, lon: zone.lon };\r\n  }\r\n\r\n  return null;\r\n}\r\n\r\nfunction clampScore(value: number) {\r\n  return Math.max(0, Math.min(1, Number(value.toFixed(4))));\r\n}\r\n\r\nfunction computeZoneScore(distanceKm: number, insideRadius: boolean, weight: number | null | undefined) {\r\n  const distanceScore = Math.max(0, 1 - distanceKm / 4); // degrade after 4km\r\n  const insideBoost = insideRadius ? 0.2 : 0;\r\n  const normalizedWeight = typeof weight === \"number\" && Number.isFinite(weight) ? weight : 1;\r\n  const demandBoost = Math.min(0.4, (normalizedWeight - 1) * 0.25);\r\n  return clampScore(distanceScore + insideBoost + demandBoost);\r\n}\r\n\r\nfunction describeReason(distanceM: number, insideRadius: boolean, weight: number | null | undefined) {\r\n  const parts: string[] = [];\r\n  if (distanceM < 1000) {\r\n    parts.push(`${Math.round(distanceM)}m away`);\r\n  } else {\r\n    parts.push(`${(distanceM / 1000).toFixed(1)} km away`);\r\n  }\r\n  if (insideRadius) {\r\n    parts.push(\"inside zone radius\");\r\n  }\r\n  if (typeof weight === \"number\" && weight > 1) {\r\n    parts.push(`demand +${Math.round((weight - 1) * 100)}%`);\r\n  }\r\n  return `Local pick • ${parts.join(\" · \")}`;\r\n}\r\n\r\nexport function computeNearestZones(\r\n  zones: ZoneRow[],\r\n  location: Coordinate,\r\n  opts?: ComputeNearestZonesOptions\r\n): ComputeNearestZonesResult {\r\n  if (!zones.length) {\r\n    return { results: [], best: null };\r\n  }\r\n  const limit = opts?.limit ?? 3;\r\n  const speed = opts?.vehicleSpeedKmh ?? DEFAULT_SPEED_KMH;\r\n\r\n  const enriched = zones\r\n    .map<LocalZoneSuggestion | null>((zone) => {\r\n      const coord = resolveZoneCoordinate(zone);\r\n      if (!coord) return null;\r\n\r\n      const distance_m = distanceMeters(location, coord);\r\n      const distance_km = distance_m / 1000;\r\n      const radius_km =\r\n        typeof zone.radius_km === \"number\" && Number.isFinite(zone.radius_km)\r\n          ? zone.radius_km\r\n          : null;\r\n      const inside_radius = radius_km !== null ? distance_m <= radius_km * 1000 : distance_m <= 500;\r\n      const eta_min = Math.max(1, Math.round((distance_km / speed) * 60));\r\n      const score = computeZoneScore(distance_km, inside_radius, zone.weight_demand ?? null);\r\n\r\n      return {\r\n        zone_id: zone.id,\r\n        zone_name: zone.name,\r\n        lat: coord.lat,\r\n        lon: coord.lon,\r\n        distance_m,\r\n        distance_km,\r\n        eta_min,\r\n        score,\r\n        radius_km,\r\n        weight_demand: zone.weight_demand ?? null,\r\n        inside_radius,\r\n        reason: describeReason(distance_m, inside_radius, zone.weight_demand ?? null),\r\n      };\r\n    })\r\n    .filter(Boolean)\r\n    .sort((a, b) => {\r\n      if (!a || !b) return 0;\r\n      if (a.score === b.score) {\r\n        return a.distance_m - b.distance_m;\r\n      }\r\n      return b.score - a.score;\r\n    })\r\n    .slice(0, limit) as LocalZoneSuggestion[];\r\n\r\n  if (enriched.length && typeof window !== \"undefined\") {\r\n    console.log(\"[nearest-zones] computed\", {\r\n      origin: opts?.origin ?? \"unknown\",\r\n      best_zone: enriched[0]?.zone_name,\r\n      distance_m: Math.round(enriched[0]?.distance_m ?? 0),\r\n      considered: zones.length,\r\n    });\r\n  }\r\n\r\n  return { results: enriched, best: enriched[0] ?? null };\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 474, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/components/NextZonesPanel.tsx"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useMemo, useRef, useState } from \"react\";\nimport { RecommendationResponse, type DriverState } from \"@/lib/api-client\";\nimport { useDriverState } from \"@/lib/hooks/useDriverState\";\nimport { useTrackingStore } from \"@/lib/tracking/store\";\nimport { Card, CardContent, CardHeader, CardTitle } from \"@/components/ui/card\";\nimport { Button } from \"@/components/ui/button\";\nimport { ArrowUpRight, MapPin, RefreshCw } from \"lucide-react\";\nimport { formatDistanceToNow } from \"date-fns\";\nimport type { CurrentLocation } from \"@/hooks/useLiveTracking\";\nimport { useZones } from \"@/hooks/useZones\";\nimport { computeNearestZones } from \"@/lib/nearest-zones\";\n\ninterface NextZonesPanelProps {\n  trackingOn: boolean;\n  hasLocation: boolean;\n  isFetchingLocation: boolean;\n  currentLoc: CurrentLocation | null;\n  seedRecommendation?: RecommendationResponse | null;\n  allowLowAccuracy?: boolean;\n  onAllowLowAccuracy?: () => void;\n}\n\nconst STALE_MS = 45_000;\nconst AUTO_REFRESH_MS = 180_000; // 3 minutes\n\nexport function NextZonesPanel({\n  trackingOn,\n  hasLocation,\n  isFetchingLocation,\n  currentLoc,\n  seedRecommendation,\n  allowLowAccuracy,\n  onAllowLowAccuracy,\n}: NextZonesPanelProps) {\n  const { data: driverState } = useDriverState();\n  const { zones } = useZones();\n  const [recommendation, setRecommendation] = useState<RecommendationResponse | null>(\n    seedRecommendation ?? null\n  );\n  const [loading, setLoading] = useState(!seedRecommendation);\n  const [error, setError] = useState<string | null>(null);\n  const setTrackingRecommendation = useTrackingStore((s) => s.setRecommendation);\n  const lastFix = useTrackingStore((s) => s.lastFix);\n  const lastFixRef = useRef(lastFix);\n  const lastFetchAtRef = useRef(0);\n  const currentLocRef = useRef<CurrentLocation | null>(currentLoc);\n  const hasLocationRef = useRef(hasLocation);\n  const lastFetchedCoordsRef = useRef<{ lat: number; lon: number } | null>(null);\n  const debounceTimerRef = useRef<ReturnType<typeof setTimeout> | null>(null);\n  const initialFetchTriggeredRef = useRef(false);\n\n  useEffect(() => {\n    lastFixRef.current = lastFix;\n  }, [lastFix]);\n\n  useEffect(() => {\n    currentLocRef.current = currentLoc;\n  }, [currentLoc]);\n\n  useEffect(() => {\n    hasLocationRef.current = hasLocation;\n  }, [hasLocation]);\n\n  const fallbackLocation = useMemo(() => selectBestLocation(currentLoc, driverState), [currentLoc, driverState]);\n\n  const syncRecommendation = useCallback(\n    (next: RecommendationResponse | null) => {\n      setRecommendation(next);\n      setTrackingRecommendation(next);\n    },\n    [setTrackingRecommendation]\n  );\n\n  const buildLocalRecommendation = useCallback(\n    (\n      coords: { lat: number; lon: number },\n      meta: { origin: \"live_fix\" | \"driver_state_coords\" | \"driver_state_loc\"; trigger: string }\n    ): RecommendationResponse | null => {\n      if (!zones.length) return null;\n      const { results } = computeNearestZones(zones, coords, {\n        limit: 3,\n        origin: meta.origin,\n      });\n      const top = results.map((zone) => ({\n        zone_id: zone.zone_id,\n        zone_name: zone.zone_name,\n        lat: zone.lat,\n        lon: zone.lon,\n        distance_km: Number(zone.distance_km.toFixed(2)),\n        eta_min: zone.eta_min,\n        score: zone.score,\n        reason: zone.reason,\n        traffic_speed_idx: null,\n      }));\n\n      return {\n        computed_at: new Date().toISOString(),\n        source: \"local\",\n        traffic_source: \"fallback\",\n        context: {\n          reason: top.length ? \"local_inference\" : \"no_zones_in_db\",\n          origin: meta.origin,\n          trigger: meta.trigger,\n        },\n        top,\n      };\n    },\n    [zones]\n  );\n\n  useEffect(() => {\n    if (!fallbackLocation) return;\n    if (recommendation?.top?.length) return;\n    const seeded = buildLocalRecommendation(fallbackLocation.coords, {\n      origin: fallbackLocation.source,\n      trigger: \"driver_state_seed\",\n    });\n    if (seeded && seeded.top.length) {\n      setError(null);\n      setLoading(false);\n      syncRecommendation(seeded);\n    }\n  }, [fallbackLocation, recommendation, buildLocalRecommendation, syncRecommendation]);\n\n  const hydrateFromState = useCallback(() => {\n    if (driverState?.recommendation) {\n      const rec = driverState.recommendation;\n      if (Date.now() - Date.parse(rec.computed_at) < STALE_MS) {\n        syncRecommendation(rec);\n        setError(null);\n        setLoading(false);\n        return true;\n      }\n    }\n    return false;\n  }, [driverState, syncRecommendation]);\n\n  const fetchLatest = useCallback(\n    async (reason: string = \"manual\") => {\n      const loc = currentLocRef.current;\n      if (!loc || !hasLocationRef.current) {\n        setLoading(false);\n        return;\n      }\n\n      lastFetchAtRef.current = Date.now();\n      lastFetchedCoordsRef.current = { lat: loc.lat, lon: loc.lon };\n      setLoading(true);\n      setError(null);\n\n      const localRecommendation = buildLocalRecommendation(\n        { lat: loc.lat, lon: loc.lon },\n        { origin: \"live_fix\", trigger: reason }\n      );\n\n      if (!localRecommendation || localRecommendation.top.length === 0) {\n        setError(\"No zones with coordinates are configured yet.\");\n      } else {\n        setError(null);\n        syncRecommendation(localRecommendation);\n      }\n      setLoading(false);\n    },\n    [buildLocalRecommendation, syncRecommendation]\n  );\n\n  useEffect(() => {\n    if (!seedRecommendation && hasLocation) {\n      if (!hydrateFromState()) {\n        fetchLatest(\"initial_state\");\n      }\n    }\n  }, [seedRecommendation, hasLocation, hydrateFromState, fetchLatest]);\n\n  const requestRefresh = useCallback(\n    (reason: string) => {\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n      debounceTimerRef.current = setTimeout(() => {\n        debounceTimerRef.current = null;\n        void fetchLatest(reason);\n      }, 800);\n    },\n    [fetchLatest]\n  );\n\n  useEffect(() => {\n    if (!hasLocation) {\n      initialFetchTriggeredRef.current = false;\n    }\n  }, [hasLocation]);\n\n  // Kick off the first fetch as soon as we have a good GPS fix\n  useEffect(() => {\n    if (!hasLocation || !currentLoc) return;\n    if (!initialFetchTriggeredRef.current) {\n      initialFetchTriggeredRef.current = true;\n      void fetchLatest(\"first_fix\");\n    }\n  }, [hasLocation, currentLoc, fetchLatest]);\n\n  // Refresh when the driver moves ~50m or every 15s while tracking\n  useEffect(() => {\n    if (!hasLocation || !currentLoc || !initialFetchTriggeredRef.current) return;\n    const lastCoords = lastFetchedCoordsRef.current;\n    const now = Date.now();\n    const movedMeters = lastCoords\n      ? distanceBetweenMeters(lastCoords.lat, lastCoords.lon, currentLoc.lat, currentLoc.lon)\n      : Infinity;\n\n    if (\n      !lastCoords ||\n      movedMeters >= 50 ||\n      now - lastFetchAtRef.current >= 15_000\n    ) {\n      requestRefresh(\"movement_or_interval\");\n    }\n  }, [hasLocation, currentLoc, requestRefresh]);\n\n  useEffect(() => {\n    hydrateFromState();\n  }, [driverState, hydrateFromState]);\n\n  useEffect(() => {\n    return () => {\n      if (debounceTimerRef.current) {\n        clearTimeout(debounceTimerRef.current);\n      }\n    };\n  }, []);\n\n  useEffect(() => {\n    if (\n      seedRecommendation &&\n      (!recommendation ||\n        seedRecommendation.computed_at !== recommendation.computed_at)\n    ) {\n      syncRecommendation(seedRecommendation);\n    }\n  }, [seedRecommendation, recommendation, syncRecommendation]);\n\n  const runAutoRefresh = useCallback(() => {\n    if (!hasLocationRef.current) return;\n    const now = Date.now();\n    if (now - lastFetchAtRef.current < AUTO_REFRESH_MS) {\n      return;\n    }\n    void fetchLatest(\"auto_refresh\");\n  }, [fetchLatest]);\n\n  useEffect(() => {\n    if (!trackingOn || !hasLocation) return;\n    runAutoRefresh();\n    const id = setInterval(runAutoRefresh, AUTO_REFRESH_MS);\n    return () => clearInterval(id);\n  }, [trackingOn, hasLocation, runAutoRefresh]);\n\n  const hasServerResults = Boolean(recommendation?.top && recommendation.top.length > 0);\n  const empty = !loading && !error && !hasServerResults;\n  const waitingForGps = trackingOn && !hasLocation;\n  const rawAccuracy = currentLoc?.accuracy_m ?? lastFix?.accuracy ?? null;\n  const gpsAccuracy = typeof rawAccuracy === \"number\" ? rawAccuracy : null;\n  const computedAgo = recommendation?.computed_at\n    ? formatDistanceToNow(new Date(recommendation.computed_at), { addSuffix: true })\n    : null;\n  const context = recommendation?.context as { traffic_speed_idx?: number; reason?: string } | undefined;\n  const avgTrafficIdx =\n    typeof context?.traffic_speed_idx === \"number\" ? context.traffic_speed_idx : null;\n  const trafficSource = recommendation?.traffic_source ?? null;\n  const contextReason = typeof context?.reason === \"string\" ? context.reason : undefined;\n\n  const emptyStateContent = (() => {\n    if (waitingForGps || isFetchingLocation) {\n      return (\n        <div>\n          <p className=\"font-medium\">Waiting for GPS fix...</p>\n          <p className=\"mt-1 text-xs\">\n            Move outdoors for a clear sky view. Accuracy must be &lt;150m before we can plan zones.\n          </p>\n          {typeof gpsAccuracy === \"number\" && (\n            <p className=\"mt-1 text-xs text-amber-600\">Current accuracy: {gpsAccuracy.toFixed(0)}m</p>\n          )}\n          {!allowLowAccuracy && Boolean(onAllowLowAccuracy) && (\n            <Button size=\"sm\" variant=\"secondary\" className=\"mt-3\" onClick={onAllowLowAccuracy}>\n              Use low-accuracy fix\n            </Button>\n          )}\n        </div>\n      );\n    }\n    if (contextReason === \"no_zones_in_db\") {\n      return (\n        <div>\n          <p className=\"font-medium\">No zones configured</p>\n          <p className=\"mt-1 text-xs\">\n            Ask operations to seed the zones table. Recommendations need at least one zone.\n          </p>\n        </div>\n      );\n    }\n    if (contextReason === \"no_zones_with_coords\") {\n      return (\n        <div>\n          <p className=\"font-medium\">Zones missing coordinates</p>\n          <p className=\"mt-1 text-xs\">\n            None of the zones have lat/lon or center coordinates. Update them in Supabase.\n          </p>\n        </div>\n      );\n    }\n    return \"We'll start suggesting zones once we see your location.\";\n  })();\n  const headerMeta = useMemo(() => {\n    const parts = [\n      computedAgo ? `Refreshed ${computedAgo}` : \"Refreshed just now\",\n      describeTrafficSource(trafficSource),\n      avgTrafficIdx !== null ? `Avg traffic ${describeTrafficLevel(avgTrafficIdx)}` : null,\n    ];\n    return parts.filter(Boolean).join(\" | \");\n  }, [computedAgo, trafficSource, avgTrafficIdx]);\n\n  return (\n    <Card className=\"shadow-sm\">\n      <CardHeader className=\"flex flex-row items-center justify-between space-y-0\">\n        <div>\n          <CardTitle className=\"text-base font-semibold\">Next best zones</CardTitle>\n          <p className=\"text-xs text-muted-foreground\">{headerMeta}</p>\n        </div>\n        <Button\n          variant=\"ghost\"\n          size=\"icon\"\n          aria-label=\"Refresh\"\n          onClick={() => fetchLatest(\"manual_button\")}\n          disabled={!hasLocation || isFetchingLocation}\n        >\n          <RefreshCw className=\"h-4 w-4\" />\n        </Button>\n      </CardHeader>\n      <CardContent className=\"space-y-4\">\n        {loading && (\n          <div className=\"space-y-3\">\n            {[0, 1, 2].map((idx) => (\n              <div key={idx} className=\"rounded-xl border p-3\">\n                <div className=\"h-4 w-1/2 animate-pulse rounded bg-muted\" />\n                <div className=\"mt-2 h-3 w-1/3 animate-pulse rounded bg-muted\" />\n              </div>\n            ))}\n          </div>\n        )}\n\n        {!loading && error && (\n          <div className=\"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700\">\n            {error}\n            <Button\n              size=\"sm\"\n              variant=\"secondary\"\n              className=\"mt-3\"\n              onClick={() => fetchLatest(\"retry\")}\n              disabled={isFetchingLocation || !hasLocation}\n            >\n              Try again\n            </Button>\n          </div>\n        )}\n\n        {empty && (\n          <div className=\"rounded-xl border border-dashed p-4 text-sm text-muted-foreground\">\n            {emptyStateContent}\n          </div>\n        )}\n\n        {!loading && !error && recommendation?.top?.length ? (\n          <div className=\"space-y-3\">\n            {recommendation.top.map((zone) => (\n              <ZoneCard key={zone.zone_id} zone={zone} />\n            ))}\n          </div>\n        ) : null}\n      </CardContent>\n    </Card>\n  );\n}\n\ntype DerivedLocation = {\n  coords: { lat: number; lon: number };\n  source: \"live_fix\" | \"driver_state_coords\" | \"driver_state_loc\";\n};\n\nfunction selectBestLocation(currentLoc: CurrentLocation | null, driverState: DriverState | null): DerivedLocation | null {\n  if (currentLoc) {\n    return { coords: { lat: currentLoc.lat, lon: currentLoc.lon }, source: \"live_fix\" };\n  }\n  if (!driverState) return null;\n\n  if (typeof driverState.lat === \"number\" && typeof driverState.lon === \"number\") {\n    return { coords: { lat: driverState.lat, lon: driverState.lon }, source: \"driver_state_coords\" };\n  }\n\n  const coordsField = (driverState as DriverState & { coords?: { lat?: number; lon?: number } | null })?.coords;\n  if (coordsField && typeof coordsField.lat === \"number\" && typeof coordsField.lon === \"number\") {\n    return { coords: { lat: coordsField.lat, lon: coordsField.lon }, source: \"driver_state_coords\" };\n  }\n\n  const locPoint = driverState.loc as { coordinates?: [number, number] } | null;\n  if (locPoint && Array.isArray(locPoint.coordinates) && locPoint.coordinates.length === 2) {\n    const [lon, lat] = locPoint.coordinates;\n    if (typeof lat === \"number\" && typeof lon === \"number\") {\n      return { coords: { lat, lon }, source: \"driver_state_loc\" };\n    }\n  }\n\n  return null;\n}\n\nfunction ZoneCard({ zone }: { zone: RecommendationResponse[\"top\"][number] }) {\n  const hasScore = typeof zone.score === \"number\";\n  const hasEta = typeof zone.eta_min === \"number\";\n  const hasDistance = typeof zone.distance_km === \"number\";\n  const distanceLabel = hasDistance ? `${zone.distance_km!.toFixed(1)} km` : \"Distance n/a\";\n  const etaLabel = hasEta ? `${zone.eta_min} min` : \"ETA n/a\";\n  const scoreLabel = hasScore ? zone.score!.toFixed(2) : \"Score n/a\";\n  const barWidth = hasScore ? `${Math.min(100, Math.round(zone.score! * 100))}%` : \"0%\";\n\n  const handleNavigate = () => {\n    const q = encodeURIComponent(`${zone.zone_name} Patna`);\n    window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, \"_blank\");\n  };\n\n  const trafficLabel =\n    typeof zone.traffic_speed_idx === \"number\"\n      ? describeTrafficLevel(zone.traffic_speed_idx)\n      : null;\n\n  return (\n    <div className=\"rounded-2xl border p-4\">\n      <div className=\"flex items-start justify-between gap-3\">\n        <div>\n          <div className=\"flex items-center gap-2 text-base font-semibold\">\n            <MapPin className=\"h-4 w-4 text-primary\" />\n            {zone.zone_name}\n          </div>\n          <p className=\"text-xs text-muted-foreground\">\n            {distanceLabel} | {etaLabel} | {scoreLabel}\n          </p>\n          {trafficLabel && (\n            <p className=\"text-xs text-muted-foreground\">Traffic: {trafficLabel}</p>\n          )}\n        </div>\n        <Button size=\"sm\" variant=\"secondary\" onClick={handleNavigate}>\n          Navigate\n          <ArrowUpRight className=\"ml-1 h-3 w-3\" />\n        </Button>\n      </div>\n      <div className=\"mt-3 text-sm text-muted-foreground\">{zone.reason}</div>\n      <div className=\"mt-3 h-1.5 rounded-full bg-muted\">\n        <div className=\"h-full rounded-full bg-emerald-500\" style={{ width: barWidth }} />\n      </div>\n    </div>\n  );\n}\n\nfunction describeTrafficSource(source?: string | null) {\n  if (source === \"google\") return \"Google live traffic\";\n  if (source === \"cache\") return \"Cached traffic snapshot\";\n  if (source === \"fallback\") return \"Estimated traffic\";\n  return null;\n}\n\nfunction describeTrafficLevel(idx: number) {\n  if (idx >= 0.85) return \"Smooth\";\n  if (idx >= 0.65) return \"Moderate\";\n  if (idx >= 0.4) return \"Busy\";\n  return \"Heavy\";\n}\n\nfunction distanceBetweenMeters(lat1: number, lon1: number, lat2: number, lon2: number) {\n  const R = 6371e3;\n  const phi1 = (lat1 * Math.PI) / 180;\n  const phi2 = (lat2 * Math.PI) / 180;\n  const deltaPhi = ((lat2 - lat1) * Math.PI) / 180;\n  const deltaLambda = ((lon2 - lon1) * Math.PI) / 180;\n\n  const a =\n    Math.sin(deltaPhi / 2) * Math.sin(deltaPhi / 2) +\n    Math.cos(phi1) * Math.cos(phi2) *\n      Math.sin(deltaLambda / 2) * Math.sin(deltaLambda / 2);\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n  return R * c;\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1209, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/components/RideControls.tsx"],"sourcesContent":["\"use client\";\n\nimport { useMemo, useState } from \"react\";\nimport { Button, type ButtonProps } from \"@/components/ui/button\";\nimport { postRideEvent } from \"@/lib/api-client\";\nimport { useTrackingStore, type TrackingFix } from \"@/lib/tracking/store\";\nimport { toast } from \"sonner\";\nimport { XCircle } from \"lucide-react\";\n\ntype RideEventAction =\n  | \"booking_received\"\n  | \"ride_started\"\n  | \"ride_completed\"\n  | \"booking_cancelled\";\n\nconst events: Array<{ type: RideEventAction; label: string; variant: ButtonProps[\"variant\"] }> = [\n  { type: \"booking_received\", label: \"Got a Ride\", variant: \"default\" },\n  { type: \"ride_started\", label: \"Start Ride\", variant: \"default\" },\n  { type: \"ride_completed\", label: \"Complete Ride\", variant: \"destructive\" }, // Changed to destructive/prominent for completion\n  { type: \"booking_cancelled\", label: \"Cancel Booking\", variant: \"ghost\" },\n] as const;\n\ntype EventConfig = (typeof events)[number];\ntype RideState = \"idle\" | \"booking\" | \"on_trip\";\n\ninterface RideControlsProps {\n  lastFix: TrackingFix | null;\n}\n\nexport function RideControls({ lastFix }: RideControlsProps) {\n  const [platform, setPlatform] = useState<\"ola\" | \"uber\">(\"ola\");\n  const [rideState, setRideState] = useState<RideState>(\"idle\");\n  const [activeEvent, setActiveEvent] = useState<EventConfig | null>(null);\n  const [submitting, setSubmitting] = useState(false);\n  const setIsDriving = useTrackingStore((s) => s.setIsDriving);\n\n  const coordsCopy = useMemo(() => {\n    if (!lastFix) return \"No live GPS\";\n    return `${lastFix.lat.toFixed(4)}, ${lastFix.lon.toFixed(4)}`;\n  }, [lastFix]);\n\n  const handleMainAction = () => {\n    if (rideState === \"idle\") {\n      setActiveEvent(events.find((e) => e.type === \"booking_received\")!);\n    } else if (rideState === \"booking\") {\n      setActiveEvent(events.find((e) => e.type === \"ride_started\")!);\n    } else if (rideState === \"on_trip\") {\n      setActiveEvent(events.find((e) => e.type === \"ride_completed\")!);\n    }\n  };\n\n  const handleCancelAction = () => {\n    setActiveEvent(events.find((e) => e.type === \"booking_cancelled\")!);\n  };\n\n  const confirmEvent = async () => {\n    if (!activeEvent) return;\n    setSubmitting(true);\n    const payload: Parameters<typeof postRideEvent>[0] = {\n      event_type: activeEvent.type,\n      platform,\n    };\n    if (lastFix) {\n      if (activeEvent.type === \"ride_completed\") {\n        payload.drop_lat = lastFix.lat;\n        payload.drop_lon = lastFix.lon;\n      } else {\n        payload.pickup_lat = lastFix.lat;\n        payload.pickup_lon = lastFix.lon;\n      }\n    }\n    const { error } = await postRideEvent(payload);\n    setSubmitting(false);\n    setActiveEvent(null);\n    if (error) {\n      toast.error(error.message);\n    } else {\n      toast.success(`${copyForEvent(activeEvent.type)} logged`);\n      \n      // State transitions\n      if (activeEvent.type === \"booking_received\") {\n        setRideState(\"booking\");\n        setIsDriving(false);\n      } else if (activeEvent.type === \"ride_started\") {\n        setRideState(\"on_trip\");\n        setIsDriving(true);\n      } else if (activeEvent.type === \"ride_completed\") {\n        setRideState(\"idle\");\n        setIsDriving(false);\n      } else if (activeEvent.type === \"booking_cancelled\") {\n        setRideState(\"idle\");\n        setIsDriving(false);\n      }\n    }\n  };\n\n  const getMainButtonLabel = () => {\n    switch (rideState) {\n      case \"idle\": return \"Got a Ride\";\n      case \"booking\": return \"Start Ride\";\n      case \"on_trip\": return \"Complete Ride\";\n    }\n  };\n\n  const getMainButtonVariant = (): ButtonProps[\"variant\"] => {\n    switch (rideState) {\n      case \"idle\": return \"default\"; // Green/Primary\n      case \"booking\": return \"secondary\"; // Distinct from idle\n      case \"on_trip\": return \"destructive\"; // Red/End action? Or maybe outline. Let's use default for now or specific style.\n    }\n  };\n\n  return (\n    <div className=\"space-y-4\">\n      <div className=\"flex items-center justify-between rounded-2xl border bg-white/60 px-4 py-3 shadow-sm\">\n        <div>\n          <p className=\"text-xs uppercase text-muted-foreground\">Current platform</p>\n          <div className=\"mt-1 inline-flex gap-2 rounded-full bg-muted p-1\">\n            {[\"ola\", \"uber\"].map((provider) => (\n              <button\n                key={provider}\n                type=\"button\"\n                onClick={() => setPlatform(provider as \"ola\" | \"uber\")}\n                className={`rounded-full px-3 py-1 text-xs font-semibold capitalize transition ${\n                  platform === provider\n                    ? \"bg-white text-foreground shadow\"\n                    : \"text-muted-foreground\"\n                }`}\n              >\n                {provider}\n              </button>\n            ))}\n          </div>\n        </div>\n        {/* <div className=\"text-right text-xs text-muted-foreground\">\n          <p>Last fix</p>\n          <p className=\"font-semibold text-foreground\">{coordsCopy}</p>\n        </div> */}\n      </div>\n\n      <div className=\"flex flex-col gap-3\">\n        <Button\n          className={`h-14 text-lg font-semibold shadow-sm transition-all ${\n            rideState === \"on_trip\" ? \"bg-red-600 hover:bg-red-700 text-white\" : \n            rideState === \"booking\" ? \"bg-emerald-600 hover:bg-emerald-700 text-white\" : \"\"\n          }`}\n          variant={rideState === \"idle\" ? \"default\" : \"secondary\"}\n          onClick={handleMainAction}\n        >\n          {getMainButtonLabel()}\n        </Button>\n\n        {rideState === \"booking\" && (\n          <Button\n            variant=\"ghost\"\n            className=\"text-muted-foreground hover:text-red-600 hover:bg-red-50\"\n            onClick={handleCancelAction}\n          >\n            <XCircle className=\"mr-2 h-4 w-4\" />\n            Cancel Booking\n          </Button>\n        )}\n      </div>\n\n      {/* <p className=\"text-xs text-muted-foreground\">\n        Your live location is only used to suggest better zones and calculate your performance. It stays private to you.\n      </p> */}\n\n      {activeEvent && (\n        <div className=\"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 pb-8 animate-in fade-in duration-200\">\n          <div className=\"w-full max-w-md rounded-3xl bg-whitesmoke p-6 shadow-2xl\"\n          style={{\n            background:'whitesmoke'\n          }}\n          >\n            <p className=\"text-sm font-semibold text-muted-foreground\">Confirm action</p>\n            <h3 className=\"text-2xl font-semibold mt-1\">{activeEvent.label}</h3>\n            \n            <div className=\"mt-4 space-y-2 rounded-xl bg-muted/50 p-4\">\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Platform</span>\n                <span className=\"font-medium capitalize\">{platform}</span>\n              </div>\n              <div className=\"flex justify-between text-sm\">\n                <span className=\"text-muted-foreground\">Location</span>\n                <span className=\"font-medium font-mono\">{coordsCopy}</span>\n              </div>\n            </div>\n\n            <div className=\"mt-6 flex gap-3\">\n              <Button variant=\"outline\" className=\"flex-1 h-12\" onClick={() => setActiveEvent(null)}>\n                Back\n              </Button>\n              <Button \n                className=\"flex-1 h-12\" \n                variant={activeEvent.type === \"booking_cancelled\" ? \"destructive\" : \"default\"}\n                onClick={confirmEvent} \n                disabled={submitting}\n              >\n                {submitting ? \"Saving...\" : \"Confirm\"}\n              </Button>\n            </div>\n          </div>\n        </div>\n      )}\n    </div>\n  );\n}\n\nfunction copyForEvent(type: EventConfig[\"type\"]) {\n  switch (type) {\n    case \"booking_received\":\n      return \"Booking\";\n    case \"ride_started\":\n      return \"Ride start\";\n    case \"ride_completed\":\n      return \"Ride completion\";\n    case \"booking_cancelled\":\n      return \"Cancellation\";\n    default:\n      return \"Event\";\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1566, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/components/GpsAccuracyBadge.tsx"],"sourcesContent":["\"use client\";\n\nimport { cn } from \"@/lib/utils\";\n\ninterface GpsAccuracyBadgeProps {\n  accuracy?: number | null;\n  trackingOn: boolean;\n}\n\nexport function GpsAccuracyBadge({ accuracy, trackingOn }: GpsAccuracyBadgeProps) {\n  let label = trackingOn ? \"GPS: waiting for fix\" : \"GPS: paused\";\n  let tone = \"bg-muted text-muted-foreground\";\n\n  if (typeof accuracy === \"number\" && Number.isFinite(accuracy)) {\n    const rounded = Math.max(0, Math.round(accuracy));\n    if (rounded <= 30) {\n      label = `GPS: ${rounded}m accuracy`;\n      tone = \"bg-emerald-100 text-emerald-900\";\n    } else if (rounded <= 100) {\n      label = `GPS: ${rounded}m (ok)`;\n      tone = \"bg-amber-100 text-amber-900\";\n    } else {\n      label = `GPS: ${rounded}m (weak) - move outdoors`;\n      tone = \"bg-rose-100 text-rose-900\";\n    }\n  } else if (trackingOn) {\n    tone = \"bg-muted text-muted-foreground\";\n  }\n\n  return (\n    <div className={cn(\"inline-flex rounded-full px-3 py-1 text-xs font-semibold\", tone)}>\n      {label}\n    </div>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AAFA;;;AASO,SAAS,iBAAiB,EAAE,QAAQ,EAAE,UAAU,EAAyB;IAC9E,IAAI,QAAQ,aAAa,yBAAyB;IAClD,IAAI,OAAO;IAEX,IAAI,OAAO,aAAa,YAAY,OAAO,QAAQ,CAAC,WAAW;QAC7D,MAAM,UAAU,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC;QACvC,IAAI,WAAW,IAAI;YACjB,QAAQ,CAAC,KAAK,EAAE,QAAQ,UAAU,CAAC;YACnC,OAAO;QACT,OAAO,IAAI,WAAW,KAAK;YACzB,QAAQ,CAAC,KAAK,EAAE,QAAQ,MAAM,CAAC;YAC/B,OAAO;QACT,OAAO;YACL,QAAQ,CAAC,KAAK,EAAE,QAAQ,wBAAwB,CAAC;YACjD,OAAO;QACT;IACF,OAAO,IAAI,YAAY;QACrB,OAAO;IACT;IAEA,qBACE,8OAAC;QAAI,WAAW,IAAA,kHAAE,EAAC,4DAA4D;kBAC5E;;;;;;AAGP","debugId":null}},
    {"offset": {"line": 1606, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/offline-queue.ts"],"sourcesContent":["import { openDB, IDBPDatabase } from \"idb\";\r\n\r\nconst DB = \"ride-db\";\r\nconst STORE = \"events\";\r\n\r\nasync function db() { \r\n  return openDB(DB, 1, { \r\n    upgrade(d: IDBPDatabase) { \r\n      d.createObjectStore(STORE, { keyPath: \"id\", autoIncrement: true }); \r\n    } \r\n  }); \r\n}\r\n\r\nexport async function enqueue(e: any) { \r\n  (await db()).add(STORE, { ...e, created_at: Date.now() }); \r\n}\r\n\r\nexport async function drain(flush: (e: any) => Promise<boolean>) {\r\n  const d = await db();\r\n  const tx = d.transaction(STORE, \"readwrite\");\r\n  const s = tx.store;\r\n  let c = await s.openCursor();\r\n  while (c) { \r\n    const ok = await flush(c.value); \r\n    if (ok) await c.delete(); \r\n    c = await c.continue(); \r\n  }\r\n  await tx.done;\r\n}\r\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,MAAM,KAAK;AACX,MAAM,QAAQ;AAEd,eAAe;IACb,OAAO,IAAA,+IAAM,EAAC,IAAI,GAAG;QACnB,SAAQ,CAAe;YACrB,EAAE,iBAAiB,CAAC,OAAO;gBAAE,SAAS;gBAAM,eAAe;YAAK;QAClE;IACF;AACF;AAEO,eAAe,QAAQ,CAAM;IAClC,CAAC,MAAM,IAAI,EAAE,GAAG,CAAC,OAAO;QAAE,GAAG,CAAC;QAAE,YAAY,KAAK,GAAG;IAAG;AACzD;AAEO,eAAe,MAAM,KAAmC;IAC7D,MAAM,IAAI,MAAM;IAChB,MAAM,KAAK,EAAE,WAAW,CAAC,OAAO;IAChC,MAAM,IAAI,GAAG,KAAK;IAClB,IAAI,IAAI,MAAM,EAAE,UAAU;IAC1B,MAAO,EAAG;QACR,MAAM,KAAK,MAAM,MAAM,EAAE,KAAK;QAC9B,IAAI,IAAI,MAAM,EAAE,MAAM;QACtB,IAAI,MAAM,EAAE,QAAQ;IACtB;IACA,MAAM,GAAG,IAAI;AACf","debugId":null}},
    {"offset": {"line": 1648, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/hooks/useLiveTracking.ts"],"sourcesContent":["\"use client\";\n\nimport { useCallback, useEffect, useRef } from \"react\";\nimport { postPing, RecommendationResponse } from \"@/lib/api-client\";\nimport { useTrackingStore, type TrackingFix } from \"@/lib/tracking/store\";\nimport { enqueue } from \"@/lib/offline-queue\";\nimport { toast } from \"sonner\";\n\nconst MIN_DISTANCE_DELTA = 30; // meters\nconst MIN_INTERVAL_MS = 5000;\nconst GOOD_ACCURACY_THRESHOLD = 150;\nconst RELAXED_ACCURACY_THRESHOLD = 300;\nconst MAX_ACCURACY_METERS = 250;\nconst ACCURACY_IMPROVEMENT_FACTOR = 0.5;\n\nexport type CurrentLocation = {\n  lat: number;\n  lon: number;\n  accuracy_m: number | null;\n  ts: number;\n};\n\ntype GeoPermissionDescriptor = { name: \"geolocation\" };\n\ntype UseLiveTrackingOptions = {\n  onFirstFix?: (loc: CurrentLocation) => void;\n};\n\nexport function useLiveTracking(opts?: UseLiveTrackingOptions) {\n  const trackingOn = useTrackingStore((s) => s.trackingOn);\n  const permissionStatus = useTrackingStore((s) => s.permissionStatus);\n  const lastFix = useTrackingStore((s) => s.lastFix);\n  const lastPingAt = useTrackingStore((s) => s.lastPingAt);\n  const lastRecommendation = useTrackingStore((s) => s.lastRecommendation);\n  const error = useTrackingStore((s) => s.error);\n  const autoStartPending = useTrackingStore((s) => s.autoStartPending);\n  const allowLowAccuracy = useTrackingStore((s) => s.allowLowAccuracy);\n  const setTrackingOn = useTrackingStore((s) => s.setTrackingOn);\n  const setPermissionStatus = useTrackingStore((s) => s.setPermissionStatus);\n  const setLastFix = useTrackingStore((s) => s.setLastFix);\n  const setLastPingAt = useTrackingStore((s) => s.setLastPingAt);\n  const setRecommendation = useTrackingStore((s) => s.setRecommendation);\n  const setError = useTrackingStore((s) => s.setError);\n  const setAutoStartPending = useTrackingStore((s) => s.setAutoStartPending);\n  const setAllowLowAccuracy = useTrackingStore((s) => s.setAllowLowAccuracy);\n  const watchId = useRef<number | null>(null);\n  const lastSentTimestamp = useRef<number>(0);\n  const lastBroadcastPosition = useRef<GeolocationPosition | null>(null);\n  const lastGoodFixRef = useRef<TrackingFix | null>(null);\n  const onFirstFix = opts?.onFirstFix;\n\n  const updatePermissionFromNavigator = useCallback(async () => {\n    try {\n      if (navigator.permissions?.query) {\n        const result = await navigator.permissions.query(\n          { name: \"geolocation\" } as PermissionDescriptor & GeoPermissionDescriptor\n        );\n        setPermissionStatus(result.state);\n        result.onchange = () => setPermissionStatus(result.state);\n      } else {\n        setPermissionStatus(\"unsupported\");\n      }\n    } catch (err) {\n      console.warn(\"permission query failed\", err);\n      setPermissionStatus(\"unsupported\");\n    }\n  }, [setPermissionStatus]);\n\n  useEffect(() => {\n    updatePermissionFromNavigator();\n  }, [updatePermissionFromNavigator]);\n\n  const stopWatch = useCallback(() => {\n    if (watchId.current !== null && typeof navigator !== \"undefined\" && navigator.geolocation) {\n      navigator.geolocation.clearWatch(watchId.current);\n      watchId.current = null;\n    }\n  }, []);\n\n  const handlePingSuccess = useCallback(\n    (recommendation: RecommendationResponse | null, timestampIso: string) => {\n      setLastPingAt(timestampIso);\n      if (recommendation) {\n        setRecommendation(recommendation);\n      }\n      setError(null);\n    },\n    [setLastPingAt, setRecommendation, setError]\n  );\n\n  const sendPing = useCallback(\n    async (position: GeolocationPosition) => {\n      const accuracy =\n        typeof position.coords.accuracy === \"number\" && Number.isFinite(position.coords.accuracy)\n          ? position.coords.accuracy\n          : null;\n\n      const speedKmh =\n        typeof position.coords.speed === \"number\" && Number.isFinite(position.coords.speed)\n          ? position.coords.speed * 3.6\n          : null;\n\n      const fix: TrackingFix = {\n        lat: position.coords.latitude,\n        lon: position.coords.longitude,\n        accuracy,\n        speed: speedKmh,\n        timestamp: position.timestamp,\n      };\n\n      setLastFix(fix);\n\n      const accuracyAcceptable =\n        accuracy !== null && accuracy <= MAX_ACCURACY_METERS;\n\n      if (!accuracyAcceptable) {\n        setError(\"GPS accuracy is weak (>250m). Move outdoors for a clear fix.\");\n        return;\n      }\n\n      setError(null);\n\n      const now = Date.now();\n      const last = lastBroadcastPosition.current;\n      let accuracyImproved = false;\n      if (\n        last &&\n        typeof last.coords.accuracy === \"number\" &&\n        Number.isFinite(last.coords.accuracy)\n      ) {\n        accuracyImproved =\n          typeof accuracy === \"number\" &&\n          accuracy <= last.coords.accuracy * ACCURACY_IMPROVEMENT_FACTOR;\n      }\n\n      if (\n        last &&\n        distanceMeters(last.coords, position.coords) < MIN_DISTANCE_DELTA &&\n        now - lastSentTimestamp.current < MIN_INTERVAL_MS &&\n        !accuracyImproved\n      ) {\n        return;\n      }\n\n      lastBroadcastPosition.current = position;\n      lastSentTimestamp.current = now;\n\n      const payload = {\n        lat: position.coords.latitude,\n        lon: position.coords.longitude,\n        ts: new Date(position.timestamp).toISOString(),\n        accuracy_m: accuracy,\n        speed_kmh: speedKmh ?? undefined,\n      };\n\n      const { data, error } = await postPing(payload);\n      if (error) {\n        setError(error.message);\n        await enqueue(payload);\n        toast.error(\"Could not sync live location. We'll retry soon.\");\n        return;\n      }\n\n      handlePingSuccess(data?.recommendation ?? null, payload.ts ?? new Date().toISOString());\n    },\n    [setLastFix, handlePingSuccess, setError]\n  );\n\n  const requestPermission = useCallback(async () => {\n    try {\n      const { state } = await navigator.permissions.query(\n        { name: \"geolocation\" } as PermissionDescriptor & GeoPermissionDescriptor\n      );\n      setPermissionStatus(state);\n      if (state === \"denied\") {\n        toast.error(\"Location permission denied. Enable it in browser settings.\");\n        return false;\n      }\n      if (state === \"prompt\") {\n        await new Promise<GeolocationPosition>((resolve, reject) => {\n          navigator.geolocation.getCurrentPosition(resolve, reject, {\n            enableHighAccuracy: true,\n            timeout: 15000,\n            maximumAge: 0,\n          });\n        });\n        setPermissionStatus(\"granted\");\n      }\n      return true;\n    } catch (error) {\n      console.error(\"permission request failed\", error);\n      setPermissionStatus(\"unsupported\");\n      return false;\n    }\n  }, [setPermissionStatus]);\n\n  const stopTracking = useCallback(() => {\n    stopWatch();\n    setTrackingOn(false);\n  }, [stopWatch, setTrackingOn]);\n\n  const startTracking = useCallback(async () => {\n    if (trackingOn) return true;\n    const granted = await requestPermission();\n    if (!granted) {\n      setError(\"Location permission required for live tracking\");\n      return false;\n    }\n    setTrackingOn(true);\n    return true;\n  }, [trackingOn, requestPermission, setTrackingOn, setError]);\n\n  const toggleTracking = useCallback(async () => {\n    if (trackingOn) {\n      stopTracking();\n      return;\n    }\n    await startTracking();\n  }, [trackingOn, startTracking, stopTracking]);\n\n  useEffect(() => {\n    if (!trackingOn && autoStartPending) {\n      void startTracking();\n      setAutoStartPending(false);\n    }\n  }, [trackingOn, autoStartPending, startTracking, setAutoStartPending]);\n\n  useEffect(() => {\n    if (!trackingOn) {\n      stopWatch();\n      return;\n    }\n\n    if (typeof navigator === \"undefined\" || !navigator.geolocation) {\n      setError(\"Geolocation is not supported in this browser.\");\n      toast.error(\"Geolocation is not available on this device.\");\n      setTrackingOn(false);\n      return;\n    }\n\n    watchId.current = navigator.geolocation.watchPosition(\n      (pos) => sendPing(pos),\n      (err) => {\n        console.error(\"watchPosition error\", err);\n        const friendly = describeGeoError(err);\n        setError(friendly);\n        if (err.code === err.PERMISSION_DENIED) {\n          setTrackingOn(false);\n          setPermissionStatus(\"denied\");\n          toast.error(\"Permission denied. Please re-enable location access.\");\n        } else {\n          toast.error(friendly);\n        }\n      },\n      {\n        enableHighAccuracy: true,\n        maximumAge: 0,\n        timeout: 15000,\n      }\n    );\n\n    return () => stopWatch();\n  }, [trackingOn, sendPing, stopWatch, setError, setTrackingOn, setPermissionStatus]);\n\n  useEffect(() => {\n    function handleOnline() {\n      setError(null);\n    }\n    window.addEventListener(\"online\", handleOnline);\n    return () => window.removeEventListener(\"online\", handleOnline);\n  }, [setError]);\n\n  const accuracyThreshold = allowLowAccuracy\n    ? RELAXED_ACCURACY_THRESHOLD\n    : GOOD_ACCURACY_THRESHOLD;\n\n  if (!trackingOn) {\n    lastGoodFixRef.current = null;\n  } else {\n    const fixAccuracy =\n      lastFix && typeof lastFix.accuracy === \"number\" && Number.isFinite(lastFix.accuracy)\n        ? lastFix.accuracy\n        : null;\n    if (lastFix && fixAccuracy !== null && fixAccuracy <= accuracyThreshold) {\n      lastGoodFixRef.current = lastFix;\n    } else if (\n      lastGoodFixRef.current &&\n      typeof lastGoodFixRef.current.accuracy === \"number\" &&\n      lastGoodFixRef.current.accuracy > accuracyThreshold\n    ) {\n      lastGoodFixRef.current = null;\n    }\n  }\n\n  const currentLocSource = lastGoodFixRef.current ?? lastFix;\n  const currentLoc: CurrentLocation | null = currentLocSource\n    ? {\n        lat: currentLocSource.lat,\n        lon: currentLocSource.lon,\n        accuracy_m:\n          typeof currentLocSource.accuracy === \"number\" &&\n          Number.isFinite(currentLocSource.accuracy)\n            ? currentLocSource.accuracy\n            : null,\n        ts: currentLocSource.timestamp,\n      }\n    : null;\n\n  const hasLocation = Boolean(lastGoodFixRef.current);\n  const lastGoodFixAt = lastGoodFixRef.current?.timestamp ?? null;\n  const isFetchingLocation = trackingOn && !hasLocation;\n\n  const prevHasLocationRef = useRef(false);\n\n  useEffect(() => {\n    const prev = prevHasLocationRef.current;\n    if (!prev && hasLocation && currentLoc) {\n      onFirstFix?.(currentLoc);\n      try {\n        window.dispatchEvent(new CustomEvent(\"liveTracking:firstFix\", { detail: currentLoc }));\n      } catch {\n        // no-op if CustomEvent unavailable\n      }\n    }\n    prevHasLocationRef.current = hasLocation;\n  }, [hasLocation, currentLoc, onFirstFix]);\n\n  return {\n    trackingOn,\n    permissionStatus,\n    lastFix,\n    lastPingAt,\n    lastRecommendation,\n    error,\n    currentLoc,\n    lastGoodFixAt,\n    toggleTracking,\n    startTracking,\n    stopTracking,\n    hasLocation,\n    isFetchingLocation,\n    allowLowAccuracy,\n    setAllowLowAccuracy,\n  };\n}\n\nfunction distanceMeters(a: GeolocationCoordinates, b: GeolocationCoordinates) {\n  const R = 6371e3;\n  const lat1 = (a.latitude * Math.PI) / 180;\n  const lat2 = (b.latitude * Math.PI) / 180;\n  const deltaLat = lat2 - lat1;\n  const deltaLon = ((b.longitude - a.longitude) * Math.PI) / 180;\n  const x =\n    Math.sin(deltaLat / 2) * Math.sin(deltaLat / 2) +\n    Math.cos(lat1) * Math.cos(lat2) * Math.sin(deltaLon / 2) * Math.sin(deltaLon / 2);\n  const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));\n  return R * c;\n}\n\nfunction describeGeoError(err: GeolocationPositionError) {\n  switch (err.code) {\n    case err.PERMISSION_DENIED:\n      return \"Location permission denied. Enable it in your browser settings.\";\n    case err.POSITION_UNAVAILABLE:\n      return \"GPS signal unavailable. Move outdoors for a clear view of the sky.\";\n    case err.TIMEOUT:\n      return \"Timed out while waiting for GPS. Try again from an open area.\";\n    default:\n      return err.message || \"Unable to determine your location.\";\n  }\n}\n"],"names":[],"mappings":"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","debugId":null}},
    {"offset": {"line": 1981, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/hooks/useDriverProfile.ts"],"sourcesContent":["\"use client\";\n\nimport { useEffect, useState } from \"react\";\nimport { createBrowserSupabaseClient } from \"@/lib/supabase/client\";\n\nconst supabase = createBrowserSupabaseClient();\n\nexport function useDriverProfile() {\n  const [profile, setProfile] = useState<{ id: string; full_name: string | null } | null>(null);\n\n  useEffect(() => {\n    let active = true;\n    async function load() {\n      const {\n        data: { user },\n      } = await supabase.auth.getUser();\n      if (!user) return;\n      const { data } = await supabase\n        .from(\"profiles\")\n        .select(\"id,full_name\")\n        .eq(\"id\", user.id)\n        .maybeSingle();\n      if (!active) return;\n      setProfile({ id: user.id, full_name: data?.full_name ?? user.user_metadata?.full_name ?? null });\n    }\n    load();\n    return () => {\n      active = false;\n    };\n  }, []);\n\n  return profile;\n}\n"],"names":[],"mappings":";;;;AAEA;AACA;AAHA;;;AAKA,MAAM,WAAW,IAAA,wJAA2B;AAErC,SAAS;IACd,MAAM,CAAC,SAAS,WAAW,GAAG,IAAA,iNAAQ,EAAkD;IAExF,IAAA,kNAAS,EAAC;QACR,IAAI,SAAS;QACb,eAAe;YACb,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACf,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;YAC/B,IAAI,CAAC,MAAM;YACX,MAAM,EAAE,IAAI,EAAE,GAAG,MAAM,SACpB,IAAI,CAAC,YACL,MAAM,CAAC,gBACP,EAAE,CAAC,MAAM,KAAK,EAAE,EAChB,WAAW;YACd,IAAI,CAAC,QAAQ;YACb,WAAW;gBAAE,IAAI,KAAK,EAAE;gBAAE,WAAW,MAAM,aAAa,KAAK,aAAa,EAAE,aAAa;YAAK;QAChG;QACA;QACA,OAAO;YACL,SAAS;QACX;IACF,GAAG,EAAE;IAEL,OAAO;AACT","debugId":null}},
    {"offset": {"line": 2016, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/app/%28driver%29/DriverHomeClient.tsx"],"sourcesContent":["\"use client\";\n\nimport { DriverShell } from \"@/components/layout/DriverShell\";\nimport { TrackingToggle } from \"@/components/TrackingToggle\";\nimport { LiveStatusChip } from \"@/components/LiveStatusChip\";\nimport { NextZonesPanel } from \"@/components/NextZonesPanel\";\nimport { TrafficPreviewMap } from \"@/components/TrafficPreviewMap\";\nimport { RideControls } from \"@/components/RideControls\";\nimport { GpsAccuracyBadge } from \"@/components/GpsAccuracyBadge\";\nimport { useLiveTracking } from \"@/hooks/useLiveTracking\";\nimport { useDriverProfile } from \"@/lib/hooks/useDriverProfile\";\nimport { useTodayStats } from \"@/lib/hooks/useTodayStats\";\n\nexport default function DriverHomeClient() {\n  const tracking = useLiveTracking();\n  const profile = useDriverProfile();\n  const { stats } = useTodayStats();\n\n  const greeting = profile?.full_name ? `Hi, ${profile.full_name.split(\" \")[0]}` : \"Hi driver\";\n  const subtitle = `Today | ${stats.totalTrips} trips | ?${stats.totalEarnings.toFixed(0)}`;\n\n  const gpsReady = tracking.hasLocation;\n  const waitingForGps = tracking.isFetchingLocation;\n\n  return (\n    <DriverShell title={greeting} subtitle={subtitle}>\n      <div className=\"space-y-6\">\n        <div className=\"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between\">\n          {/* <TrackingToggle\n            trackingOn={tracking.trackingOn}\n            permissionStatus={tracking.permissionStatus}\n            toggleTracking={tracking.toggleTracking}\n            error={tracking.error}\n          /> */}\n          <div className=\"flex flex-col items-start gap-2 sm:items-end\">\n            {/* <LiveStatusChip\n              trackingOn={tracking.trackingOn}\n              lastPingAt={tracking.lastPingAt}\n              permissionStatus={tracking.permissionStatus}\n            /> */}\n            <GpsAccuracyBadge\n              trackingOn={tracking.trackingOn}\n              accuracy={tracking.lastFix?.accuracy ?? null}\n            />\n            {waitingForGps && (\n              <div className=\"text-xs text-amber-600\">\n                Acquiring GPS fix...\n              </div>\n            )}\n          </div>\n        </div>\n\n        <NextZonesPanel\n          trackingOn={tracking.trackingOn}\n          hasLocation={tracking.hasLocation}\n          isFetchingLocation={tracking.isFetchingLocation}\n          currentLoc={tracking.currentLoc}\n          seedRecommendation={tracking.lastRecommendation}\n          allowLowAccuracy={tracking.allowLowAccuracy}\n          onAllowLowAccuracy={() => tracking.setAllowLowAccuracy(true)}\n        />\n\n        {/* <TrafficPreviewMap\n          currentLocation={tracking.lastFix}\n          recommendedZones={tracking.lastRecommendation?.top ?? null}\n        /> */}\n\n        <section className=\"space-y-3\">\n          <h2 className=\"text-lg font-semibold\">Ride actions</h2>\n          <RideControls lastFix={tracking.lastFix} />\n        </section>\n      </div>\n    </DriverShell>\n  );\n}\n"],"names":[],"mappings":";;;;;AAEA;AAGA;AAEA;AACA;AACA;AACA;AACA;AAXA;;;;;;;;;AAae,SAAS;IACtB,MAAM,WAAW,IAAA,2IAAe;IAChC,MAAM,UAAU,IAAA,oJAAgB;IAChC,MAAM,EAAE,KAAK,EAAE,GAAG,IAAA,8IAAa;IAE/B,MAAM,WAAW,SAAS,YAAY,CAAC,IAAI,EAAE,QAAQ,SAAS,CAAC,KAAK,CAAC,IAAI,CAAC,EAAE,EAAE,GAAG;IACjF,MAAM,WAAW,CAAC,QAAQ,EAAE,MAAM,UAAU,CAAC,UAAU,EAAE,MAAM,aAAa,CAAC,OAAO,CAAC,IAAI;IAEzF,MAAM,WAAW,SAAS,WAAW;IACrC,MAAM,gBAAgB,SAAS,kBAAkB;IAEjD,qBACE,8OAAC,mJAAW;QAAC,OAAO;QAAU,UAAU;kBACtC,cAAA,8OAAC;YAAI,WAAU;;8BACb,8OAAC;oBAAI,WAAU;8BAOb,cAAA,8OAAC;wBAAI,WAAU;;0CAMb,8OAAC,mJAAgB;gCACf,YAAY,SAAS,UAAU;gCAC/B,UAAU,SAAS,OAAO,EAAE,YAAY;;;;;;4BAEzC,+BACC,8OAAC;gCAAI,WAAU;0CAAyB;;;;;;;;;;;;;;;;;8BAO9C,8OAAC,+IAAc;oBACb,YAAY,SAAS,UAAU;oBAC/B,aAAa,SAAS,WAAW;oBACjC,oBAAoB,SAAS,kBAAkB;oBAC/C,YAAY,SAAS,UAAU;oBAC/B,oBAAoB,SAAS,kBAAkB;oBAC/C,kBAAkB,SAAS,gBAAgB;oBAC3C,oBAAoB,IAAM,SAAS,mBAAmB,CAAC;;;;;;8BAQzD,8OAAC;oBAAQ,WAAU;;sCACjB,8OAAC;4BAAG,WAAU;sCAAwB;;;;;;sCACtC,8OAAC,2IAAY;4BAAC,SAAS,SAAS,OAAO;;;;;;;;;;;;;;;;;;;;;;;AAKjD","debugId":null}}]
}