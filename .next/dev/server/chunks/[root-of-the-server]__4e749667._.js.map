{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/supabase/config.ts"],"sourcesContent":["const isServer = () => typeof window === \"undefined\";\n\n/**\n * Next.js only inlines environment variables when they are referenced with static keys.\n * Avoid dynamic lookups (e.g. process.env[key]) because they are stripped from the client bundle\n * and will always be undefined in the browser.\n */\nexport function getSupabaseConfig() {\n  const serverUrl = process.env.SUPABASE_URL || process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const serverAnonKey =\n    process.env.SUPABASE_ANON_KEY || process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  const url = isServer() ? serverUrl : process.env.NEXT_PUBLIC_SUPABASE_URL;\n  const anonKey = isServer() ? serverAnonKey : process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\n  if (!url) {\n    throw new Error(\"Missing SUPABASE_URL/NEXT_PUBLIC_SUPABASE_URL environment variable\");\n  }\n  if (!anonKey) {\n    throw new Error(\"Missing SUPABASE_ANON_KEY/NEXT_PUBLIC_SUPABASE_ANON_KEY environment variable\");\n  }\n\n  return { url, anonKey };\n}\n"],"names":[],"mappings":";;;;AAAA,MAAM,WAAW,IAAM,kDAAkB;AAOlC,SAAS;IACd,MAAM,YAAY,QAAQ,GAAG,CAAC,YAAY;IAC1C,MAAM,gBACJ,QAAQ,GAAG,CAAC,iBAAiB;IAE/B,MAAM,MAAM,aAAa,YAAY;IACrC,MAAM,UAAU,aAAa,gBAAgB;IAE7C;;IAGA;;IAIA,OAAO;QAAE;QAAK;IAAQ;AACxB","debugId":null}},
    {"offset": {"line": 69, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/supabase/server.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport type { SupabaseClient, User as SupabaseUser } from \"@supabase/supabase-js\";\nimport { cookies } from \"next/headers\";\nimport { getSupabaseConfig } from \"./config\";\nimport type { AppUser, DriverProfile } from \"./types\";\n\nexport type { AppUser, DriverProfile } from \"./types\";\n\nfunction mapUser(user: SupabaseUser | null): AppUser | null {\n  if (!user) return null;\n  return {\n    id: user.id,\n    email: user.email ?? null,\n    fullName: (user.user_metadata as Record<string, any> | null)?.full_name ?? null,\n  };\n}\n\nexport async function createServerSupabaseClient() {\n  const { url, anonKey } = getSupabaseConfig();\n  const cookieStore = await cookies();\n\n  const supabase = createServerClient(url, anonKey, {\n    cookies: {\n      get(name: string) {\n        return cookieStore.get(name)?.value;\n      },\n      set(name: string, value: string, options: any) {\n        const mutableStore = cookieStore as unknown as {\n          set?: (options: { name: string; value: string } & Record<string, any>) => void;\n        };\n        mutableStore.set?.({ name, value, ...options });\n      },\n      remove(name: string, options: any) {\n        const mutableStore = cookieStore as unknown as {\n          set?: (options: { name: string; value: string } & Record<string, any>) => void;\n        };\n        mutableStore.set?.({ name, value: \"\", ...options, maxAge: 0 });\n      },\n    },\n  });\n\n  const {\n    data: { user },\n    error,\n  } = await supabase.auth.getUser();\n\n  if (error && error.message !== \"Auth session missing!\") {\n    console.warn(\"[supabase] auth.getUser failed\", error);\n  }\n\n  return {\n    supabase,\n    user: mapUser(user),\n  };\n}\n\nexport async function loadProfile(supabase: SupabaseClient, userId: string) {\n  const { data, error } = await supabase\n    .from(\"profiles\")\n    .select(\"id,full_name,created_at\")\n    .eq(\"id\", userId)\n    .maybeSingle();\n\n  if (error && error.code !== \"PGRST116\") {\n    console.warn(\"[supabase] failed to load profile\", { userId, error });\n    return null;\n  }\n\n  return (data ?? null) as DriverProfile | null;\n}\n"],"names":[],"mappings":";;;;;;AAAA;AAAA;AAEA;AACA;;;;AAKA,SAAS,QAAQ,IAAyB;IACxC,IAAI,CAAC,MAAM,OAAO;IAClB,OAAO;QACL,IAAI,KAAK,EAAE;QACX,OAAO,KAAK,KAAK,IAAI;QACrB,UAAU,AAAC,KAAK,aAAa,EAAiC,aAAa;IAC7E;AACF;AAEO,eAAe;IACpB,MAAM,EAAE,GAAG,EAAE,OAAO,EAAE,GAAG,IAAA,gJAAiB;IAC1C,MAAM,cAAc,MAAM,IAAA,4IAAO;IAEjC,MAAM,WAAW,IAAA,iMAAkB,EAAC,KAAK,SAAS;QAChD,SAAS;YACP,KAAI,IAAY;gBACd,OAAO,YAAY,GAAG,CAAC,OAAO;YAChC;YACA,KAAI,IAAY,EAAE,KAAa,EAAE,OAAY;gBAC3C,MAAM,eAAe;gBAGrB,aAAa,GAAG,GAAG;oBAAE;oBAAM;oBAAO,GAAG,OAAO;gBAAC;YAC/C;YACA,QAAO,IAAY,EAAE,OAAY;gBAC/B,MAAM,eAAe;gBAGrB,aAAa,GAAG,GAAG;oBAAE;oBAAM,OAAO;oBAAI,GAAG,OAAO;oBAAE,QAAQ;gBAAE;YAC9D;QACF;IACF;IAEA,MAAM,EACJ,MAAM,EAAE,IAAI,EAAE,EACd,KAAK,EACN,GAAG,MAAM,SAAS,IAAI,CAAC,OAAO;IAE/B,IAAI,SAAS,MAAM,OAAO,KAAK,yBAAyB;QACtD,QAAQ,IAAI,CAAC,kCAAkC;IACjD;IAEA,OAAO;QACL;QACA,MAAM,QAAQ;IAChB;AACF;AAEO,eAAe,YAAY,QAAwB,EAAE,MAAc;IACxE,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,YACL,MAAM,CAAC,2BACP,EAAE,CAAC,MAAM,QACT,WAAW;IAEd,IAAI,SAAS,MAAM,IAAI,KAAK,YAAY;QACtC,QAAQ,IAAI,CAAC,qCAAqC;YAAE;YAAQ;QAAM;QAClE,OAAO;IACT;IAEA,OAAQ,QAAQ;AAClB","debugId":null}},
    {"offset": {"line": 141, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/lib/server/geo-utils.ts"],"sourcesContent":["/**\n * Server-side geospatial utilities for Patna EV Co-Pilot\n * All geographic calculations for recommendations and distance estimation\n */\n\n/**\n * Geometry point returned by Supabase/PostGIS. Coordinates array is [lon, lat].\n * See https://supabase.com/docs/guides/database/extensions/postgis#geography-geometric-objects\n */\nexport type GeoJsonPoint = {\n  type: \"Point\";\n  coordinates: [number, number];\n  crs?: { type: string; properties: Record<string, any> };\n};\n\n/**\n * Convert GeoJSON point to lat/lon pair.\n */\nexport function latLonFromPoint(\n  point: GeoJsonPoint | null | undefined\n): { lat: number | null; lon: number | null } {\n  if (!point || !Array.isArray(point.coordinates)) {\n    return { lat: null, lon: null };\n  }\n  const [lon, lat] = point.coordinates ?? [];\n  if (!Number.isFinite(lat) || !Number.isFinite(lon)) {\n    return { lat: null, lon: null };\n  }\n  return { lat, lon };\n}\n\n/**\n * Build a GeoJSON Point payload for inserting/updating geography columns.\n */\nexport function pointFromLatLon(lat: number, lon: number): GeoJsonPoint {\n  return {\n    type: \"Point\",\n    coordinates: [lon, lat],\n  };\n}\n\n/**\n * Calculate Haversine distance between two points in meters\n */\nexport function haversineDistance(\r\n  lat1: number,\r\n  lon1: number,\r\n  lat2: number,\r\n  lon2: number\r\n): number {\r\n  const R = 6371e3; // Earth's radius in meters\r\n  const φ1 = (lat1 * Math.PI) / 180;\r\n  const φ2 = (lat2 * Math.PI) / 180;\r\n  const Δφ = ((lat2 - lat1) * Math.PI) / 180;\r\n  const Δλ = ((lon2 - lon1) * Math.PI) / 180;\r\n\r\n  const a =\r\n    Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +\r\n    Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);\r\n\r\n  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\r\n\r\n  return R * c; // Distance in meters\r\n}\r\n\r\n/**\r\n * Calculate distance in kilometers\r\n */\r\nexport function distanceKm(\r\n  lat1: number,\r\n  lon1: number,\r\n  lat2: number,\r\n  lon2: number\r\n): number {\r\n  return haversineDistance(lat1, lon1, lat2, lon2) / 1000;\r\n}\r\n\r\n/**\r\n * Estimate travel time in minutes based on distance and average speed\r\n * Applies Patna-specific road biases:\r\n * - Urban areas: ~15 km/h average (heavy traffic, narrow roads)\r\n * - Highway corridors: ~30 km/h average\r\n * - Short distances (<2km): add 3 min penalty for navigation/turns\r\n */\r\nexport function estimateETA(\r\n  distanceMeters: number,\r\n  currentSpeedKmh?: number | null\r\n): number {\r\n  const distanceKm = distanceMeters / 1000;\r\n\r\n  // Use current speed if available and reasonable (5-60 km/h)\r\n  let avgSpeed = 15; // Default urban speed\r\n  if (currentSpeedKmh && currentSpeedKmh >= 5 && currentSpeedKmh <= 60) {\r\n    avgSpeed = currentSpeedKmh;\r\n  } else if (distanceKm > 5) {\r\n    // Longer distances likely use better roads\r\n    avgSpeed = 25;\r\n  }\r\n\r\n  let etaMinutes = (distanceKm / avgSpeed) * 60;\r\n\r\n  // Add navigation penalty for short trips\r\n  if (distanceKm < 2) {\r\n    etaMinutes += 3;\r\n  }\r\n\r\n  return Math.ceil(etaMinutes);\r\n}\r\n\r\n/**\r\n * Validate latitude is within valid range\r\n */\r\nexport function isValidLatitude(lat: number): boolean {\r\n  return lat >= -90 && lat <= 90;\r\n}\r\n\r\n/**\r\n * Validate longitude is within valid range\r\n */\r\nexport function isValidLongitude(lon: number): boolean {\r\n  return lon >= -180 && lon <= 180;\r\n}\r\n\r\n/**\r\n * Validate coordinates are within Patna's approximate bounds\r\n * Patna roughly: 25.3°-25.8°N, 84.9°-85.4°E\r\n * Using generous bounds to allow some flexibility\r\n */\r\nexport function isWithinPatnaBounds(lat: number, lon: number): boolean {\r\n  return lat >= 25.0 && lat <= 26.0 && lon >= 84.5 && lon <= 85.8;\r\n}\r\n\r\n/**\r\n * Get current 30-minute time bucket\r\n * Returns format: \"HH:00\" or \"HH:30\"\r\n */\r\nexport function getCurrentBucket30m(): string {\r\n  const now = new Date();\r\n  const hour = String(now.getHours()).padStart(2, \"0\");\r\n  const minutes = now.getMinutes() < 30 ? \"00\" : \"30\";\r\n  return `${hour}:${minutes}`;\r\n}\r\n\r\n/**\r\n * Get hour of day (0-23)\r\n */\r\nexport function getCurrentHour(): number {\r\n  return new Date().getHours();\r\n}\r\n\r\n/**\r\n * Get day of week (0=Sunday, 6=Saturday)\r\n */\r\nexport function getCurrentDayOfWeek(): number {\r\n  return new Date().getDay();\r\n}\r\n\r\n/**\r\n * Format coordinates for logging (truncated to 4 decimal places)\r\n */\r\nexport function formatCoords(lat: number, lon: number): string {\r\n  return `${lat.toFixed(4)},${lon.toFixed(4)}`;\r\n}\r\n"],"names":[],"mappings":"AAAA;;;CAGC,GAED;;;CAGC;;;;;;;;;;;;;;;;;;;;;;;;;;AAUM,SAAS,gBACd,KAAsC;IAEtC,IAAI,CAAC,SAAS,CAAC,MAAM,OAAO,CAAC,MAAM,WAAW,GAAG;QAC/C,OAAO;YAAE,KAAK;YAAM,KAAK;QAAK;IAChC;IACA,MAAM,CAAC,KAAK,IAAI,GAAG,MAAM,WAAW,IAAI,EAAE;IAC1C,IAAI,CAAC,OAAO,QAAQ,CAAC,QAAQ,CAAC,OAAO,QAAQ,CAAC,MAAM;QAClD,OAAO;YAAE,KAAK;YAAM,KAAK;QAAK;IAChC;IACA,OAAO;QAAE;QAAK;IAAI;AACpB;AAKO,SAAS,gBAAgB,GAAW,EAAE,GAAW;IACtD,OAAO;QACL,MAAM;QACN,aAAa;YAAC;YAAK;SAAI;IACzB;AACF;AAKO,SAAS,kBACd,IAAY,EACZ,IAAY,EACZ,IAAY,EACZ,IAAY;IAEZ,MAAM,IAAI,QAAQ,2BAA2B;IAC7C,MAAM,KAAK,AAAC,OAAO,KAAK,EAAE,GAAI;IAC9B,MAAM,KAAK,AAAC,OAAO,KAAK,EAAE,GAAI;IAC9B,MAAM,KAAK,AAAC,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAI;IACvC,MAAM,KAAK,AAAC,CAAC,OAAO,IAAI,IAAI,KAAK,EAAE,GAAI;IAEvC,MAAM,IACJ,KAAK,GAAG,CAAC,KAAK,KAAK,KAAK,GAAG,CAAC,KAAK,KACjC,KAAK,GAAG,CAAC,MAAM,KAAK,GAAG,CAAC,MAAM,KAAK,GAAG,CAAC,KAAK,KAAK,KAAK,GAAG,CAAC,KAAK;IAEjE,MAAM,IAAI,IAAI,KAAK,KAAK,CAAC,KAAK,IAAI,CAAC,IAAI,KAAK,IAAI,CAAC,IAAI;IAErD,OAAO,IAAI,GAAG,qBAAqB;AACrC;AAKO,SAAS,WACd,IAAY,EACZ,IAAY,EACZ,IAAY,EACZ,IAAY;IAEZ,OAAO,kBAAkB,MAAM,MAAM,MAAM,QAAQ;AACrD;AASO,SAAS,YACd,cAAsB,EACtB,eAA+B;IAE/B,MAAM,aAAa,iBAAiB;IAEpC,4DAA4D;IAC5D,IAAI,WAAW,IAAI,sBAAsB;IACzC,IAAI,mBAAmB,mBAAmB,KAAK,mBAAmB,IAAI;QACpE,WAAW;IACb,OAAO,IAAI,aAAa,GAAG;QACzB,2CAA2C;QAC3C,WAAW;IACb;IAEA,IAAI,aAAa,AAAC,aAAa,WAAY;IAE3C,yCAAyC;IACzC,IAAI,aAAa,GAAG;QAClB,cAAc;IAChB;IAEA,OAAO,KAAK,IAAI,CAAC;AACnB;AAKO,SAAS,gBAAgB,GAAW;IACzC,OAAO,OAAO,CAAC,MAAM,OAAO;AAC9B;AAKO,SAAS,iBAAiB,GAAW;IAC1C,OAAO,OAAO,CAAC,OAAO,OAAO;AAC/B;AAOO,SAAS,oBAAoB,GAAW,EAAE,GAAW;IAC1D,OAAO,OAAO,QAAQ,OAAO,QAAQ,OAAO,QAAQ,OAAO;AAC7D;AAMO,SAAS;IACd,MAAM,MAAM,IAAI;IAChB,MAAM,OAAO,OAAO,IAAI,QAAQ,IAAI,QAAQ,CAAC,GAAG;IAChD,MAAM,UAAU,IAAI,UAAU,KAAK,KAAK,OAAO;IAC/C,OAAO,GAAG,KAAK,CAAC,EAAE,SAAS;AAC7B;AAKO,SAAS;IACd,OAAO,IAAI,OAAO,QAAQ;AAC5B;AAKO,SAAS;IACd,OAAO,IAAI,OAAO,MAAM;AAC1B;AAKO,SAAS,aAAa,GAAW,EAAE,GAAW;IACnD,OAAO,GAAG,IAAI,OAAO,CAAC,GAAG,CAAC,EAAE,IAAI,OAAO,CAAC,IAAI;AAC9C","debugId":null}},
    {"offset": {"line": 259, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Lokes/Desktop/projects/whatsnext/app/api/driver-state/route.ts"],"sourcesContent":["import { createServerSupabaseClient } from \"@/lib/supabase/server\";\nimport { GeoJsonPoint, latLonFromPoint } from \"@/lib/server/geo-utils\";\n\ntype DriverStateRow = {\n  driver_id: string;\n  last_ping_at: string | null;\n  loc: GeoJsonPoint | null;\n  snapped_zone: number | null;\n  speed_kmh: number | null;\n  battery_pct: number | null;\n  accuracy_m: number | null;\n  recommendation: Record<string, unknown> | null;\n  updated_at: string | null;\n};\n\nexport async function GET() {\n  try {\n    const { supabase, user } = await createServerSupabaseClient();\n\n    if (!user) {\n      return Response.json(\n        {\n          error: {\n            code: \"UNAUTHENTICATED\",\n            message: \"Please sign in\",\n          },\n        },\n        { status: 401 }\n      );\n    }\n\n    const { data, error } = await supabase\n      .from(\"driver_state\")\n      .select(\n        \"driver_id,last_ping_at,loc,snapped_zone,speed_kmh,battery_pct,accuracy_m,recommendation,updated_at\"\n      )\n      .eq(\"driver_id\", user.id)\n      .maybeSingle();\n\n    if (error) {\n      console.error(\"[driver-state] DB error\", {\n        userId: user.id,\n        error,\n      });\n      return Response.json(\n        {\n          error: {\n            code: \"DB_ERROR\",\n            message: \"Failed to fetch driver state\",\n            details: {\n              code: error.code,\n              message: error.message,\n              details: error.details ?? null,\n              hint: error.hint ?? null,\n            },\n          },\n        },\n        { status: 500 }\n      );\n    }\n\n    if (!data) {\n      return Response.json(\n        {\n          data: null,\n          status: \"NO_STATE\",\n          message: \"No driver_state row found for this user yet\",\n        },\n        { status: 200 }\n      );\n    }\n\n    const row = data as DriverStateRow;\n    const coords = latLonFromPoint(row.loc);\n\n    return Response.json(\n      {\n        data: {\n          driver_id: row.driver_id,\n          last_ping_at: row.last_ping_at,\n          snapped_zone: row.snapped_zone,\n          loc: row.loc,\n          speed_kmh: row.speed_kmh,\n          battery_pct: row.battery_pct,\n          accuracy_m: row.accuracy_m ?? null,\n          recommendation: row.recommendation,\n          updated_at: row.updated_at,\n          coords,\n        },\n      },\n      { status: 200 }\n    );\n  } catch (error) {\n    console.error(\"[driver-state] unexpected failure\", error);\n    return Response.json(\n      {\n        error: {\n          code: \"INTERNAL_ERROR\",\n          message: \"Failed to fetch driver state\",\n        },\n      },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;;;AAcO,eAAe;IACpB,IAAI;QACF,MAAM,EAAE,QAAQ,EAAE,IAAI,EAAE,GAAG,MAAM,IAAA,yJAA0B;QAE3D,IAAI,CAAC,MAAM;YACT,OAAO,SAAS,IAAI,CAClB;gBACE,OAAO;oBACL,MAAM;oBACN,SAAS;gBACX;YACF,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,SAC3B,IAAI,CAAC,gBACL,MAAM,CACL,sGAED,EAAE,CAAC,aAAa,KAAK,EAAE,EACvB,WAAW;QAEd,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,2BAA2B;gBACvC,QAAQ,KAAK,EAAE;gBACf;YACF;YACA,OAAO,SAAS,IAAI,CAClB;gBACE,OAAO;oBACL,MAAM;oBACN,SAAS;oBACT,SAAS;wBACP,MAAM,MAAM,IAAI;wBAChB,SAAS,MAAM,OAAO;wBACtB,SAAS,MAAM,OAAO,IAAI;wBAC1B,MAAM,MAAM,IAAI,IAAI;oBACtB;gBACF;YACF,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,CAAC,MAAM;YACT,OAAO,SAAS,IAAI,CAClB;gBACE,MAAM;gBACN,QAAQ;gBACR,SAAS;YACX,GACA;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,MAAM;QACZ,MAAM,SAAS,IAAA,kJAAe,EAAC,IAAI,GAAG;QAEtC,OAAO,SAAS,IAAI,CAClB;YACE,MAAM;gBACJ,WAAW,IAAI,SAAS;gBACxB,cAAc,IAAI,YAAY;gBAC9B,cAAc,IAAI,YAAY;gBAC9B,KAAK,IAAI,GAAG;gBACZ,WAAW,IAAI,SAAS;gBACxB,aAAa,IAAI,WAAW;gBAC5B,YAAY,IAAI,UAAU,IAAI;gBAC9B,gBAAgB,IAAI,cAAc;gBAClC,YAAY,IAAI,UAAU;gBAC1B;YACF;QACF,GACA;YAAE,QAAQ;QAAI;IAElB,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,qCAAqC;QACnD,OAAO,SAAS,IAAI,CAClB;YACE,OAAO;gBACL,MAAM;gBACN,SAAS;YACX;QACF,GACA;YAAE,QAAQ;QAAI;IAElB;AACF","debugId":null}}]
}