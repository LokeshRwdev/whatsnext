module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,r)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},45620,e=>{"use strict";class t extends Error{code;status;details;constructor(e,t,r,n){super(r),this.status=e,this.code=t,this.details=n}}function r(e,t=200){return Response.json(e,{status:t})}function n(e,t,r=400,a){return Response.json({error:{code:a??(r>=500?"INTERNAL_ERROR":"BAD_REQUEST"),message:e,details:t}},{status:r})}e.s(["HttpError",()=>t,"bad",()=>n,"ok",()=>r])},19063,e=>{"use strict";function t(e){if(!e||!Array.isArray(e.coordinates))return{lat:null,lon:null};let[t,r]=e.coordinates??[];return Number.isFinite(r)&&Number.isFinite(t)?{lat:r,lon:t}:{lat:null,lon:null}}function r(e,t){return{type:"Point",coordinates:[t,e]}}function n(e,t,r,n){let a,i,o,s,l;return a=e*Math.PI/180,i=r*Math.PI/180,2*Math.atan2(Math.sqrt(l=Math.sin((o=(r-e)*Math.PI/180)/2)*Math.sin(o/2)+Math.cos(a)*Math.cos(i)*Math.sin((s=(n-t)*Math.PI/180)/2)*Math.sin(s/2)),Math.sqrt(1-l))*6371e3/1e3}function a(e,t){let r=e/1e3,n=15;t&&t>=5&&t<=60?n=t:r>5&&(n=25);let a=r/n*60;return r<2&&(a+=3),Math.ceil(a)}function i(e){return e>=-90&&e<=90}function o(e){return e>=-180&&e<=180}e.s(["distanceKm",()=>n,"estimateETA",()=>a,"isValidLatitude",()=>i,"isValidLongitude",()=>o,"latLonFromPoint",()=>t,"pointFromLatLon",()=>r])},60147,78140,e=>{"use strict";var t=e.i(19063);function r(e){let t=new Date(e);t.setSeconds(0,0);let r=t.getMinutes();return t.setMinutes(r<30?0:30),t}function n(e){let t=String(e.getHours()).padStart(2,"0"),r=0===e.getMinutes()?"00":"30";return`${t}:${r}`}function a(e,t){return r("string"==typeof e?new Date(e):e).getTime()===t.getTime()}e.s(["bucketLabel",()=>n,"isWithinSameBucket",()=>a,"truncateTo30MinBucket",()=>r],78140);let i=new Map;async function o(e){var t,r,n,a,o;let l,d,c;if(0===e.destinations.length)return[];let u=process.env.GOOGLE_MAPS_API_KEY;if(!u)throw Error("Missing GOOGLE_MAPS_API_KEY environment variable");let p=Math.floor((e.departureTime??new Date).getTime()/1e3),f=(t=e.origin,r=e.destinations,n=p,l=`${t.lat.toFixed(3)},${t.lon.toFixed(3)}`,d=r.map(e=>`${e.zoneId}:${e.lat.toFixed(3)},${e.lon.toFixed(3)}`).sort().join("|"),c=Math.floor(n/60),`${l}|${d}|${c}`),m=i.get(f);if(m&&m.expiresAt>Date.now())return m.data;let _=[];for(let t of function(e,t){let r=[];for(let t=0;t<e.length;t+=25)r.push(e.slice(t,t+25));return r}(e.destinations,25)){let r=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");r.searchParams.set("origins",(a=e.origin.lat,o=e.origin.lon,`${a},${o}`)),r.searchParams.set("destinations",t.map(e=>{var t,r;return t=e.lat,r=e.lon,`${t},${r}`}).join("|")),r.searchParams.set("departure_time",p.toString()),r.searchParams.set("traffic_model","best_guess"),r.searchParams.set("units","metric"),r.searchParams.set("key",u);let n=await fetch(r.toString(),{method:"GET",cache:"no-store"});if(!n.ok)throw Error(`Google Maps Distance Matrix HTTP ${n.status}`);let i=await n.json();if("OK"!==i.status)throw Error(`Google Maps Distance Matrix error: ${i.status}${i.error_message?` (${i.error_message})`:""}`);let l=i.rows?.[0];if(!l||!Array.isArray(l.elements))throw Error("Google Maps Distance Matrix returned no rows");l.elements.forEach((e,r)=>{let n=t[r];_.push({zoneId:n.zoneId,distanceMeters:s(e.distance?.value),durationSeconds:s(e.duration?.value),durationInTrafficSeconds:s(e.duration_in_traffic?.value),status:e.status??"UNKNOWN"})})}return i.set(f,{expiresAt:Date.now()+6e4,data:_}),_}function s(e){return"number"==typeof e&&Number.isFinite(e)?e:null}let l=new Map;async function d(e){var a,i,o,s;let l,{supabase:d,driverId:u,currentLoc:p,snappedZoneId:f=null,k:b=3,context:x,now:v,currentSpeedKmh:w}=e,y="string"==typeof v?new Date(v):v||new Date,R=r(y),I=R.toISOString(),S=n(R),E=(a=x,{traffic_speed_idx:"number"==typeof a?.traffic_speed_idx?g(a.traffic_speed_idx,0,1):null,route_incident:!!a?.route_incident,airport_wave:"number"==typeof a?.airport_wave?g(a.airport_wave,0,1):null,weather_flag_rain:!!a?.weather_flag_rain,event_flag:!!a?.event_flag}),N=await c(d,p),z=N.candidates;if(0===z.length)return N.totalZones>0&&0===N.zonesWithCoordinates&&console.warn("[recommendations] zones present but none have coordinates",{driverId:u,totalZones:N.totalZones}),{computed_at:y.toISOString(),context:{...E,driver_id:u,snapped_zone:f,bucket_start:I,bucket_label:S,traffic_source:"fallback"},top:[],traffic_source:"fallback"};let T=z.map(e=>e.zone.id),[M,k,A]=await Promise.all([m(d,T,R,u),_(d,T,R,u),h({driverId:u,origin:p,candidates:z,departure:y,currentSpeedKmh:w??null})]),P=function(e){if(0===e.size)return 180;let t=0,r=0;for(let n of e.values())t+=n.sum,r+=n.count;return 0===r?180:t/r}(k),D=0,C=0,O=z.map(e=>{let r=e.zone.id,n=M.get(r),a=n?n.prob:.35,i=k.get(r),o=i&&i.count>0?i.sum/i.count:P,s=A.entries.get(r),l=1e3*e.distanceKm,d=Number(((s?.distanceMeters&&s.distanceMeters>0?s.distanceMeters:l)/1e3).toFixed(2)),c=Number(((s?.durationInTrafficSeconds&&s.durationInTrafficSeconds>0?s.durationInTrafficSeconds:60*(0,t.estimateETA)(l,w))/60).toFixed(1)),u="number"==typeof s?.trafficSpeedIdx?s.trafficSpeedIdx:null;return"number"==typeof u&&(D+=u,C+=1),{zoneId:r,zoneName:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distanceKm:d,etaMin:c,successProb:a,expectedFare:o,trafficSpeedIdx:u}}),F=O.reduce((e,t)=>Math.max(e,t.expectedFare),P),K=O.map(e=>{var t,r,n,a,i,o;let s,l,d=F>0?Number((e.expectedFare/F).toFixed(3)):0,c=Math.min(e.etaMin/30,1),u=(t=e.trafficSpeedIdx,r=E,s="number"==typeof t?g(t,0,1):"number"==typeof r.traffic_speed_idx?g(r.traffic_speed_idx,0,1):null,g((null!==s?1-s:.2)+.5*!!r.route_incident+.3*!!r.weather_flag_rain,0,1)),p=g(.4*e.successProb+.3*d-.2*c-.1*u,0,1),f=(n=e,a=d,i=e.trafficSpeedIdx,o=E,l=[],n.successProb>=.65?l.push("High hit rate"):n.successProb>=.5&&l.push("Steady bookings"),a>=.7?l.push("Premium fares"):n.expectedFare>=220&&l.push("Above avg fare"),n.distanceKm<=2?l.push("Very close"):n.distanceKm<=5&&l.push("Nearby"),"number"==typeof i&&(i>=.8?l.push("Traffic flowing"):i<.5&&l.push("Heavy traffic")),o.airport_wave&&/airport/i.test(n.zoneName)&&l.push("Airport arrivals"),o.event_flag&&l.push("Event demand"),0===l.length&&l.push("Balanced demand vs travel time"),l.slice(0,3).join("; "));return{zone_id:e.zoneId,zone_name:e.zoneName,lat:e.lat,lon:e.lon,distance_km:e.distanceKm,eta_min:e.etaMin,score:Number(p.toFixed(3)),success_prob:Number(e.successProb.toFixed(3)),expected_fare_inr:Math.round(e.expectedFare),normalized_fare:d,traffic_penalty:Number(u.toFixed(2)),traffic_speed_idx:"number"==typeof e.trafficSpeedIdx?Number(e.trafficSpeedIdx.toFixed(2)):null,reason:f}});K.sort((e,t)=>t.score-e.score);let j=C>0?Number((D/C).toFixed(2)):E.traffic_speed_idx??null,L=A.source,U=K.slice(0,Math.max(1,b));0===U.length&&z.length>0&&(console.warn("[recommendations] scored list empty, falling back to nearest zones",{driverId:u,candidateCount:z.length}),i=z,o=b,s=w??null,l=Math.max(1,o),U=[...i].sort((e,t)=>e.distanceKm-t.distanceKm).slice(0,l).map(e=>{let r=Number(e.distanceKm.toFixed(2)),n=(0,t.estimateETA)(1e3*e.distanceKm,s??void 0),a=g(r/24,0,1),i="number"==typeof e.zone.weight_demand&&e.zone.weight_demand>0?g(e.zone.weight_demand,.5,2):1,o="number"==typeof e.zone.weight_airport?g(e.zone.weight_airport,0,2):0,l=g((1-a)*i+.05*o,0,1),d=g(.35*i,.2,.95);return{zone_id:e.zone.id,zone_name:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distance_km:r,eta_min:Number(n.toFixed(1)),score:Number(l.toFixed(3)),success_prob:Number(d.toFixed(3)),expected_fare_inr:180,normalized_fare:g(.5*i,0,1),traffic_penalty:.2,traffic_speed_idx:null,reason:"Nearest zones by distance (fallback)"}}),L="fallback");let $={...E,traffic_speed_idx:j,driver_id:u,snapped_zone:f,bucket_start:I,bucket_label:S,traffic_source:L};return{computed_at:y.toISOString(),context:$,top:U,traffic_source:L}}async function c(e,t){let{data:r,error:n}=await e.from("zones").select("id,name,lat,lon,center,radius_km,weight_demand,weight_airport,is_active").eq("is_active",!0).limit(200);if(n||!r)return console.error("[recommendations] zone fetch failed",{error:n}),{candidates:[],totalZones:0,zonesWithCoordinates:0};let a=r.length;if(0===a)return console.warn("[recommendations] No zones found in DB when building candidates"),{candidates:[],totalZones:0,zonesWithCoordinates:0};let i=r.filter(e=>!1!==e.is_active),o=i.length>0?i:r,s=u(o,t,18),l=s.candidates,d=s.totalResolved;if(0===l.length&&d>0){let e=u(o,t,36);if(e.candidates.length>0)console.warn("[recommendations] No zones within default radius, using relaxed fallback",{totalZones:a,relaxedRadiusKm:36}),l=e.candidates,d=e.totalResolved;else{console.warn("[recommendations] No zones within relaxed radius, defaulting to all zones sorted by distance",{totalZones:a,resolvedZones:d});let e=u(o,t);l=e.candidates,d=e.totalResolved}}else 0===l.length&&0===d&&console.warn("[recommendations] Zones exist but none contain usable coordinates",{totalZones:a});return{candidates:l.slice(0,25),totalZones:a,zonesWithCoordinates:d}}function u(e,r,n){let a=[];for(let n of e){var i;let e=function(e){let t=p(e.lat),r=p(e.lon);if(null!==t&&null!==r)return{lat:t,lon:r};let n=f(e.center);if(n)return n;let a=f(e.geom);return a||null}(n);if(!e)continue;let o=(0,t.distanceKm)(r.lat,r.lon,e.lat,e.lon);a.push({zone:{...n,name:(i=n).name&&i.name.trim().length>0?i.name.trim():i.slug&&i.slug.trim().length>0?i.slug.replace(/_/g," ").trim():`Zone ${i.id}`,lat:e.lat,lon:e.lon},distanceKm:o})}return a.sort((e,t)=>e.distanceKm-t.distanceKm),{candidates:"number"==typeof n?a.filter(e=>e.distanceKm<=n):a,totalResolved:a.length}}function p(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){let t=Number(e);if(Number.isFinite(t))return t}return null}function f(e){if(!e)return null;if("string"==typeof e){let t=e.trim();if(!t)return null;if(t.startsWith("{")||t.startsWith("["))try{let e=JSON.parse(t);return f(e)}catch{}return function(e){let t=(e.includes(";")?e.split(";").pop().trim():e.trim()).match(/POINT\s*\(([^)]+)\)/i);if(!t)return null;let[r,n]=t[1].trim().split(/\s+/),a=Number(r),i=Number(n);return Number.isFinite(i)&&Number.isFinite(a)?{lat:i,lon:a}:null}(t)}if(Array.isArray(e.coordinates)&&e.coordinates.length>=2){let[t,r]=e.coordinates,n=p(r),a=p(t);if(null!==n&&null!==a)return{lat:n,lon:a}}let t=p(e.lat??e.latitude),r=p(e.lon??e.lng??e.longitude);return null!==t&&null!==r?{lat:t,lon:r}:null}async function m(e,t,r,n){var i,o;let s=new Map;if(0===t.length)return s;let l=new Date(r);l.setDate(l.getDate()-14);let{data:d,error:c}=await e.from("training_examples").select("zone_id,label_ride_15m,success_prob,sample_size,bucket_30m,created_at").in("zone_id",t).gte("created_at",l.toISOString());if(c||!d)return console.error("[recommendations] training fetch failed",{driverId:n,error:c}),s;for(let e of d){let t=e.zone_id;if(!a(e.bucket_30m??e.created_at??r.toISOString(),r))continue;let n=s.get(t)??{prob:0,samples:0},o="number"==typeof e.sample_size&&e.sample_size>0?e.sample_size:1,l="number"==typeof e.success_prob&&o>1?g(e.success_prob,0,1)*o:"number"==typeof(i=e).success_prob?i.success_prob:"number"==typeof i.label_ride_15m?g(i.label_ride_15m,0,1):"boolean"==typeof i.label_ride_15m?+!!i.label_ride_15m:0;n.prob+=l,n.samples+=o,s.set(t,n)}for(let[e,t]of s.entries()){let r=(o=t.prob,(o+1)/(t.samples+2));s.set(e,{prob:r,samples:t.samples})}return s}async function _(e,t,r,n){let i=new Map;if(0===t.length)return i;let o=new Date(r);o.setDate(o.getDate()-14);let{data:s,error:l}=await e.from("trips").select("pickup_zone,fare_inr,completed_at").in("pickup_zone",t).gte("completed_at",o.toISOString());if(l||!s)return console.error("[recommendations] trip fare fetch failed",{driverId:n,error:l}),i;for(let e of s){if(!e.pickup_zone)continue;let t=e.completed_at;if(!t||!a(t,r)||"number"!=typeof e.fare_inr||e.fare_inr<=0)continue;let n=i.get(e.pickup_zone)??{sum:0,count:0};n.sum+=e.fare_inr,n.count+=1,i.set(e.pickup_zone,n)}return i}async function h(e){let r=e.candidates.map(e=>e.zone.id).sort((e,t)=>e-t).join(","),n=l.get(e.driverId);if(n&&n.destKey===r){let r=1e3*(0,t.distanceKm)(e.origin.lat,e.origin.lon,n.origin.lat,n.origin.lon),a=Date.now()-n.snapshot.fetchedAt;if(r<200&&a<45e3)return{entries:new Map(n.snapshot.entries),source:"google"===n.snapshot.source?"cache":n.snapshot.source,fetchedAt:n.snapshot.fetchedAt}}let a=e.candidates.map(e=>({zoneId:e.zone.id,lat:e.zone.lat,lon:e.zone.lon}));try{let t=await o({origin:e.origin,destinations:a,departureTime:e.departure}),n=function(e){let t=new Map;for(let n of e){var r;t.set(n.zoneId,{zoneId:n.zoneId,distanceMeters:n.distanceMeters,durationSeconds:n.durationSeconds,durationInTrafficSeconds:n.durationInTrafficSeconds,trafficSpeedIdx:!(r=n).durationSeconds||!r.durationInTrafficSeconds||r.durationSeconds<=0||r.durationInTrafficSeconds<=0?null:g(r.durationSeconds/r.durationInTrafficSeconds,0,1),status:n.status})}return{entries:t,source:"google",fetchedAt:Date.now()}}(t);return l.set(e.driverId,{destKey:r,origin:e.origin,snapshot:n}),n}catch(a){console.warn("[recommendations] traffic matrix failed, using fallback",{driverId:e.driverId,error:a});let n=function(e,r){let n=new Map;for(let a of e){let e=1e3*a.distanceKm,i=60*(0,t.estimateETA)(e,r);n.set(a.zone.id,{zoneId:a.zone.id,distanceMeters:e,durationSeconds:i,durationInTrafficSeconds:i,trafficSpeedIdx:null,status:"FALLBACK"})}return{entries:n,source:"fallback",fetchedAt:Date.now()}}(e.candidates,e.currentSpeedKmh);return l.set(e.driverId,{destKey:r,origin:e.origin,snapshot:n}),n}}function g(e,t,r){return Math.max(t,Math.min(r,e))}e.s(["computeNextZonesForDriver",()=>d],60147)},34967,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),a=e.i(59756),i=e.i(61916),o=e.i(14444),s=e.i(37092),l=e.i(69741),d=e.i(16795),c=e.i(87718),u=e.i(95169),p=e.i(47587),f=e.i(66012),m=e.i(70101),_=e.i(26937),h=e.i(10372),g=e.i(93695);e.i(52474);var b=e.i(5232),x=e.i(45620),v=e.i(22632),w=e.i(98752);let y=new Map;var R=e.i(19063),I=e.i(60147),S=e.i(78140),E=e.i(89660);let N=new Map;async function z(e){let{supabase:t,driverId:r,snappedZoneId:n,bucketIso:a,tsIso:i}=e;try{await t.from("training_examples").insert({driver_id:r,zone_id:n,arrived_at:i,bucket_30m:a,context:{traffic:e.trafficContext,computed:{traffic_speed_idx:e.recommendationContext.traffic_speed_idx??null,traffic_source:e.recommendationContext.traffic_source??null,airport_wave:e.recommendationContext.airport_wave??null},top:e.recommendationTop},label_ride_15m:null})}catch(e){console.error("[pings] training example insert failed",{driverId:r,error:e})}}async function T(e){try{var t,r,n,a,i,o;let s,l=e.headers.get("content-type");if(!l?.includes("application/json"))return(0,x.bad)("Content-Type must be application/json",null,415,"UNSUPPORTED_MEDIA_TYPE");let{supabase:d,user:c}=await (0,E.createServerSupabaseClient)();if(!c)return Response.json({error:{code:"UNAUTHENTICATED",message:"Please sign in"}},{status:401});if(t=c.id,(s=Date.now())-(N.get(t)??0)<3e3||(N.set(t,s),0))return(0,x.bad)("Rate limit exceeded",{limit:"1 ping/3s"},429,"RATE_LIMITED");let u=e.headers.get("x-forwarded-for")??"unknown";if(!function(e,t=60,r=6e4){let n=Date.now(),a=y.get(e)||{count:0,ts:n};return n-a.ts>r&&(a.count=0,a.ts=n),a.count+=1,y.set(e,a),{allowed:a.count<=t,remaining:Math.max(0,t-a.count)}}(`pings:${u}`,60,6e4).allowed)return(0,x.bad)("Rate limit exceeded",{limit:"60 req/min"},429,"RATE_LIMITED");let p=await e.json(),f=w.CreatePingReq.parse(p);if(!(0,R.isValidLatitude)(f.lat)||!(0,R.isValidLongitude)(f.lon))return(0,x.bad)("Invalid coordinates",{lat:f.lat,lon:f.lon},400,"INVALID_INPUT");let m=f.ts?new Date(f.ts):new Date;if(Number.isNaN(m.getTime()))return(0,x.bad)("Invalid timestamp",null,400,"INVALID_INPUT");let _=m.toISOString(),h=(0,S.truncateTo30MinBucket)(m),g=h.toISOString(),b=function(e){if(!e)return{};let t={};return"number"==typeof e.traffic_speed_idx&&(t.traffic_speed_idx=e.traffic_speed_idx),"boolean"==typeof e.route_incident&&(t.route_incident=e.route_incident),"number"==typeof e.airport_wave&&(t.airport_wave=e.airport_wave),"boolean"==typeof e.weather_flag_rain&&(t.weather_flag_rain=e.weather_flag_rain),"boolean"==typeof e.event_flag&&(t.event_flag=e.event_flag),t}(f.traffic_context),{data:v}=await d.from("driver_state").select("snapped_zone").eq("driver_id",c.id).maybeSingle(),T=(0,R.pointFromLatLon)(f.lat,f.lon),M={driver_id:c.id,ts:_,loc:T};"number"==typeof f.accuracy_m&&(M.accuracy_m=f.accuracy_m),"number"==typeof f.battery_pct&&(M.battery_pct=f.battery_pct),"number"==typeof f.speed_kmh&&(M.speed_kmh=f.speed_kmh);let{data:k,error:A}=await d.from("pings").insert(M).select("id,driver_id,ts,loc,speed_kmh,battery_pct").maybeSingle();if(A)return console.error("[pings] insert error",{userId:c?.id,insertPayload:M,error:A}),Response.json({error:{code:"DB_ERROR",message:"Failed to save ping",details:{code:A.code,message:A.message,hint:A.hint??null}}},{status:500});let{data:P,error:D}=await d.rpc("nearest_zone",{p_lon:f.lon,p_lat:f.lat,p_max_m:3e3});D&&console.error("[pings] nearest_zone failed",{driverId:c.id,error:D});let C="number"==typeof P?P:null,O=await (0,I.computeNextZonesForDriver)({supabase:d,driverId:c.id,currentLoc:{lat:f.lat,lon:f.lon},snappedZoneId:C,context:b,now:m,currentSpeedKmh:f.speed_kmh??null,k:3}),F={driver_id:c.id,last_ping_at:_,loc:T,snapped_zone:C,speed_kmh:f.speed_kmh??null,battery_pct:f.battery_pct??null,recommendation:O,updated_at:new Date().toISOString()},{error:K}=await d.from("driver_state").upsert(F,{onConflict:"driver_id"});if(K){return r="Failed to update driver state",n=K,a=c.id,i=f,console.error("[pings] DB error",{userId:a,payload:i,error:n}),Response.json({error:{code:"DB_ERROR",message:r,details:{code:(o=n).code,message:o.message,details:o.details??null,hint:o.hint??null}}},{status:500})}try{await d.from("decision_snapshots").insert({driver_id:c.id,decided_at:_,lat:f.lat,lon:f.lon,snapped_zone:C,bucket_30m:g,context:{...b,bucket_label:(0,S.bucketLabel)(h),traffic_speed_idx_computed:O.context.traffic_speed_idx??null,airport_wave:O.context.airport_wave??null,traffic_source:O.traffic_source},topk:O.top,recommendation:O})}catch(e){console.error("[pings] decision snapshot insert failed",{driverId:c.id,error:e})}return C&&v?.snapped_zone&&v.snapped_zone!==C&&await z({supabase:d,driverId:c.id,snappedZoneId:C,bucketIso:g,tsIso:_,trafficContext:b,recommendationTop:O.top??[],recommendationContext:O.context}),(0,x.ok)({ping:k,zone_id:C,snapped_zone:C,recommendation:O})}catch(e){if(e instanceof v.z.ZodError)return(0,x.bad)("Validation failed",e.flatten(),400,"INVALID_INPUT");return console.error("[pings] unexpected error",e),(0,x.bad)("Unexpected error",null,500,"INTERNAL_ERROR")}}async function M(e){try{let{supabase:t,user:r}=await (0,E.createServerSupabaseClient)();if(!r)return Response.json({error:{code:"UNAUTHENTICATED",message:"Please sign in"}},{status:401});let n=new URL(e.url),a=Math.min(parseInt(n.searchParams.get("limit")||"50",10),200),{data:i,error:o}=await t.from("pings").select("id,ts,loc,battery_pct,speed_kmh").order("ts",{ascending:!1}).limit(a);if(o)return(0,x.bad)("DB error",o,500,"DB_ERROR");return(0,x.ok)(i)}catch(e){return console.error("[pings] GET failed",e),(0,x.bad)("Unexpected error",null,500,"INTERNAL_ERROR")}}e.s(["GET",()=>M,"POST",()=>T],77390);var k=e.i(77390);let A=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/pings/route",pathname:"/api/pings",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/pings/route.ts",nextConfigOutput:"",userland:k}),{workAsyncStorage:P,workUnitAsyncStorage:D,serverHooks:C}=A;function O(){return(0,n.patchFetch)({workAsyncStorage:P,workUnitAsyncStorage:D})}async function F(e,t,n){A.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/pings/route";x=x.replace(/\/index$/,"")||"/";let v=await A.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:w,params:y,nextConfig:R,parsedUrl:I,isDraftMode:S,prerenderManifest:E,routerServerContext:N,isOnDemandRevalidate:z,revalidateOnlyGenerated:T,resolvedPathname:M,clientReferenceManifest:k,serverActionsManifest:P}=v,D=(0,l.normalizeAppPath)(x),C=!!(E.dynamicRoutes[D]||E.routes[M]),O=async()=>((null==N?void 0:N.render404)?await N.render404(e,t,I,!1):t.end("This page could not be found"),null);if(C&&!S){let e=!!E.routes[M],t=E.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await O();throw new g.NoFallbackError}}let F=null;!C||A.isDev||S||(F="/index"===(F=M)?"/":F);let K=!0===A.isDev||!C,j=C&&!K;P&&k&&(0,o.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:k,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let L=e.method||"GET",U=(0,i.getTracer)(),$=U.getActiveScopeSpan(),q={params:y,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:K,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n)=>A.onRequestError(e,t,n,N)},sharedContext:{buildId:w}},H=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(H,(0,c.signalFromNodeResponse)(t));try{let o=async e=>A.handle(G,q).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=U.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==u.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${L} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${x}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var i,l;let d=async({previousCacheEntry:r})=>{try{if(!s&&z&&T&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(a);e.fetchMetrics=q.renderOpts.fetchMetrics;let l=q.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let d=q.renderOpts.collectedTags;if(!C)return await (0,f.sendResponse)(H,B,i,q.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(i.headers);d&&(t[h.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==q.renderOpts.collectedRevalidate&&!(q.renderOpts.collectedRevalidate>=h.INFINITE_CACHE)&&q.renderOpts.collectedRevalidate,n=void 0===q.renderOpts.collectedExpire||q.renderOpts.collectedExpire>=h.INFINITE_CACHE?void 0:q.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await A.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:z})},N),t}},c=await A.handleResponse({req:e,nextConfig:R,cacheKey:F,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:z,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:n.waitUntil,isMinimalMode:s});if(!C)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(l=c.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",z?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),S&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let u=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return s&&C||u.delete(h.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||u.get("Cache-Control")||u.set("Cache-Control",(0,_.getCacheControlHeader)(c.cacheControl)),await (0,f.sendResponse)(H,B,new Response(c.value.body,{headers:u,status:c.value.status||200})),null};$?await l($):await U.withPropagatedContext(e.headers,()=>U.trace(u.BaseServerSpan.handleRequest,{spanName:`${L} ${x}`,kind:i.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await A.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:j,isOnDemandRevalidate:z})}),C)throw t;return await (0,f.sendResponse)(H,B,new Response(null,{status:500})),null}}e.s(["handler",()=>F,"patchFetch",()=>O,"routeModule",()=>A,"serverHooks",()=>C,"workAsyncStorage",()=>P,"workUnitAsyncStorage",()=>D],34967)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__8aa82b67._.js.map