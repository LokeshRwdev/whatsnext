module.exports=[60147,78140,e=>{"use strict";var t=e.i(19063);function n(e){let t=new Date(e);t.setSeconds(0,0);let n=t.getMinutes();return t.setMinutes(n<30?0:30),t}function r(e){let t=String(e.getHours()).padStart(2,"0"),n=0===e.getMinutes()?"00":"30";return`${t}:${n}`}function a(e,t){return n("string"==typeof e?new Date(e):e).getTime()===t.getTime()}e.s(["bucketLabel",()=>r,"isWithinSameBucket",()=>a,"truncateTo30MinBucket",()=>n],78140);let o=new Map;async function i(e){var t,n,r,a,i;let l,d,c;if(0===e.destinations.length)return[];let u=process.env.GOOGLE_MAPS_API_KEY;if(!u)throw Error("Missing GOOGLE_MAPS_API_KEY environment variable");let f=Math.floor((e.departureTime??new Date).getTime()/1e3),m=(t=e.origin,n=e.destinations,r=f,l=`${t.lat.toFixed(3)},${t.lon.toFixed(3)}`,d=n.map(e=>`${e.zoneId}:${e.lat.toFixed(3)},${e.lon.toFixed(3)}`).sort().join("|"),c=Math.floor(r/60),`${l}|${d}|${c}`),p=o.get(m);if(p&&p.expiresAt>Date.now())return p.data;let _=[];for(let t of function(e,t){let n=[];for(let t=0;t<e.length;t+=25)n.push(e.slice(t,t+25));return n}(e.destinations,25)){let n=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");n.searchParams.set("origins",(a=e.origin.lat,i=e.origin.lon,`${a},${i}`)),n.searchParams.set("destinations",t.map(e=>{var t,n;return t=e.lat,n=e.lon,`${t},${n}`}).join("|")),n.searchParams.set("departure_time",f.toString()),n.searchParams.set("traffic_model","best_guess"),n.searchParams.set("units","metric"),n.searchParams.set("key",u);let r=await fetch(n.toString(),{method:"GET",cache:"no-store"});if(!r.ok)throw Error(`Google Maps Distance Matrix HTTP ${r.status}`);let o=await r.json();if("OK"!==o.status)throw Error(`Google Maps Distance Matrix error: ${o.status}${o.error_message?` (${o.error_message})`:""}`);let l=o.rows?.[0];if(!l||!Array.isArray(l.elements))throw Error("Google Maps Distance Matrix returned no rows");l.elements.forEach((e,n)=>{let r=t[n];_.push({zoneId:r.zoneId,distanceMeters:s(e.distance?.value),durationSeconds:s(e.duration?.value),durationInTrafficSeconds:s(e.duration_in_traffic?.value),status:e.status??"UNKNOWN"})})}return o.set(m,{expiresAt:Date.now()+6e4,data:_}),_}function s(e){return"number"==typeof e&&Number.isFinite(e)?e:null}let l=new Map;async function d(e){var a,o,i,s;let l,{supabase:d,driverId:u,currentLoc:f,snappedZoneId:m=null,k:b=3,context:z,now:x,currentSpeedKmh:w}=e,y="string"==typeof x?new Date(x):x||new Date,S=n(y),v=S.toISOString(),I=r(S),M=(a=z,{traffic_speed_idx:"number"==typeof a?.traffic_speed_idx?h(a.traffic_speed_idx,0,1):null,route_incident:!!a?.route_incident,airport_wave:"number"==typeof a?.airport_wave?h(a.airport_wave,0,1):null,weather_flag_rain:!!a?.weather_flag_rain,event_flag:!!a?.event_flag}),N=await c(d,f),k=N.candidates;if(console.log("[recommendations] candidate fetch result",{driverId:u,currentLoc:f,totalZones:N.totalZones,zonesWithCoordinates:N.zonesWithCoordinates,candidateCount:k.length}),0===k.length){let e=0===N.totalZones?"no_zones_in_db":0===N.zonesWithCoordinates?"no_zones_with_coords":"zones_too_far";return console.warn("[recommendations] No candidates available",{driverId:u,reason:e,totalZones:N.totalZones,zonesWithCoordinates:N.zonesWithCoordinates,currentLoc:f}),{computed_at:y.toISOString(),context:{...M,driver_id:u,snapped_zone:m,bucket_start:v,bucket_label:I,traffic_source:"fallback",reason:e},top:[],traffic_source:"fallback"}}let F=k.map(e=>e.zone.id),[K,T,A]=await Promise.all([p(d,F,S,u),_(d,F,S,u),g({driverId:u,origin:f,candidates:k,departure:y,currentSpeedKmh:w??null})]),D=function(e){if(0===e.size)return 180;let t=0,n=0;for(let r of e.values())t+=r.sum,n+=r.count;return 0===n?180:t/n}(T),$=0,P=0,E=k.map(e=>{let n=e.zone.id,r=K.get(n),a=r?r.prob:.35,o=T.get(n),i=o&&o.count>0?o.sum/o.count:D,s=A.entries.get(n),l=1e3*e.distanceKm,d=Number(((s?.distanceMeters&&s.distanceMeters>0?s.distanceMeters:l)/1e3).toFixed(2)),c=Number(((s?.durationInTrafficSeconds&&s.durationInTrafficSeconds>0?s.durationInTrafficSeconds:60*(0,t.estimateETA)(l,w))/60).toFixed(1)),u="number"==typeof s?.trafficSpeedIdx?s.trafficSpeedIdx:null;return"number"==typeof u&&($+=u,P+=1),{zoneId:n,zoneName:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distanceKm:d,etaMin:c,successProb:a,expectedFare:i,trafficSpeedIdx:u}}),C=E.reduce((e,t)=>Math.max(e,t.expectedFare),D),O=E.map(e=>{var t,n,r,a,o,i;let s,l,d=C>0?Number((e.expectedFare/C).toFixed(3)):0,c=Math.min(e.etaMin/30,1),u=(t=e.trafficSpeedIdx,n=M,s="number"==typeof t?h(t,0,1):"number"==typeof n.traffic_speed_idx?h(n.traffic_speed_idx,0,1):null,h((null!==s?1-s:.2)+.5*!!n.route_incident+.3*!!n.weather_flag_rain,0,1)),f=h(.4*e.successProb+.3*d-.2*c-.1*u,0,1),m=(r=e,a=d,o=e.trafficSpeedIdx,i=M,l=[],r.successProb>=.65?l.push("High hit rate"):r.successProb>=.5&&l.push("Steady bookings"),a>=.7?l.push("Premium fares"):r.expectedFare>=220&&l.push("Above avg fare"),r.distanceKm<=2?l.push("Very close"):r.distanceKm<=5&&l.push("Nearby"),"number"==typeof o&&(o>=.8?l.push("Traffic flowing"):o<.5&&l.push("Heavy traffic")),i.airport_wave&&/airport/i.test(r.zoneName)&&l.push("Airport arrivals"),i.event_flag&&l.push("Event demand"),0===l.length&&l.push("Balanced demand vs travel time"),l.slice(0,3).join("; "));return{zone_id:e.zoneId,zone_name:e.zoneName,lat:e.lat,lon:e.lon,distance_km:e.distanceKm,eta_min:e.etaMin,score:Number(f.toFixed(3)),success_prob:Number(e.successProb.toFixed(3)),expected_fare_inr:Math.round(e.expectedFare),normalized_fare:d,traffic_penalty:Number(u.toFixed(2)),traffic_speed_idx:"number"==typeof e.trafficSpeedIdx?Number(e.trafficSpeedIdx.toFixed(2)):null,reason:m}});O.sort((e,t)=>t.score-e.score);let W=P>0?Number(($/P).toFixed(2)):M.traffic_speed_idx??null,Z=A.source,G=O.slice(0,Math.max(1,b));0===G.length&&k.length>0&&(console.warn("[recommendations] scored list empty, falling back to nearest zones",{driverId:u,candidateCount:k.length,currentLoc:f}),o=k,i=b,s=w??null,l=Math.max(1,i),G=[...o].sort((e,t)=>e.distanceKm-t.distanceKm).slice(0,l).map(e=>{let n=Number(e.distanceKm.toFixed(2)),r=(0,t.estimateETA)(1e3*e.distanceKm,s??void 0),a=h(n/24,0,1),o="number"==typeof e.zone.weight_demand&&e.zone.weight_demand>0?h(e.zone.weight_demand,.5,2):1,i="number"==typeof e.zone.weight_airport?h(e.zone.weight_airport,0,2):0,l=h((1-a)*o+.05*i,0,1),d=h(.35*o,.2,.95);return{zone_id:e.zone.id,zone_name:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distance_km:n,eta_min:Number(r.toFixed(1)),score:Number(l.toFixed(3)),success_prob:Number(d.toFixed(3)),expected_fare_inr:180,normalized_fare:h(.5*o,0,1),traffic_penalty:.2,traffic_speed_idx:null,reason:"Nearest zones by distance (fallback)"}}),Z="fallback"),0===G.length&&k.length>0&&(console.error("[recommendations] CRITICAL: topRecommendations empty despite candidates",{driverId:u,candidateCount:k.length,scoredCount:O.length,currentLoc:f}),G=[...k].sort((e,t)=>e.distanceKm-t.distanceKm).slice(0,Math.max(1,b)).map(e=>({zone_id:e.zone.id,zone_name:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distance_km:Number(e.distanceKm.toFixed(2)),eta_min:Number((0,t.estimateETA)(1e3*e.distanceKm,w??void 0).toFixed(1)),score:.5,success_prob:.35,expected_fare_inr:180,normalized_fare:.5,traffic_penalty:0,traffic_speed_idx:null,reason:"Emergency fallback: nearest by distance"})),Z="fallback");let R={...M,traffic_speed_idx:W,driver_id:u,snapped_zone:m,bucket_start:v,bucket_label:I,traffic_source:Z};return{computed_at:y.toISOString(),context:R,top:G,traffic_source:Z}}async function c(e,t){let{data:n,error:r}=await e.from("zones").select("id,name,lat,lon,center,radius_km,weight_demand,weight_airport,is_active").eq("is_active",!0).limit(200);if(r||!n)return console.error("[recommendations] zone fetch failed",{error:r}),{candidates:[],totalZones:0,zonesWithCoordinates:0};let a=n.length;if(0===a)return console.warn("[recommendations] No zones found in DB when building candidates"),{candidates:[],totalZones:0,zonesWithCoordinates:0};let o=n.filter(e=>!1!==e.is_active),i=o.length>0?o:n,s=u(i,t,18),l=s.candidates,d=s.totalResolved;if(0===l.length&&d>0){let e=u(i,t,36);if(e.candidates.length>0)console.warn("[recommendations] No zones within default radius, using relaxed fallback",{totalZones:a,relaxedRadiusKm:36}),l=e.candidates,d=e.totalResolved;else{console.warn("[recommendations] No zones within relaxed radius, defaulting to all zones sorted by distance",{totalZones:a,resolvedZones:d});let e=u(i,t);l=e.candidates,d=e.totalResolved}}else 0===l.length&&0===d&&console.warn("[recommendations] Zones exist but none contain usable coordinates",{totalZones:a});return{candidates:l.slice(0,25),totalZones:a,zonesWithCoordinates:d}}function u(e,n,r){let a=[];for(let r of e){var o;let e=function(e){let t=f(e.lat),n=f(e.lon);if(null!==t&&null!==n)return{lat:t,lon:n};let r=m(e.center);if(r)return r;let a=m(e.geom);return a||null}(r);if(!e)continue;let i=(0,t.distanceKm)(n.lat,n.lon,e.lat,e.lon);a.push({zone:{...r,name:(o=r).name&&o.name.trim().length>0?o.name.trim():o.slug&&o.slug.trim().length>0?o.slug.replace(/_/g," ").trim():`Zone ${o.id}`,lat:e.lat,lon:e.lon},distanceKm:i})}return a.sort((e,t)=>e.distanceKm-t.distanceKm),{candidates:"number"==typeof r?a.filter(e=>e.distanceKm<=r):a,totalResolved:a.length}}function f(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){let t=Number(e);if(Number.isFinite(t))return t}return null}function m(e){if(!e)return null;if("string"==typeof e){let t=e.trim();if(!t)return null;if(t.startsWith("{")||t.startsWith("["))try{let e=JSON.parse(t);return m(e)}catch{}return function(e){let t=(e.includes(";")?e.split(";").pop().trim():e.trim()).match(/POINT\s*\(([^)]+)\)/i);if(!t)return null;let[n,r]=t[1].trim().split(/\s+/),a=Number(n),o=Number(r);return Number.isFinite(o)&&Number.isFinite(a)?{lat:o,lon:a}:null}(t)}if(Array.isArray(e.coordinates)&&e.coordinates.length>=2){let[t,n]=e.coordinates,r=f(n),a=f(t);if(null!==r&&null!==a)return{lat:r,lon:a}}let t=f(e.lat??e.latitude),n=f(e.lon??e.lng??e.longitude);return null!==t&&null!==n?{lat:t,lon:n}:null}async function p(e,t,n,r){var o,i;let s=new Map;if(0===t.length)return s;let l=new Date(n);l.setDate(l.getDate()-14);let{data:d,error:c}=await e.from("training_examples").select("zone_id,label_ride_15m,success_prob,sample_size,bucket_30m,created_at").in("zone_id",t).gte("created_at",l.toISOString());if(c||!d)return console.error("[recommendations] training fetch failed",{driverId:r,error:c}),s;for(let e of d){let t=e.zone_id;if(!a(e.bucket_30m??e.created_at??n.toISOString(),n))continue;let r=s.get(t)??{prob:0,samples:0},i="number"==typeof e.sample_size&&e.sample_size>0?e.sample_size:1,l="number"==typeof e.success_prob&&i>1?h(e.success_prob,0,1)*i:"number"==typeof(o=e).success_prob?o.success_prob:"number"==typeof o.label_ride_15m?h(o.label_ride_15m,0,1):"boolean"==typeof o.label_ride_15m?+!!o.label_ride_15m:0;r.prob+=l,r.samples+=i,s.set(t,r)}for(let[e,t]of s.entries()){let n=(i=t.prob,(i+1)/(t.samples+2));s.set(e,{prob:n,samples:t.samples})}return s}async function _(e,t,n,r){let o=new Map;if(0===t.length)return o;let i=new Date(n);i.setDate(i.getDate()-14);let{data:s,error:l}=await e.from("trips").select("pickup_zone,fare_inr,completed_at").in("pickup_zone",t).gte("completed_at",i.toISOString());if(l||!s)return console.error("[recommendations] trip fare fetch failed",{driverId:r,error:l}),o;for(let e of s){if(!e.pickup_zone)continue;let t=e.completed_at;if(!t||!a(t,n)||"number"!=typeof e.fare_inr||e.fare_inr<=0)continue;let r=o.get(e.pickup_zone)??{sum:0,count:0};r.sum+=e.fare_inr,r.count+=1,o.set(e.pickup_zone,r)}return o}async function g(e){let n=e.candidates.map(e=>e.zone.id).sort((e,t)=>e-t).join(","),r=l.get(e.driverId);if(r&&r.destKey===n){let n=1e3*(0,t.distanceKm)(e.origin.lat,e.origin.lon,r.origin.lat,r.origin.lon),a=Date.now()-r.snapshot.fetchedAt;if(n<200&&a<45e3)return{entries:new Map(r.snapshot.entries),source:"google"===r.snapshot.source?"cache":r.snapshot.source,fetchedAt:r.snapshot.fetchedAt}}let a=e.candidates.map(e=>({zoneId:e.zone.id,lat:e.zone.lat,lon:e.zone.lon}));try{let t=await i({origin:e.origin,destinations:a,departureTime:e.departure}),r=function(e){let t=new Map;for(let r of e){var n;t.set(r.zoneId,{zoneId:r.zoneId,distanceMeters:r.distanceMeters,durationSeconds:r.durationSeconds,durationInTrafficSeconds:r.durationInTrafficSeconds,trafficSpeedIdx:!(n=r).durationSeconds||!n.durationInTrafficSeconds||n.durationSeconds<=0||n.durationInTrafficSeconds<=0?null:h(n.durationSeconds/n.durationInTrafficSeconds,0,1),status:r.status})}return{entries:t,source:"google",fetchedAt:Date.now()}}(t);return l.set(e.driverId,{destKey:n,origin:e.origin,snapshot:r}),r}catch(a){console.warn("[recommendations] traffic matrix failed, using fallback",{driverId:e.driverId,error:a});let r=function(e,n){let r=new Map;for(let a of e){let e=1e3*a.distanceKm,o=60*(0,t.estimateETA)(e,n);r.set(a.zone.id,{zoneId:a.zone.id,distanceMeters:e,durationSeconds:o,durationInTrafficSeconds:o,trafficSpeedIdx:null,status:"FALLBACK"})}return{entries:r,source:"fallback",fetchedAt:Date.now()}}(e.candidates,e.currentSpeedKmh);return l.set(e.driverId,{destKey:n,origin:e.origin,snapshot:r}),r}}function h(e,t,n){return Math.max(t,Math.min(n,e))}e.s(["computeNextZonesForDriver",()=>d],60147)}];

//# sourceMappingURL=lib_server_recommendation_ts_67aa9062._.js.map