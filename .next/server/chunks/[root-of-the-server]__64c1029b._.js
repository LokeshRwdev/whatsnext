module.exports=[18622,(e,t,n)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},24725,(e,t,n)=>{t.exports=e.x("next/dist/server/app-render/after-task-async-storage.external.js",()=>require("next/dist/server/app-render/after-task-async-storage.external.js"))},70406,(e,t,n)=>{t.exports=e.x("next/dist/compiled/@opentelemetry/api",()=>require("next/dist/compiled/@opentelemetry/api"))},93695,(e,t,n)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},45620,e=>{"use strict";class t extends Error{code;status;details;constructor(e,t,n,r){super(n),this.status=e,this.code=t,this.details=r}}function n(e,t=200){return Response.json(e,{status:t})}function r(e,t,n=400,a){return Response.json({error:{code:a??(n>=500?"INTERNAL_ERROR":"BAD_REQUEST"),message:e,details:t}},{status:n})}e.s(["HttpError",()=>t,"bad",()=>r,"ok",()=>n])},19063,e=>{"use strict";function t(e){if(!e||!Array.isArray(e.coordinates))return{lat:null,lon:null};let[t,n]=e.coordinates??[];return Number.isFinite(n)&&Number.isFinite(t)?{lat:n,lon:t}:{lat:null,lon:null}}function n(e,t){return{type:"Point",coordinates:[t,e]}}function r(e,t,n,r){let a,o,i,s,l;return a=e*Math.PI/180,o=n*Math.PI/180,2*Math.atan2(Math.sqrt(l=Math.sin((i=(n-e)*Math.PI/180)/2)*Math.sin(i/2)+Math.cos(a)*Math.cos(o)*Math.sin((s=(r-t)*Math.PI/180)/2)*Math.sin(s/2)),Math.sqrt(1-l))*6371e3/1e3}function a(e,t){let n=e/1e3,r=15;t&&t>=5&&t<=60?r=t:n>5&&(r=25);let a=n/r*60;return n<2&&(a+=3),Math.ceil(a)}function o(e){return e>=-90&&e<=90}function i(e){return e>=-180&&e<=180}e.s(["distanceKm",()=>r,"estimateETA",()=>a,"isValidLatitude",()=>o,"isValidLongitude",()=>i,"latLonFromPoint",()=>t,"pointFromLatLon",()=>n])},60147,78140,e=>{"use strict";var t=e.i(19063);function n(e){let t=new Date(e);t.setSeconds(0,0);let n=t.getMinutes();return t.setMinutes(n<30?0:30),t}function r(e){let t=String(e.getHours()).padStart(2,"0"),n=0===e.getMinutes()?"00":"30";return`${t}:${n}`}function a(e,t){return n("string"==typeof e?new Date(e):e).getTime()===t.getTime()}e.s(["bucketLabel",()=>r,"isWithinSameBucket",()=>a,"truncateTo30MinBucket",()=>n],78140);let o=new Map;async function i(e){var t,n,r,a,i;let l,d,u;if(0===e.destinations.length)return[];let c=process.env.GOOGLE_MAPS_API_KEY;if(!c)throw Error("Missing GOOGLE_MAPS_API_KEY environment variable");let p=Math.floor((e.departureTime??new Date).getTime()/1e3),f=(t=e.origin,n=e.destinations,r=p,l=`${t.lat.toFixed(3)},${t.lon.toFixed(3)}`,d=n.map(e=>`${e.zoneId}:${e.lat.toFixed(3)},${e.lon.toFixed(3)}`).sort().join("|"),u=Math.floor(r/60),`${l}|${d}|${u}`),m=o.get(f);if(m&&m.expiresAt>Date.now())return m.data;let h=[];for(let t of function(e,t){let n=[];for(let t=0;t<e.length;t+=25)n.push(e.slice(t,t+25));return n}(e.destinations,25)){let n=new URL("https://maps.googleapis.com/maps/api/distancematrix/json");n.searchParams.set("origins",(a=e.origin.lat,i=e.origin.lon,`${a},${i}`)),n.searchParams.set("destinations",t.map(e=>{var t,n;return t=e.lat,n=e.lon,`${t},${n}`}).join("|")),n.searchParams.set("departure_time",p.toString()),n.searchParams.set("traffic_model","best_guess"),n.searchParams.set("units","metric"),n.searchParams.set("key",c);let r=await fetch(n.toString(),{method:"GET",cache:"no-store"});if(!r.ok)throw Error(`Google Maps Distance Matrix HTTP ${r.status}`);let o=await r.json();if("OK"!==o.status)throw Error(`Google Maps Distance Matrix error: ${o.status}${o.error_message?` (${o.error_message})`:""}`);let l=o.rows?.[0];if(!l||!Array.isArray(l.elements))throw Error("Google Maps Distance Matrix returned no rows");l.elements.forEach((e,n)=>{let r=t[n];h.push({zoneId:r.zoneId,distanceMeters:s(e.distance?.value),durationSeconds:s(e.duration?.value),durationInTrafficSeconds:s(e.duration_in_traffic?.value),status:e.status??"UNKNOWN"})})}return o.set(f,{expiresAt:Date.now()+6e4,data:h}),h}function s(e){return"number"==typeof e&&Number.isFinite(e)?e:null}let l=new Map;async function d(e){var a,o,i,s;let l,{supabase:d,driverId:c,currentLoc:p,snappedZoneId:f=null,k:b=3,context:x,now:v,currentSpeedKmh:w}=e,y="string"==typeof v?new Date(v):v||new Date,R=n(y),N=R.toISOString(),S=r(R),I=(a=x,{traffic_speed_idx:"number"==typeof a?.traffic_speed_idx?g(a.traffic_speed_idx,0,1):null,route_incident:!!a?.route_incident,airport_wave:"number"==typeof a?.airport_wave?g(a.airport_wave,0,1):null,weather_flag_rain:!!a?.weather_flag_rain,event_flag:!!a?.event_flag}),E=await u(d,p),z=E.candidates;if(0===z.length)return E.totalZones>0&&0===E.zonesWithCoordinates&&console.warn("[recommendations] zones present but none have coordinates",{driverId:c,totalZones:E.totalZones}),{computed_at:y.toISOString(),context:{...I,driver_id:c,snapped_zone:f,bucket_start:N,bucket_label:S,traffic_source:"fallback"},top:[],traffic_source:"fallback"};let M=z.map(e=>e.zone.id),[T,A,k]=await Promise.all([m(d,M,R,c),h(d,M,R,c),_({driverId:c,origin:p,candidates:z,departure:y,currentSpeedKmh:w??null})]),P=function(e){if(0===e.size)return 180;let t=0,n=0;for(let r of e.values())t+=r.sum,n+=r.count;return 0===n?180:t/n}(A),D=0,F=0,C=z.map(e=>{let n=e.zone.id,r=T.get(n),a=r?r.prob:.35,o=A.get(n),i=o&&o.count>0?o.sum/o.count:P,s=k.entries.get(n),l=1e3*e.distanceKm,d=Number(((s?.distanceMeters&&s.distanceMeters>0?s.distanceMeters:l)/1e3).toFixed(2)),u=Number(((s?.durationInTrafficSeconds&&s.durationInTrafficSeconds>0?s.durationInTrafficSeconds:60*(0,t.estimateETA)(l,w))/60).toFixed(1)),c="number"==typeof s?.trafficSpeedIdx?s.trafficSpeedIdx:null;return"number"==typeof c&&(D+=c,F+=1),{zoneId:n,zoneName:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distanceKm:d,etaMin:u,successProb:a,expectedFare:i,trafficSpeedIdx:c}}),O=C.reduce((e,t)=>Math.max(e,t.expectedFare),P),K=C.map(e=>{var t,n,r,a,o,i;let s,l,d=O>0?Number((e.expectedFare/O).toFixed(3)):0,u=Math.min(e.etaMin/30,1),c=(t=e.trafficSpeedIdx,n=I,s="number"==typeof t?g(t,0,1):"number"==typeof n.traffic_speed_idx?g(n.traffic_speed_idx,0,1):null,g((null!==s?1-s:.2)+.5*!!n.route_incident+.3*!!n.weather_flag_rain,0,1)),p=g(.4*e.successProb+.3*d-.2*u-.1*c,0,1),f=(r=e,a=d,o=e.trafficSpeedIdx,i=I,l=[],r.successProb>=.65?l.push("High hit rate"):r.successProb>=.5&&l.push("Steady bookings"),a>=.7?l.push("Premium fares"):r.expectedFare>=220&&l.push("Above avg fare"),r.distanceKm<=2?l.push("Very close"):r.distanceKm<=5&&l.push("Nearby"),"number"==typeof o&&(o>=.8?l.push("Traffic flowing"):o<.5&&l.push("Heavy traffic")),i.airport_wave&&/airport/i.test(r.zoneName)&&l.push("Airport arrivals"),i.event_flag&&l.push("Event demand"),0===l.length&&l.push("Balanced demand vs travel time"),l.slice(0,3).join("; "));return{zone_id:e.zoneId,zone_name:e.zoneName,lat:e.lat,lon:e.lon,distance_km:e.distanceKm,eta_min:e.etaMin,score:Number(p.toFixed(3)),success_prob:Number(e.successProb.toFixed(3)),expected_fare_inr:Math.round(e.expectedFare),normalized_fare:d,traffic_penalty:Number(c.toFixed(2)),traffic_speed_idx:"number"==typeof e.trafficSpeedIdx?Number(e.trafficSpeedIdx.toFixed(2)):null,reason:f}});K.sort((e,t)=>t.score-e.score);let $=F>0?Number((D/F).toFixed(2)):I.traffic_speed_idx??null,U=k.source,j=K.slice(0,Math.max(1,b));0===j.length&&z.length>0&&(console.warn("[recommendations] scored list empty, falling back to nearest zones",{driverId:c,candidateCount:z.length}),o=z,i=b,s=w??null,l=Math.max(1,i),j=[...o].sort((e,t)=>e.distanceKm-t.distanceKm).slice(0,l).map(e=>{let n=Number(e.distanceKm.toFixed(2)),r=(0,t.estimateETA)(1e3*e.distanceKm,s??void 0),a=g(n/24,0,1),o="number"==typeof e.zone.weight_demand&&e.zone.weight_demand>0?g(e.zone.weight_demand,.5,2):1,i="number"==typeof e.zone.weight_airport?g(e.zone.weight_airport,0,2):0,l=g((1-a)*o+.05*i,0,1),d=g(.35*o,.2,.95);return{zone_id:e.zone.id,zone_name:e.zone.name,lat:e.zone.lat,lon:e.zone.lon,distance_km:n,eta_min:Number(r.toFixed(1)),score:Number(l.toFixed(3)),success_prob:Number(d.toFixed(3)),expected_fare_inr:180,normalized_fare:g(.5*o,0,1),traffic_penalty:.2,traffic_speed_idx:null,reason:"Nearest zones by distance (fallback)"}}),U="fallback");let q={...I,traffic_speed_idx:$,driver_id:c,snapped_zone:f,bucket_start:N,bucket_label:S,traffic_source:U};return{computed_at:y.toISOString(),context:q,top:j,traffic_source:U}}async function u(e,t){let{data:n,error:r}=await e.from("zones").select("*").limit(200);if(r||!n)return console.error("[recommendations] zone fetch failed",{error:r}),{candidates:[],totalZones:0,zonesWithCoordinates:0};let a=n.length;if(0===a)return console.warn("[recommendations] No zones found in DB when building candidates"),{candidates:[],totalZones:0,zonesWithCoordinates:0};let o=n.filter(e=>!1!==e.is_active),i=o.length>0?o:n,s=c(i,t,18),l=s.candidates,d=s.totalResolved;if(0===l.length&&d>0){let e=c(i,t,36);if(e.candidates.length>0)console.warn("[recommendations] No zones within default radius, using relaxed fallback",{totalZones:a,relaxedRadiusKm:36}),l=e.candidates,d=e.totalResolved;else{console.warn("[recommendations] No zones within relaxed radius, defaulting to all zones sorted by distance",{totalZones:a,resolvedZones:d});let e=c(i,t);l=e.candidates,d=e.totalResolved}}else 0===l.length&&0===d&&console.warn("[recommendations] Zones exist but none contain usable coordinates",{totalZones:a});return{candidates:l.slice(0,25),totalZones:a,zonesWithCoordinates:d}}function c(e,n,r){let a=[];for(let r of e){var o;let e=function(e){let t=p(e.lat),n=p(e.lon);if(null!==t&&null!==n)return{lat:t,lon:n};let r=f(e.center);if(r)return r;let a=f(e.geom);return a||null}(r);if(!e)continue;let i=(0,t.distanceKm)(n.lat,n.lon,e.lat,e.lon);a.push({zone:{...r,name:(o=r).name&&o.name.trim().length>0?o.name.trim():o.slug&&o.slug.trim().length>0?o.slug.replace(/_/g," ").trim():`Zone ${o.id}`,lat:e.lat,lon:e.lon},distanceKm:i})}return a.sort((e,t)=>e.distanceKm-t.distanceKm),{candidates:"number"==typeof r?a.filter(e=>e.distanceKm<=r):a,totalResolved:a.length}}function p(e){if("number"==typeof e&&Number.isFinite(e))return e;if("string"==typeof e){let t=Number(e);if(Number.isFinite(t))return t}return null}function f(e){if(!e)return null;if("string"==typeof e){let t=e.trim();if(!t)return null;if(t.startsWith("{")||t.startsWith("["))try{let e=JSON.parse(t);return f(e)}catch{}return function(e){let t=(e.includes(";")?e.split(";").pop().trim():e.trim()).match(/POINT\s*\(([^)]+)\)/i);if(!t)return null;let[n,r]=t[1].trim().split(/\s+/),a=Number(n),o=Number(r);return Number.isFinite(o)&&Number.isFinite(a)?{lat:o,lon:a}:null}(t)}if(Array.isArray(e.coordinates)&&e.coordinates.length>=2){let[t,n]=e.coordinates,r=p(n),a=p(t);if(null!==r&&null!==a)return{lat:r,lon:a}}let t=p(e.lat??e.latitude),n=p(e.lon??e.lng??e.longitude);return null!==t&&null!==n?{lat:t,lon:n}:null}async function m(e,t,n,r){var o,i;let s=new Map;if(0===t.length)return s;let l=new Date(n);l.setDate(l.getDate()-14);let{data:d,error:u}=await e.from("training_examples").select("zone_id,label_ride_15m,success_prob,sample_size,bucket_30m,created_at").in("zone_id",t).gte("created_at",l.toISOString());if(u||!d)return console.error("[recommendations] training fetch failed",{driverId:r,error:u}),s;for(let e of d){let t=e.zone_id;if(!a(e.bucket_30m??e.created_at??n.toISOString(),n))continue;let r=s.get(t)??{prob:0,samples:0},i="number"==typeof e.sample_size&&e.sample_size>0?e.sample_size:1,l="number"==typeof e.success_prob&&i>1?g(e.success_prob,0,1)*i:"number"==typeof(o=e).success_prob?o.success_prob:"number"==typeof o.label_ride_15m?g(o.label_ride_15m,0,1):"boolean"==typeof o.label_ride_15m?+!!o.label_ride_15m:0;r.prob+=l,r.samples+=i,s.set(t,r)}for(let[e,t]of s.entries()){let n=(i=t.prob,(i+1)/(t.samples+2));s.set(e,{prob:n,samples:t.samples})}return s}async function h(e,t,n,r){let o=new Map;if(0===t.length)return o;let i=new Date(n);i.setDate(i.getDate()-14);let{data:s,error:l}=await e.from("trips").select("pickup_zone,fare_inr,completed_at").in("pickup_zone",t).gte("completed_at",i.toISOString());if(l||!s)return console.error("[recommendations] trip fare fetch failed",{driverId:r,error:l}),o;for(let e of s){if(!e.pickup_zone)continue;let t=e.completed_at;if(!t||!a(t,n)||"number"!=typeof e.fare_inr||e.fare_inr<=0)continue;let r=o.get(e.pickup_zone)??{sum:0,count:0};r.sum+=e.fare_inr,r.count+=1,o.set(e.pickup_zone,r)}return o}async function _(e){let n=e.candidates.map(e=>e.zone.id).sort((e,t)=>e-t).join(","),r=l.get(e.driverId);if(r&&r.destKey===n){let n=1e3*(0,t.distanceKm)(e.origin.lat,e.origin.lon,r.origin.lat,r.origin.lon),a=Date.now()-r.snapshot.fetchedAt;if(n<200&&a<45e3)return{entries:new Map(r.snapshot.entries),source:"google"===r.snapshot.source?"cache":r.snapshot.source,fetchedAt:r.snapshot.fetchedAt}}let a=e.candidates.map(e=>({zoneId:e.zone.id,lat:e.zone.lat,lon:e.zone.lon}));try{let t=await i({origin:e.origin,destinations:a,departureTime:e.departure}),r=function(e){let t=new Map;for(let r of e){var n;t.set(r.zoneId,{zoneId:r.zoneId,distanceMeters:r.distanceMeters,durationSeconds:r.durationSeconds,durationInTrafficSeconds:r.durationInTrafficSeconds,trafficSpeedIdx:!(n=r).durationSeconds||!n.durationInTrafficSeconds||n.durationSeconds<=0||n.durationInTrafficSeconds<=0?null:g(n.durationSeconds/n.durationInTrafficSeconds,0,1),status:r.status})}return{entries:t,source:"google",fetchedAt:Date.now()}}(t);return l.set(e.driverId,{destKey:n,origin:e.origin,snapshot:r}),r}catch(a){console.warn("[recommendations] traffic matrix failed, using fallback",{driverId:e.driverId,error:a});let r=function(e,n){let r=new Map;for(let a of e){let e=1e3*a.distanceKm,o=60*(0,t.estimateETA)(e,n);r.set(a.zone.id,{zoneId:a.zone.id,distanceMeters:e,durationSeconds:o,durationInTrafficSeconds:o,trafficSpeedIdx:null,status:"FALLBACK"})}return{entries:r,source:"fallback",fetchedAt:Date.now()}}(e.candidates,e.currentSpeedKmh);return l.set(e.driverId,{destKey:n,origin:e.origin,snapshot:r}),r}}function g(e,t,n){return Math.max(t,Math.min(n,e))}e.s(["computeNextZonesForDriver",()=>d],60147)},14837,e=>{"use strict";var t=e.i(47909),n=e.i(74017),r=e.i(96250),a=e.i(59756),o=e.i(61916),i=e.i(14444),s=e.i(37092),l=e.i(69741),d=e.i(16795),u=e.i(87718),c=e.i(95169),p=e.i(47587),f=e.i(66012),m=e.i(70101),h=e.i(26937),_=e.i(10372),g=e.i(93695);e.i(52474);var b=e.i(5232),x=e.i(45620),v=e.i(60147),w=e.i(19063),y=e.i(89660);async function R(e){let t=new URL(e.url),{supabase:n,user:r}=await (0,y.createServerSupabaseClient)();if(!r)return(0,x.bad)("Please sign in",null,401,"UNAUTHENTICATED");let a=t.searchParams.get("lat"),o=t.searchParams.get("lon"),i=t.searchParams.get("k"),s=null!==a&&null!==o,l=Math.min(Math.max(parseInt(i??"3",10)||3,1),10),d=null,u=null,c=null,p="live",f=null;if(s){let e=Number(a),t=Number(o);if(!Number.isFinite(e)||!Number.isFinite(t))return(0,x.bad)("Invalid coordinates",{lat:a,lon:o},400,"INVALID_INPUT");if(!(0,w.isValidLatitude)(e)||!(0,w.isValidLongitude)(t))return(0,x.bad)("Coordinates out of range",{lat:e,lon:t},400,"INVALID_INPUT");d={lat:e,lon:t}}else{let{data:e,error:t,status:a}=await n.from("driver_state").select("loc,speed_kmh,snapped_zone,recommendation,updated_at").eq("driver_id",r.id).maybeSingle();if(t&&406!==a&&"PGRST116"!==t.code)return 401===a?(0,x.bad)("Please sign in",null,401,"UNAUTHENTICATED"):403===a||"42501"===t.code?(0,x.bad)("Forbidden",null,403,"FORBIDDEN"):(console.error("[next-spot] driver_state fetch failed",{driverId:r.id,error:t}),(0,x.bad)("Database error while reading driver_state",t,500,"DB_ERROR"));if(e){f=e;let t=(0,w.latLonFromPoint)(e.loc);null!==t.lat&&null!==t.lon&&(d={lat:t.lat,lon:t.lon}),c=e.speed_kmh,u=e.snapped_zone}}if(!d){let{data:e,error:t}=await n.from("pings").select("loc,speed_kmh").eq("driver_id",r.id).order("ts",{ascending:!1}).limit(1).maybeSingle();if(t&&"PGRST116"!==t.code)console.error("[next-spot] latest ping lookup failed",{driverId:r.id,error:t});else if(e?.loc){let t=(0,w.latLonFromPoint)(e.loc);null!==t.lat&&null!==t.lon&&(d={lat:t.lat,lon:t.lon},null===c&&"number"==typeof e.speed_kmh&&(c=e.speed_kmh))}}if(!d)return(0,x.ok)({error:{code:"NO_STATE",message:"No recent location found. Enable live tracking or pass lat/lon."}});let{lat:m,lon:h}=d;if(!s&&f?.recommendation){let e=new Date(f.updated_at).getTime();if(Date.now()-e<6e4)return p="cached",(0,x.ok)({computed_at:f.recommendation.computed_at??f.updated_at,source:p,traffic_source:f.recommendation.traffic_source??null,context:f.recommendation.context??null,top:f.recommendation.top??[]})}if(!u){let{data:e,error:t}=await n.rpc("nearest_zone",{p_lon:h,p_lat:m,p_max_m:3e3});t?console.error("[next-spot] nearest_zone failed",{driverId:r.id,error:t}):"number"==typeof e&&(u=e)}try{let e=await (0,v.computeNextZonesForDriver)({supabase:n,driverId:r.id,currentLoc:d,snappedZoneId:u,now:new Date,currentSpeedKmh:c??void 0,k:l});return"fallback"===e.traffic_source&&(p="fallback"),(0,x.ok)({computed_at:e.computed_at,source:p,traffic_source:e.traffic_source,context:e.context,top:e.top})}catch(e){return console.error("[next-spot] computeNextZonesForDriver failed",{userId:r.id,currentLoc:d,error:e}),(0,x.bad)("Failed to compute recommendations",null,500,"DB_ERROR")}}e.s(["GET",()=>R],11783);var N=e.i(11783);let S=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/recommendations/next-spot/route",pathname:"/api/recommendations/next-spot",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/recommendations/next-spot/route.ts",nextConfigOutput:"",userland:N}),{workAsyncStorage:I,workUnitAsyncStorage:E,serverHooks:z}=S;function M(){return(0,r.patchFetch)({workAsyncStorage:I,workUnitAsyncStorage:E})}async function T(e,t,r){S.isDev&&(0,a.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let x="/api/recommendations/next-spot/route";x=x.replace(/\/index$/,"")||"/";let v=await S.prepare(e,t,{srcPage:x,multiZoneDraftMode:!1});if(!v)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:w,params:y,nextConfig:R,parsedUrl:N,isDraftMode:I,prerenderManifest:E,routerServerContext:z,isOnDemandRevalidate:M,revalidateOnlyGenerated:T,resolvedPathname:A,clientReferenceManifest:k,serverActionsManifest:P}=v,D=(0,l.normalizeAppPath)(x),F=!!(E.dynamicRoutes[D]||E.routes[A]),C=async()=>((null==z?void 0:z.render404)?await z.render404(e,t,N,!1):t.end("This page could not be found"),null);if(F&&!I){let e=!!E.routes[A],t=E.dynamicRoutes[D];if(t&&!1===t.fallback&&!e){if(R.experimental.adapterPath)return await C();throw new g.NoFallbackError}}let O=null;!F||S.isDev||I||(O="/index"===(O=A)?"/":O);let K=!0===S.isDev||!F,$=F&&!K;P&&k&&(0,i.setReferenceManifestsSingleton)({page:x,clientReferenceManifest:k,serverActionsManifest:P,serverModuleMap:(0,s.createServerModuleMap)({serverActionsManifest:P})});let U=e.method||"GET",j=(0,o.getTracer)(),q=j.getActiveScopeSpan(),H={params:y,prerenderManifest:E,renderOpts:{experimental:{authInterrupts:!!R.experimental.authInterrupts},cacheComponents:!!R.cacheComponents,supportsDynamicResponse:K,incrementalCache:(0,a.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:R.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r)=>S.onRequestError(e,t,r,z)},sharedContext:{buildId:w}},L=new d.NodeNextRequest(e),B=new d.NodeNextResponse(t),G=u.NextRequestAdapter.fromNodeNextRequest(L,(0,u.signalFromNodeResponse)(t));try{let i=async e=>S.handle(G,H).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=j.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${U} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${U} ${x}`)}),s=!!(0,a.getRequestMeta)(e,"minimalMode"),l=async a=>{var o,l;let d=async({previousCacheEntry:n})=>{try{if(!s&&M&&T&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let o=await i(a);e.fetchMetrics=H.renderOpts.fetchMetrics;let l=H.renderOpts.pendingWaitUntil;l&&r.waitUntil&&(r.waitUntil(l),l=void 0);let d=H.renderOpts.collectedTags;if(!F)return await (0,f.sendResponse)(L,B,o,H.renderOpts.pendingWaitUntil),null;{let e=await o.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(o.headers);d&&(t[_.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==H.renderOpts.collectedRevalidate&&!(H.renderOpts.collectedRevalidate>=_.INFINITE_CACHE)&&H.renderOpts.collectedRevalidate,r=void 0===H.renderOpts.collectedExpire||H.renderOpts.collectedExpire>=_.INFINITE_CACHE?void 0:H.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:o.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await S.onRequestError(e,t,{routerKind:"App Router",routePath:x,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:M})},z),t}},u=await S.handleResponse({req:e,nextConfig:R,cacheKey:O,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:E,isRoutePPREnabled:!1,isOnDemandRevalidate:M,revalidateOnlyGenerated:T,responseGenerator:d,waitUntil:r.waitUntil,isMinimalMode:s});if(!F)return null;if((null==u||null==(o=u.value)?void 0:o.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==u||null==(l=u.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});s||t.setHeader("x-nextjs-cache",M?"REVALIDATED":u.isMiss?"MISS":u.isStale?"STALE":"HIT"),I&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let c=(0,m.fromNodeOutgoingHttpHeaders)(u.value.headers);return s&&F||c.delete(_.NEXT_CACHE_TAGS_HEADER),!u.cacheControl||t.getHeader("Cache-Control")||c.get("Cache-Control")||c.set("Cache-Control",(0,h.getCacheControlHeader)(u.cacheControl)),await (0,f.sendResponse)(L,B,new Response(u.value.body,{headers:c,status:u.value.status||200})),null};q?await l(q):await j.withPropagatedContext(e.headers,()=>j.trace(c.BaseServerSpan.handleRequest,{spanName:`${U} ${x}`,kind:o.SpanKind.SERVER,attributes:{"http.method":U,"http.target":e.url}},l))}catch(t){if(t instanceof g.NoFallbackError||await S.onRequestError(e,t,{routerKind:"App Router",routePath:D,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:$,isOnDemandRevalidate:M})}),F)throw t;return await (0,f.sendResponse)(L,B,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>M,"routeModule",()=>S,"serverHooks",()=>z,"workAsyncStorage",()=>I,"workUnitAsyncStorage",()=>E],14837)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__64c1029b._.js.map