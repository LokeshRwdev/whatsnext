(globalThis.TURBOPACK||(globalThis.TURBOPACK=[])).push(["object"==typeof document?document.currentScript:void 0,8341,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={cancelIdleCallback:function(){return i},requestIdleCallback:function(){return s}};for(var a in r)Object.defineProperty(n,a,{enumerable:!0,get:r[a]});let s="undefined"!=typeof self&&self.requestIdleCallback&&self.requestIdleCallback.bind(window)||function(e){let t=Date.now();return self.setTimeout(function(){e({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-t))}})},1)},i="undefined"!=typeof self&&self.cancelIdleCallback&&self.cancelIdleCallback.bind(window)||function(e){return clearTimeout(e)};("function"==typeof n.default||"object"==typeof n.default&&null!==n.default)&&void 0===n.default.__esModule&&(Object.defineProperty(n.default,"__esModule",{value:!0}),Object.assign(n.default,n),t.exports=n.default)},79520,(e,t,n)=>{"use strict";Object.defineProperty(n,"__esModule",{value:!0});var r={default:function(){return y},handleClientScriptLoad:function(){return x},initScriptLoader:function(){return h}};for(var a in r)Object.defineProperty(n,a,{enumerable:!0,get:r[a]});let s=e.r(55682),i=e.r(90809),o=e.r(43476),l=s._(e.r(74080)),c=i._(e.r(71645)),u=e.r(42732),d=e.r(22737),f=e.r(8341),m=new Map,p=new Set,g=e=>{let{src:t,id:n,onLoad:r=()=>{},onReady:a=null,dangerouslySetInnerHTML:s,children:i="",strategy:o="afterInteractive",onError:c,stylesheets:u}=e,f=n||t;if(f&&p.has(f))return;if(m.has(t)){p.add(f),m.get(t).then(r,c);return}let g=()=>{a&&a(),p.add(f)},x=document.createElement("script"),h=new Promise((e,t)=>{x.addEventListener("load",function(t){e(),r&&r.call(this,t),g()}),x.addEventListener("error",function(e){t(e)})}).catch(function(e){c&&c(e)});s?(x.innerHTML=s.__html||"",g()):i?(x.textContent="string"==typeof i?i:Array.isArray(i)?i.join(""):"",g()):t&&(x.src=t,m.set(t,h)),(0,d.setAttributesFromProps)(x,e),"worker"===o&&x.setAttribute("type","text/partytown"),x.setAttribute("data-nscript",o),u&&(e=>{if(l.default.preinit)return e.forEach(e=>{l.default.preinit(e,{as:"style"})});if("undefined"!=typeof window){let t=document.head;e.forEach(e=>{let n=document.createElement("link");n.type="text/css",n.rel="stylesheet",n.href=e,t.appendChild(n)})}})(u),document.body.appendChild(x)};function x(e){let{strategy:t="afterInteractive"}=e;"lazyOnload"===t?window.addEventListener("load",()=>{(0,f.requestIdleCallback)(()=>g(e))}):g(e)}function h(e){e.forEach(x),[...document.querySelectorAll('[data-nscript="beforeInteractive"]'),...document.querySelectorAll('[data-nscript="beforePageRender"]')].forEach(e=>{let t=e.id||e.getAttribute("src");p.add(t)})}function b(e){let{id:t,src:n="",onLoad:r=()=>{},onReady:a=null,strategy:s="afterInteractive",onError:i,stylesheets:d,...m}=e,{updateScripts:x,scripts:h,getIsSsr:b,appDir:y,nonce:v}=(0,c.useContext)(u.HeadManagerContext);v=m.nonce||v;let w=(0,c.useRef)(!1);(0,c.useEffect)(()=>{let e=t||n;w.current||(a&&e&&p.has(e)&&a(),w.current=!0)},[a,t,n]);let j=(0,c.useRef)(!1);if((0,c.useEffect)(()=>{if(!j.current){if("afterInteractive"===s)g(e);else"lazyOnload"===s&&("complete"===document.readyState?(0,f.requestIdleCallback)(()=>g(e)):window.addEventListener("load",()=>{(0,f.requestIdleCallback)(()=>g(e))}));j.current=!0}},[e,s]),("beforeInteractive"===s||"worker"===s)&&(x?(h[s]=(h[s]||[]).concat([{id:t,src:n,onLoad:r,onReady:a,onError:i,...m,nonce:v}]),x(h)):b&&b()?p.add(t||n):b&&!b()&&g({...e,nonce:v})),y){if(d&&d.forEach(e=>{l.default.preinit(e,{as:"style"})}),"beforeInteractive"===s)if(!n)return m.dangerouslySetInnerHTML&&(m.children=m.dangerouslySetInnerHTML.__html,delete m.dangerouslySetInnerHTML),(0,o.jsx)("script",{nonce:v,dangerouslySetInnerHTML:{__html:`(self.__next_s=self.__next_s||[]).push(${JSON.stringify([0,{...m,id:t}])})`}});else return l.default.preload(n,m.integrity?{as:"script",integrity:m.integrity,nonce:v,crossOrigin:m.crossOrigin}:{as:"script",nonce:v,crossOrigin:m.crossOrigin}),(0,o.jsx)("script",{nonce:v,dangerouslySetInnerHTML:{__html:`(self.__next_s=self.__next_s||[]).push(${JSON.stringify([n,{...m,id:t}])})`}});"afterInteractive"===s&&n&&l.default.preload(n,m.integrity?{as:"script",integrity:m.integrity,nonce:v,crossOrigin:m.crossOrigin}:{as:"script",nonce:v,crossOrigin:m.crossOrigin})}return null}Object.defineProperty(b,"__nextScript",{value:!0});let y=b;("function"==typeof n.default||"object"==typeof n.default&&null!==n.default)&&void 0===n.default.__esModule&&(Object.defineProperty(n.default,"__esModule",{value:!0}),Object.assign(n.default,n),t.exports=n.default)},3303,(e,t,n)=>{t.exports=e.r(79520)},54949,e=>{"use strict";let t,n,r,a;var s=e.i(43476),i=e.i(62786),o=e.i(47163);function l({trackingOn:e,permissionStatus:t,toggleTracking:n,error:r}){let a=function(e,t){if(t)return t;switch(e){case"granted":return"Foreground only";case"denied":return"Permission denied";case"prompt":return"Requires GPS access";case"unsupported":return"GPS unsupported";default:return e||""}}(t,r);return(0,s.jsxs)("button",{type:"button",onClick:n,className:(0,o.cn)("flex items-center gap-3 rounded-2xl border px-4 py-3 shadow-sm transition hover:border-primary",e?"bg-emerald-600 text-white":"bg-muted text-foreground"),"aria-pressed":e,children:[(0,s.jsx)("div",{className:"relative inline-flex h-5 w-10 items-center rounded-full bg-white/30 p-0.5",children:(0,s.jsx)("span",{className:(0,o.cn)("inline-block h-4 w-4 rounded-full bg-white transition",e?"translate-x-5":"translate-x-0")})}),(0,s.jsxs)("div",{className:"text-left",children:[(0,s.jsx)("p",{className:"text-sm font-semibold leading-tight",children:"Live Suggestions"}),(0,s.jsxs)("p",{className:"text-xs text-muted-foreground/90",children:[e?"Tracking enabled":"Tap to start"," | ",a]})]})]})}var c=e.i(71645);function u({trackingOn:e,lastPingAt:t,permissionStatus:n}){let[r,a]=(0,c.useState)("--");(0,c.useEffect)(()=>{if(!t)return void a("No GPS yet");let e=()=>{let e=Math.floor((Date.now()-Date.parse(t))/1e3);e<5?a("Just now"):a(`${e}s ago`)};e();let n=setInterval(e,5e3);return()=>clearInterval(n)},[t]);let i="Paused",l="bg-muted text-foreground";e&&t&&Date.now()-Date.parse(t)<15e3?(i="Live | Updating",l="bg-emerald-600 text-white"):e?"denied"===n?(i="No GPS",l="bg-amber-500 text-white"):(i="Waiting",l="bg-muted text-foreground"):i="Paused";let u=l.includes("text-white")?"text-white/80":"text-muted-foreground";return(0,s.jsxs)("div",{className:(0,o.cn)("inline-flex flex-col rounded-2xl px-4 py-2 text-xs font-medium",l),children:[(0,s.jsx)("span",{className:"text-sm font-semibold leading-none",children:i}),(0,s.jsxs)("span",{className:(0,o.cn)("text-[11px] leading-tight",u),children:["Last update: ",r]})]})}var d=e.i(44215);let f=(0,e.i(6344).create)(e=>({trackingOn:!1,permissionStatus:"prompt",lastFix:null,lastPingAt:null,lastRecommendation:null,error:null,isDriving:!1,autoStartPending:!0,setTrackingOn:t=>e({trackingOn:t}),setPermissionStatus:t=>e({permissionStatus:t}),setLastFix:t=>e({lastFix:t}),setLastPingAt:t=>e({lastPingAt:t}),setRecommendation:t=>e({lastRecommendation:t}),setError:t=>e({error:t}),setIsDriving:t=>e(()=>({isDriving:t,autoStartPending:!t})),setAutoStartPending:t=>e({autoStartPending:t})}));var m=e.i(70065),p=e.i(67881);let g=(0,e.i(75254).default)("arrow-up-right",[["path",{d:"M7 7h10v10",key:"1tivn9"}],["path",{d:"M7 17 17 7",key:"1vkiza"}]]);var x=e.i(46897),h=e.i(16715),b=e.i(77241),y=e.i(55545),v=e.i(55024),w=e.i(99151),j=e.i(45110),S=e.i(81092);function _(e,t){let n=(0,S.toDate)(e)-(0,S.toDate)(t);return n<0?-1:n>0?1:n}var N=e.i(34662);function I({trackingOn:e,seedRecommendation:t}){var n,r;let{data:a}=function(e=0){let[t,n]=(0,c.useState)(null),[r,a]=(0,c.useState)(!0),[s,i]=(0,c.useState)(null),o=(0,c.useCallback)(async()=>{let{data:e,error:t}=await (0,d.fetchDriverState)();t?i(t.message):(i(null),n(e)),a(!1)},[]);return(0,c.useEffect)(()=>{if(o(),e>0){let t=setInterval(o,e);return()=>clearInterval(t)}},[o,e]),{data:t,loading:r,error:s,refresh:o}}(),[i,o]=(0,c.useState)(t??null),[l,u]=(0,c.useState)(!t),[g,x]=(0,c.useState)(null),I=f(e=>e.setRecommendation),D=f(e=>e.lastFix),E=(0,c.useRef)(D);(0,c.useEffect)(()=>{E.current=D},[D]);let P=(0,c.useCallback)(e=>{o(e),I(e)},[I]),C=(0,c.useCallback)(()=>{if(a?.recommendation){let e=a.recommendation;if(Date.now()-Date.parse(e.computed_at)<45e3)return P(e),x(null),u(!1),!0}return!1},[a,P]),O=(0,c.useCallback)(async()=>{u(!0);let e={k:3},t=E.current;t&&(e.lat=t.lat,e.lon=t.lon);let{data:n,error:r}=await (0,d.fetchRecommendations)(e);r?"NO_STATE"===r.code?x("We couldn't get your current location. Enable live tracking or share location to see zone recommendations."):x(r.message):(x(null),P(n)),u(!1)},[P]);(0,c.useEffect)(()=>{t||C()||O()},[t,C,O]),(0,c.useEffect)(()=>{C()},[a,C]),(0,c.useEffect)(()=>{t&&(!i||t.computed_at!==i.computed_at)&&P(t)},[t,i,P]),(0,c.useEffect)(()=>{if(!e)return;let t=setInterval(()=>O(),15e3);return()=>clearInterval(t)},[e,O]);let L=!l&&!g&&(!i||!i.top||0===i.top.length),T=e&&!D,B=i?.computed_at?(n=new Date(i.computed_at),r={addSuffix:!0},function(e,t,n){var r;let a,s=(0,v.getDefaultOptions)(),i=n?.locale??s.locale??y.defaultLocale,o=_(e,t);if(isNaN(o))throw RangeError("Invalid time value");let l=Object.assign({},n,{addSuffix:n?.addSuffix,comparison:o}),[c,u]=(0,j.normalizeDates)(n?.in,...o>0?[t,e]:[e,t]),d=(r=void 0,e=>{let t=(r?Math[r]:Math.trunc)(e);return 0===t?0:t})(((0,S.toDate)(u)-(0,S.toDate)(c))/1e3),f=Math.round((d-((0,w.getTimezoneOffsetInMilliseconds)(u)-(0,w.getTimezoneOffsetInMilliseconds)(c))/1e3)/60);if(f<2)if(n?.includeSeconds)if(d<5)return i.formatDistance("lessThanXSeconds",5,l);else if(d<10)return i.formatDistance("lessThanXSeconds",10,l);else if(d<20)return i.formatDistance("lessThanXSeconds",20,l);else if(d<40)return i.formatDistance("halfAMinute",0,l);else if(d<60)return i.formatDistance("lessThanXMinutes",1,l);else return i.formatDistance("xMinutes",1,l);else if(0===f)return i.formatDistance("lessThanXMinutes",1,l);else return i.formatDistance("xMinutes",f,l);if(f<45)return i.formatDistance("xMinutes",f,l);if(f<90)return i.formatDistance("aboutXHours",1,l);if(f<N.minutesInDay){let e=Math.round(f/60);return i.formatDistance("aboutXHours",e,l)}if(f<2520)return i.formatDistance("xDays",1,l);else if(f<N.minutesInMonth){let e=Math.round(f/N.minutesInDay);return i.formatDistance("xDays",e,l)}else if(f<2*N.minutesInMonth)return a=Math.round(f/N.minutesInMonth),i.formatDistance("aboutXMonths",a,l);if((a=function(e,t,n){var r,a;let s,i,o,l,[c,u,d]=(0,j.normalizeDates)(void 0,e,e,t),f=_(u,d),m=Math.abs(function(e,t,n){let[r,a]=(0,j.normalizeDates)(void 0,e,t);return 12*(r.getFullYear()-a.getFullYear())+(r.getMonth()-a.getMonth())}(u,d));if(m<1)return 0;1===u.getMonth()&&u.getDate()>27&&u.setDate(30),u.setMonth(u.getMonth()-f*m);let p=_(u,d)===-f;+(s=(0,S.toDate)(c,void 0),r=void 0,(i=(0,S.toDate)(s,r?.in)).setHours(23,59,59,999),i)==+(a=void 0,l=(o=(0,S.toDate)(s,a?.in)).getMonth(),o.setFullYear(o.getFullYear(),l+1,0),o.setHours(23,59,59,999),o)&&1===m&&1===_(c,d)&&(p=!1);let g=f*(m-p);return 0===g?0:g}(u,c))<12){let e=Math.round(f/N.minutesInMonth);return i.formatDistance("xMonths",e,l)}{let e=a%12,t=Math.trunc(a/12);return e<3?i.formatDistance("aboutXYears",t,l):e<9?i.formatDistance("overXYears",t,l):i.formatDistance("almostXYears",t+1,l)}}(n,(0,b.constructFrom)(n,Date.now()),r)):null,R=i?.context,A="number"==typeof R?.traffic_speed_idx?R.traffic_speed_idx:null,z=i?.traffic_source??null,F=(0,c.useMemo)(()=>{var e;return[B?`Refreshed ${B}`:"Refreshed just now","google"===(e=z)?"Google live traffic":"cache"===e?"Cached traffic snapshot":"fallback"===e?"Estimated traffic":null,null!==A?`Avg traffic ${M(A)}`:null].filter(Boolean).join(" | ")},[B,z,A]);return(0,s.jsxs)(m.Card,{className:"shadow-sm",children:[(0,s.jsxs)(m.CardHeader,{className:"flex flex-row items-center justify-between space-y-0",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)(m.CardTitle,{className:"text-base font-semibold",children:"Next best zones"}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:F})]}),(0,s.jsx)(p.Button,{variant:"ghost",size:"icon","aria-label":"Refresh",onClick:O,children:(0,s.jsx)(h.RefreshCw,{className:"h-4 w-4"})})]}),(0,s.jsxs)(m.CardContent,{className:"space-y-4",children:[l&&(0,s.jsx)("div",{className:"space-y-3",children:[0,1,2].map(e=>(0,s.jsxs)("div",{className:"rounded-xl border p-3",children:[(0,s.jsx)("div",{className:"h-4 w-1/2 animate-pulse rounded bg-muted"}),(0,s.jsx)("div",{className:"mt-2 h-3 w-1/3 animate-pulse rounded bg-muted"})]},e))}),!l&&g&&(0,s.jsxs)("div",{className:"rounded-xl border border-red-200 bg-red-50 p-4 text-sm text-red-700",children:[g,(0,s.jsx)(p.Button,{size:"sm",variant:"secondary",className:"mt-3",onClick:O,children:"Try again"})]}),L&&(0,s.jsx)("div",{className:"rounded-xl border border-dashed p-4 text-sm text-muted-foreground",children:T?"Waiting for GPS fix...":"We'll start suggesting zones once we see your location."}),!l&&!g&&i?.top?.length?(0,s.jsx)("div",{className:"space-y-3",children:i.top.map(e=>(0,s.jsx)(k,{zone:e},e.zone_id))}):null]})]})}function k({zone:e}){let t="number"==typeof e.score,n="number"==typeof e.eta_min,r="number"==typeof e.distance_km?`${e.distance_km.toFixed(1)} km`:"Distance n/a",a=n?`${e.eta_min} min`:"ETA n/a",i=t?e.score.toFixed(2):"Score n/a",o=t?`${Math.min(100,Math.round(100*e.score))}%`:"0%",l="number"==typeof e.traffic_speed_idx?M(e.traffic_speed_idx):null;return(0,s.jsxs)("div",{className:"rounded-2xl border p-4",children:[(0,s.jsxs)("div",{className:"flex items-start justify-between gap-3",children:[(0,s.jsxs)("div",{children:[(0,s.jsxs)("div",{className:"flex items-center gap-2 text-base font-semibold",children:[(0,s.jsx)(x.MapPin,{className:"h-4 w-4 text-primary"}),e.zone_name]}),(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:[r," | ",a," | ",i]}),l&&(0,s.jsxs)("p",{className:"text-xs text-muted-foreground",children:["Traffic: ",l]})]}),(0,s.jsxs)(p.Button,{size:"sm",variant:"secondary",onClick:()=>{let t=encodeURIComponent(`${e.zone_name} Patna`);window.open(`https://www.google.com/maps/search/?api=1&query=${t}`,"_blank")},children:["Navigate",(0,s.jsx)(g,{className:"ml-1 h-3 w-3"})]})]}),(0,s.jsx)("div",{className:"mt-3 text-sm text-muted-foreground",children:e.reason}),(0,s.jsx)("div",{className:"mt-3 h-1.5 rounded-full bg-muted",children:(0,s.jsx)("div",{className:"h-full rounded-full bg-emerald-500",style:{width:o}})})]})}function M(e){return e>=.85?"Smooth":e>=.65?"Moderate":e>=.4?"Busy":"Heavy"}e.i(47167);var D=e.i(3303);let E="AIzaSyBmrEg7SfI6pHlfcoAhOBG5GbHXxFz9pqk";function P({currentLocation:e,recommendedZones:t}){let n=(0,c.useRef)(null),[r,a]=(0,c.useState)(!1),[i,o]=(0,c.useState)(null),[l,u]=(0,c.useState)(null),[d,f]=(0,c.useState)(null),[g,x]=(0,c.useState)(!1),h=(0,c.useRef)([]),b=(0,c.useRef)(null),y=(0,c.useMemo)(()=>(t??[]).filter(e=>"number"==typeof e.lat&&"number"==typeof e.lon),[t]),v=(0,c.useCallback)(()=>{navigator.geolocation?(x(!0),null!==b.current&&navigator.geolocation.clearWatch(b.current),b.current=navigator.geolocation.watchPosition(e=>{let t="number"==typeof e.coords.accuracy?e.coords.accuracy:null;if(!Number.isFinite(t)||null===t||t>200){f("Waiting for a precise GPS fix (move outdoors if possible)."),x(!1);return}u({lat:e.coords.latitude,lon:e.coords.longitude,accuracy:t}),f(null),x(!1)},e=>{x(!1),f(function(e){switch(e.code){case e.PERMISSION_DENIED:return"Location permission denied. Please enable location access in your browser settings.";case e.POSITION_UNAVAILABLE:return"GPS signal unavailable. Move outdoors for a clearer sky view.";case e.TIMEOUT:return"Timed out while fetching your location. Try again from an open area.";default:return"Unable to retrieve your location"}}(e))},{enableHighAccuracy:!0,maximumAge:0,timeout:15e3})):f("Geolocation is not supported by your browser")},[]);return(0,c.useEffect)(()=>(v(),()=>{null!==b.current&&navigator.geolocation&&navigator.geolocation.clearWatch(b.current)}),[v]),(0,c.useEffect)(()=>{if(!E||!r||i||!n.current)return;let t=window.google;if(!t?.maps)return;let a=e||l,s=a?{lat:a.lat,lng:a.lon}:{lat:25.617,lng:85.141},c=new t.maps.Map(n.current,{center:s,zoom:13,disableDefaultUI:!0}),u=new t.maps.TrafficLayer;return u.setMap(c),o(c),()=>{u.setMap(null)}},[r,i,e,l]),(0,c.useEffect)(()=>{if(!i)return;let t=window.google;if(!t?.maps)return;h.current.forEach(e=>e.setMap(null)),h.current=[];let n=new t.maps.LatLngBounds,r=!1,a=e||l;if(a){let e=new t.maps.Marker({map:i,position:{lat:a.lat,lng:a.lon},title:"You",icon:{path:t.maps.SymbolPath.CIRCLE,scale:7,fillColor:"#10b981",fillOpacity:1,strokeColor:"#ffffff",strokeWeight:2}});h.current.push(e),n.extend(e.getPosition()),r=!0,i.panTo(e.getPosition())}y.forEach((e,a)=>{let s=new t.maps.Marker({map:i,position:{lat:e.lat,lng:e.lon},label:`${a+1}`,title:e.zone_name});h.current.push(s),n.extend(s.getPosition()),r=!0}),r&&i.fitBounds(n,48)},[i,y,e,l]),(0,s.jsxs)(m.Card,{className:"shadow-sm",children:[(0,s.jsxs)(m.CardHeader,{className:"space-y-1",children:[(0,s.jsx)(m.CardTitle,{className:"text-base font-semibold",children:"Live map preview"}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Browser geolocation + Google Maps traffic overlay (visual only)"})]}),(0,s.jsxs)(m.CardContent,{className:"space-y-3",children:[d&&(0,s.jsx)("div",{className:"rounded-lg bg-amber-50 px-3 py-2 text-xs text-amber-800",children:d}),(0,s.jsx)("div",{className:"flex justify-end",children:(0,s.jsx)(p.Button,{variant:"outline",size:"sm",onClick:v,disabled:g,children:g?"Requesting location...":"Use my current location"})}),(0,s.jsx)("div",{className:"h-64 w-full overflow-hidden rounded-2xl border",ref:n}),y.length>0?(0,s.jsx)("div",{className:"text-xs text-muted-foreground",children:y.slice(0,3).map((e,t)=>(0,s.jsxs)("div",{children:["#",t+1," ",e.zone_name,": ",e.eta_min.toFixed(1)," min,"," ",e.distance_km.toFixed(1)," km"]},e.zone_id))}):(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Start tracking to see nearby recommended zones on the map."})]}),(0,s.jsx)(D.default,{id:"google-maps-js",src:`https://maps.googleapis.com/maps/api/js?key=${E}&libraries=visualization`,strategy:"lazyOnload",onLoad:()=>a(!0)})]})}var C=e.i(46696);let O=[{type:"booking_received",label:"Got a Ride",variant:"default"},{type:"ride_started",label:"Ride Started",variant:"secondary"},{type:"ride_completed",label:"Ride Completed",variant:"outline"},{type:"booking_cancelled",label:"Booking Cancelled",variant:"ghost"}];function L({lastFix:e}){let[t,n]=(0,c.useState)("ola"),[r,a]=(0,c.useState)(null),[i,o]=(0,c.useState)(!1),l=f(e=>e.setIsDriving),u=(0,c.useMemo)(()=>e?`${e.lat.toFixed(4)}, ${e.lon.toFixed(4)}`:"No live GPS",[e]),m=async()=>{if(!r)return;o(!0);let n={event_type:r.type,platform:t};e&&("ride_completed"===r.type?(n.drop_lat=e.lat,n.drop_lon=e.lon):(n.pickup_lat=e.lat,n.pickup_lon=e.lon));let{error:s}=await (0,d.postRideEvent)(n);o(!1),a(null),s?C.toast.error(s.message):(C.toast.success(`${function(e){switch(e){case"booking_received":return"Booking";case"ride_started":return"Ride start";case"ride_completed":return"Ride completion";case"booking_cancelled":return"Cancellation";default:return"Event"}}(r.type)} logged`),function(e,t){switch(e){case"ride_started":t(!0);return;case"ride_completed":case"booking_cancelled":case"booking_received":t(!1);return;default:return}}(r.type,l))};return(0,s.jsxs)("div",{className:"space-y-4",children:[(0,s.jsxs)("div",{className:"flex items-center justify-between rounded-2xl border bg-white/60 px-4 py-3 shadow-sm",children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("p",{className:"text-xs uppercase text-muted-foreground",children:"Current platform"}),(0,s.jsx)("div",{className:"mt-1 inline-flex gap-2 rounded-full bg-muted p-1",children:["ola","uber"].map(e=>(0,s.jsx)("button",{type:"button",onClick:()=>n(e),className:`rounded-full px-3 py-1 text-xs font-semibold capitalize transition ${t===e?"bg-white text-foreground shadow":"text-muted-foreground"}`,children:e},e))})]}),(0,s.jsxs)("div",{className:"text-right text-xs text-muted-foreground",children:[(0,s.jsx)("p",{children:"Last fix"}),(0,s.jsx)("p",{className:"font-semibold text-foreground",children:u})]})]}),(0,s.jsx)("div",{className:"grid grid-cols-2 gap-3",children:O.map(e=>(0,s.jsx)(p.Button,{className:"booking_received"===e.type?"col-span-2 h-14 text-base":"h-12",variant:e.variant,onClick:()=>a(e),children:e.label},e.type))}),(0,s.jsx)("p",{className:"text-xs text-muted-foreground",children:"Your live location is only used to suggest better zones and calculate your performance. It stays private to you."}),r&&(0,s.jsx)("div",{className:"fixed inset-0 z-50 flex items-center justify-center bg-black/40 px-4 pb-8",children:(0,s.jsxs)("div",{className:"w-full max-w-md rounded-3xl bg-bg p-5 shadow-2xl",children:[(0,s.jsx)("p",{className:"text-sm font-semibold text-muted-foreground",children:"Confirm action"}),(0,s.jsx)("h3",{className:"text-2xl font-semibold",children:r.label}),(0,s.jsxs)("p",{className:"mt-2 text-sm text-muted-foreground",children:["Platform: ",(0,s.jsx)("span",{className:"font-medium capitalize",children:t})]}),(0,s.jsxs)("p",{className:"text-sm text-muted-foreground",children:["Location: ",(0,s.jsx)("span",{className:"font-medium",children:u})]}),(0,s.jsxs)("div",{className:"mt-5 flex gap-3",children:[(0,s.jsx)(p.Button,{variant:"outline",className:"flex-1",onClick:()=>a(null),children:"Cancel"}),(0,s.jsx)(p.Button,{className:"flex-1",onClick:m,disabled:i,children:i?"Saving.":"Confirm"})]})]})})]})}function T({accuracy:e,trackingOn:t}){let n=t?"GPS: waiting for fix":"GPS: paused",r="bg-muted text-muted-foreground";if("number"==typeof e&&Number.isFinite(e)){let t=Math.max(0,Math.round(e));t<=30?(n=`GPS: ${t}m accuracy`,r="bg-emerald-100 text-emerald-900"):t<=100?(n=`GPS: ${t}m (ok)`,r="bg-amber-100 text-amber-900"):(n=`GPS: ${t}m (weak) - move outdoors`,r="bg-rose-100 text-rose-900")}else t&&(r="bg-muted text-muted-foreground");return(0,s.jsx)("div",{className:(0,o.cn)("inline-flex rounded-full px-3 py-1 text-xs font-semibold",r),children:n})}let B=(e,t)=>t.some(t=>e instanceof t),R=new WeakMap,A=new WeakMap,z=new WeakMap,F={get(e,t,n){if(e instanceof IDBTransaction){if("done"===t)return R.get(e);if("store"===t)return n.objectStoreNames[1]?void 0:n.objectStore(n.objectStoreNames[0])}return G(e[t])},set:(e,t,n)=>(e[t]=n,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function G(e){if(e instanceof IDBRequest){let t;return t=new Promise((t,n)=>{let r=()=>{e.removeEventListener("success",a),e.removeEventListener("error",s)},a=()=>{t(G(e.result)),r()},s=()=>{n(e.error),r()};e.addEventListener("success",a),e.addEventListener("error",s)}),z.set(t,e),t}if(A.has(e))return A.get(e);let r=function(e){if("function"==typeof e)return(n||(n=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(...t){return e.apply(q(this),t),G(this.request)}:function(...t){return G(e.apply(q(this),t))};return(e instanceof IDBTransaction&&function(e){if(R.has(e))return;let t=new Promise((t,n)=>{let r=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",s),e.removeEventListener("abort",s)},a=()=>{t(),r()},s=()=>{n(e.error||new DOMException("AbortError","AbortError")),r()};e.addEventListener("complete",a),e.addEventListener("error",s),e.addEventListener("abort",s)});R.set(e,t)}(e),B(e,t||(t=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])))?new Proxy(e,F):e}(e);return r!==e&&(A.set(e,r),z.set(r,e)),r}let q=e=>z.get(e),$=["get","getKey","getAll","getAllKeys","count"],H=["put","add","delete","clear"],W=new Map;function U(e,t){if(!(e instanceof IDBDatabase&&!(t in e)&&"string"==typeof t))return;if(W.get(t))return W.get(t);let n=t.replace(/FromIndex$/,""),r=t!==n,a=H.includes(n);if(!(n in(r?IDBIndex:IDBObjectStore).prototype)||!(a||$.includes(n)))return;let s=async function(e,...t){let s=this.transaction(e,a?"readwrite":"readonly"),i=s.store;return r&&(i=i.index(t.shift())),(await Promise.all([i[n](...t),a&&s.done]))[0]};return W.set(t,s),s}F={...r=F,get:(e,t,n)=>U(e,t)||r.get(e,t,n),has:(e,t)=>!!U(e,t)||r.has(e,t)};let X=["continue","continuePrimaryKey","advance"],Y={},V=new WeakMap,K=new WeakMap,J={get(e,t){if(!X.includes(t))return e[t];let n=Y[t];return n||(n=Y[t]=function(...e){V.set(this,K.get(this)[t](...e))}),n}};async function*Z(...e){let t=this;if(t instanceof IDBCursor||(t=await t.openCursor(...e)),!t)return;let n=new Proxy(t,J);for(K.set(n,t),z.set(n,q(t));t;)yield n,t=await (V.get(n)||t.continue()),V.delete(n)}function Q(e,t){return t===Symbol.asyncIterator&&B(e,[IDBIndex,IDBObjectStore,IDBCursor])||"iterate"===t&&B(e,[IDBIndex,IDBObjectStore])}F={...a=F,get:(e,t,n)=>Q(e,t)?Z:a.get(e,t,n),has:(e,t)=>Q(e,t)||a.has(e,t)};let ee="events";async function et(){return function(e,t,{blocked:n,upgrade:r,blocking:a,terminated:s}={}){let i=indexedDB.open(e,1),o=G(i);return r&&i.addEventListener("upgradeneeded",e=>{r(G(i.result),e.oldVersion,e.newVersion,G(i.transaction),e)}),n&&i.addEventListener("blocked",e=>n(e.oldVersion,e.newVersion,e)),o.then(e=>{s&&e.addEventListener("close",()=>s()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),o}("ride-db",0,{upgrade(e){e.createObjectStore(ee,{keyPath:"id",autoIncrement:!0})}})}async function en(e){(await et()).add(ee,{...e,created_at:Date.now()})}let er=(0,e.i(20755).createBrowserSupabaseClient)();var ea=e.i(1559);function es(){let e,t,n,r,a,o,m,p,g,x,h,b,y,v,w,j,S,_,N,k,M,D,E,O=(e=f(e=>e.trackingOn),t=f(e=>e.permissionStatus),n=f(e=>e.lastFix),r=f(e=>e.lastPingAt),a=f(e=>e.lastRecommendation),o=f(e=>e.error),m=f(e=>e.autoStartPending),p=f(e=>e.setTrackingOn),g=f(e=>e.setPermissionStatus),x=f(e=>e.setLastFix),h=f(e=>e.setLastPingAt),b=f(e=>e.setRecommendation),y=f(e=>e.setError),v=f(e=>e.setAutoStartPending),w=(0,c.useRef)(null),j=(0,c.useRef)(0),S=(0,c.useRef)(null),_=(0,c.useCallback)(async()=>{try{if(navigator.permissions?.query){let e=await navigator.permissions.query({name:"geolocation"});g(e.state),e.onchange=()=>g(e.state)}else g("unsupported")}catch(e){console.warn("permission query failed",e),g("unsupported")}},[g]),(0,c.useEffect)(()=>{_()},[_]),N=(0,c.useCallback)(()=>{null!==w.current&&"undefined"!=typeof navigator&&navigator.geolocation&&(navigator.geolocation.clearWatch(w.current),w.current=null)},[]),k=(0,c.useCallback)((e,t)=>{h(t),e&&b(e),y(null)},[h,b,y]),M=(0,c.useCallback)(async e=>{var t,n;let r,a,s,i,o,l="number"==typeof e.coords.accuracy?e.coords.accuracy:null;if(!Number.isFinite(l)||null===l||l>200)return void y("GPS accuracy is weak (>200m). Move outdoors for a clear fix.");let c="number"==typeof e.coords.speed&&Number.isFinite(e.coords.speed)?3.6*e.coords.speed:null;x({lat:e.coords.latitude,lon:e.coords.longitude,accuracy:l,speed:c,timestamp:e.timestamp}),y(null);let u=Date.now(),f=S.current,m=!1;if(f&&"number"==typeof f.coords.accuracy&&Number.isFinite(f.coords.accuracy)&&(m=l<=.5*f.coords.accuracy),f&&30>(t=f.coords,n=e.coords,r=t.latitude*Math.PI/180,s=(a=n.latitude*Math.PI/180)-r,2*Math.atan2(Math.sqrt(o=Math.sin(s/2)*Math.sin(s/2)+Math.cos(r)*Math.cos(a)*Math.sin((i=(n.longitude-t.longitude)*Math.PI/180)/2)*Math.sin(i/2)),Math.sqrt(1-o))*6371e3)&&u-j.current<5e3&&!m)return;S.current=e,j.current=u;let p={lat:e.coords.latitude,lon:e.coords.longitude,ts:new Date(e.timestamp).toISOString(),accuracy_m:l,speed_kmh:c??void 0},{data:g,error:h}=await (0,d.postPing)(p);if(h){y(h.message),await en(p),C.toast.error("Could not sync live location. We'll retry soon.");return}k(g?.recommendation??null,p.ts??new Date().toISOString())},[x,k,y]),D=(0,c.useCallback)(async()=>{try{let{state:e}=await navigator.permissions.query({name:"geolocation"});if(g(e),"denied"===e)return C.toast.error("Location permission denied. Enable it in browser settings."),!1;return"prompt"===e&&(await new Promise((e,t)=>{navigator.geolocation.getCurrentPosition(e,t,{enableHighAccuracy:!0,timeout:15e3,maximumAge:0})}),g("granted")),!0}catch(e){return console.error("permission request failed",e),g("unsupported"),!1}},[g]),E=(0,c.useCallback)(async()=>{if(e){N(),p(!1);return}await D()?p(!0):y("Location permission required for live tracking")},[e,D,N,p,y]),(0,c.useEffect)(()=>{!e&&m&&(E(),v(!1))},[e,m,E,v]),(0,c.useEffect)(()=>{if(!e)return void N();if("undefined"==typeof navigator||!navigator.geolocation){y("Geolocation is not supported in this browser."),C.toast.error("Geolocation is not available on this device."),p(!1);return}return w.current=navigator.geolocation.watchPosition(e=>M(e),e=>{console.error("watchPosition error",e);let t=function(e){switch(e.code){case e.PERMISSION_DENIED:return"Location permission denied. Enable it in your browser settings.";case e.POSITION_UNAVAILABLE:return"GPS signal unavailable. Move outdoors for a clear view of the sky.";case e.TIMEOUT:return"Timed out while waiting for GPS. Try again from an open area.";default:return e.message||"Unable to determine your location."}}(e);y(t),e.code===e.PERMISSION_DENIED?(p(!1),g("denied"),C.toast.error("Permission denied. Please re-enable location access.")):C.toast.error(t)},{enableHighAccuracy:!0,maximumAge:0,timeout:15e3}),()=>N()},[e,M,N,y,p,g]),(0,c.useEffect)(()=>{function e(){y(null)}return window.addEventListener("online",e),()=>window.removeEventListener("online",e)},[y]),{trackingOn:e,permissionStatus:t,lastFix:n,lastPingAt:r,lastRecommendation:a,error:o,toggleTracking:E}),B=function(){let[e,t]=(0,c.useState)(null);return(0,c.useEffect)(()=>{let e=!0;return async function(){let{data:{user:n}}=await er.auth.getUser();if(!n)return;let{data:r}=await er.from("profiles").select("id,full_name").eq("id",n.id).maybeSingle();e&&t({id:n.id,full_name:r?.full_name??n.user_metadata?.full_name??null})}(),()=>{e=!1}},[]),e}(),{stats:R}=(0,ea.useTodayStats)(),A=B?.full_name?`Hi, ${B.full_name.split(" ")[0]}`:"Hi driver",z=`Today | ${R.totalTrips} trips | ?${R.totalEarnings.toFixed(0)}`;return(0,s.jsx)(i.DriverShell,{title:A,subtitle:z,children:(0,s.jsxs)("div",{className:"space-y-6",children:[(0,s.jsxs)("div",{className:"flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between",children:[(0,s.jsx)(l,{trackingOn:O.trackingOn,permissionStatus:O.permissionStatus,toggleTracking:O.toggleTracking,error:O.error}),(0,s.jsxs)("div",{className:"flex flex-col items-start gap-2 sm:items-end",children:[(0,s.jsx)(u,{trackingOn:O.trackingOn,lastPingAt:O.lastPingAt,permissionStatus:O.permissionStatus}),(0,s.jsx)(T,{trackingOn:O.trackingOn,accuracy:O.lastFix?.accuracy??null})]})]}),(0,s.jsx)(I,{trackingOn:O.trackingOn,seedRecommendation:O.lastRecommendation}),(0,s.jsx)(P,{currentLocation:O.lastFix,recommendedZones:O.lastRecommendation?.top??null}),(0,s.jsxs)("section",{className:"space-y-3",children:[(0,s.jsx)("h2",{className:"text-lg font-semibold",children:"Ride actions"}),(0,s.jsx)(L,{lastFix:O.lastFix})]})]})})}e.s(["default",()=>es],54949)}]);